<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>í˜„í™© v14.0</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@kfonts/nexon-lv2-gothic/index.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:'ë„¥ìŠ¨Lv2ê³ ë”•','NEXON Lv2 Gothic',sans-serif}
body{font-family:'ë„¥ìŠ¨Lv2ê³ ë”•','NEXON Lv2 Gothic',sans-serif;background:#000;color:#e2e8f0}
.hd{background:linear-gradient(135deg,#0a0a0a,#1a1a1a);padding:16px 20px;border-bottom:2px solid #3b82f6}
.hd h1{font-size:20px;color:#ffffff}.hd .ver{font-size:11px;color:#94a3b8;font-weight:400;margin-left:6px}.hd p{font-size:10px;color:#94a3b8;margin-top:4px}
.file-bar{background:#000;padding:10px 20px;border-bottom:1px solid #1a1a1a;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.file-btn{background:#1a1a1a;color:#94a3b8;padding:6px 10px;border:1px solid #2a2a2a;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;min-height:28px;touch-action:manipulation;transition:all .2s}
.file-btn:hover{background:#2a2a2a;color:#e2e8f0}
.file-btn:active{transform:scale(0.97)}
.hd-btn{background:#1a1a1a;color:#94a3b8;padding:6px 10px;border:1px solid #2a2a2a;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;font-family:inherit;min-width:56px;text-align:center;min-height:28px;touch-action:manipulation;transition:all .2s}
.hd-btn:hover{background:#2a2a2a;color:#e2e8f0}
.file-name{font-size:12px;color:#94a3b8;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.file-status{font-size:11px;font-weight:600}
.kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(90px,1fr));gap:6px;padding:10px 20px;background:#0a0a0a}
.kpi-item{text-align:center;padding:6px 4px}
.kpi-item .v{font-size:17px;font-weight:700;color:#60a5fa}.kpi-item .l{font-size:10px;color:#94a3b8;margin-top:2px}
.sum-section{margin-bottom:20px}
.sum-section h3{font-size:14px;color:#60a5fa;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid #1a1a1a}
.sum-tbl{border-collapse:collapse;width:100%;font-size:13px;margin-bottom:10px}
.sum-tbl th,.sum-tbl td{padding:8px 12px;border:1px solid #1a1a1a;text-align:center}
.sum-tbl th{background:#1a1a1a;color:#e2e8f0;font-weight:700;white-space:nowrap}
.sum-tbl td{color:#cbd5e1}
.ov-sum{font-size:11px}.ov-sum th,.ov-sum td{padding:4px 8px}.ov-sum td[onclick]{cursor:pointer;transition:background .15s}.ov-sum td[onclick]:hover{background:#1e3a5f}
.sum-tbl .good{color:#22c55e;font-weight:700}
.sum-tbl .bad{color:#ef4444;font-weight:700}
.sum-tbl .kpi-target{color:#f59e0b;font-weight:600;font-size:11px}
.worst-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media(max-width:700px){.worst-grid{grid-template-columns:1fr}.worst-grid-3{grid-template-columns:1fr!important}}
.worst-card{background:#111;border-radius:10px;border:1px solid #1a1a1a;padding:12px}
.worst-card h4{font-size:13px;margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid #1a1a1a}
.worst-tbl{border-collapse:collapse;width:100%;font-size:12px}
.worst-tbl th,.worst-tbl td{padding:5px 8px;border:1px solid #1a1a1a;text-align:center}
.worst-tbl th{background:#1a1a1a;color:#e2e8f0;font-size:11px}
.worst-tbl td{color:#cbd5e1}
.worst-tbl tr:first-child td{color:#ef4444;font-weight:700}
.tabs{display:flex;flex-wrap:wrap;gap:4px;padding:10px 16px;background:#0a0a0a;border-bottom:1px solid #1a1a1a;position:sticky;top:0;z-index:100}
.tab{padding:6px 10px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;background:#1a1a1a;color:#94a3b8;border:1px solid #2a2a2a;transition:all .2s;white-space:nowrap;touch-action:manipulation}
.tab.on{background:#3b82f6;color:#fff;border-color:#3b82f6}
.tab:hover:not(.on){background:#2a2a2a;color:#e2e8f0}
.pn{display:none;padding:16px}.pn.on{display:block}
.bx{background:#0a0a0a;border-radius:12px;padding:14px;border:1px solid #1a1a1a;margin-bottom:16px}
.bx h3{font-size:13px;color:#60a5fa;margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid #1a1a1a}
.bx h3 em{font-size:10px;color:#94a3b8;font-weight:400;font-style:normal;margin-left:6px}
canvas{max-height:360px}
.hc{overflow-x:auto;-webkit-overflow-scrolling:touch}
table.ht{border-collapse:collapse;font-size:11px;width:100%}
table.ht th,table.ht td{padding:4px 6px;text-align:center;border:1px solid #333;white-space:nowrap}
table.ht th{background:#1a1a1a;color:#e2e8f0}
table.ht td{background:#000;color:#cbd5e1}
table.ht thead th{position:sticky;top:0;z-index:2}
table.ht tbody th,table.ht thead th:first-child{position:sticky;left:0;z-index:3;background:#1a1a1a}
table.ht thead th:first-child{z-index:4}
.h0{background:#000}
.lg{display:flex;gap:8px;align-items:center;margin:6px 0;font-size:10px;flex-wrap:wrap}
.li{display:flex;align-items:center;gap:3px}.lc{width:16px;height:10px;border-radius:2px}
.loading{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:999;justify-content:center;align-items:center;font-size:18px;color:#60a5fa}
.loading.show{display:flex}
.modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.75);z-index:1000;justify-content:center;align-items:center;padding:16px}
.modal-overlay.show{display:flex}
.modal{background:#0a0a0a;border-radius:12px;border:1px solid #3b82f6;max-width:96vw;width:100%;max-height:85vh;overflow:hidden;padding:16px;display:flex;flex-direction:column}
.modal #modalBody{overflow:auto;flex:1;min-height:0}
.modal h3{color:#60a5fa;font-size:15px;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid #1a1a1a}
.modal table{border-collapse:collapse;width:max-content;font-size:12px}
.modal th{background:#1a1a1a;color:#e2e8f0;padding:6px 8px;text-align:left;position:sticky;top:0;white-space:nowrap}
.modal td{padding:5px 8px;border-bottom:1px solid #1a1a1a;color:#cbd5e1;white-space:nowrap}
.modal tr:hover td{background:#1a1a1a}
.modal .close-btn{float:right;background:none;border:none;color:#94a3b8;font-size:20px;cursor:pointer;padding:0 4px;line-height:1}
.modal .close-btn:hover{color:#ef4444}
.modal .highlight{color:#ef4444;font-weight:700}
.hm-click{cursor:pointer;transition:outline .15s}.hm-click:hover{outline:2px solid #60a5fa;outline-offset:-1px}
#fileInput{position:absolute;width:1px;height:1px;opacity:0;overflow:hidden;clip:rect(0,0,0,0)}
.line-label{font-size:12px;font-weight:700;padding:4px 12px;border-radius:6px;display:inline-block;margin-bottom:4px}
.welcome{text-align:center;padding:60px 20px;color:#94a3b8}
.welcome h2{font-size:24px;color:#60a5fa;margin-bottom:12px}
.welcome p{font-size:14px;line-height:1.8}
.welcome .arrow{font-size:40px;margin:20px 0;color:#3b82f6;animation:bounce 1.5s infinite}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
</style>
</head>
<body>
<div class="hd" style="position:relative">
<h1>ğŸ“Š í˜„í™© v14.0</h1>
<div style="position:absolute;top:12px;right:20px;display:flex;gap:4px;align-items:center">
<label class="file-btn" for="fileInput" id="fileBtnLabel" style="min-width:56px">íŒŒì¼ì„ íƒ</label>
<button id="clearBtn" class="hd-btn" style="display:none" onclick="clearData()">ì´ˆê¸°í™”</button>
<button onclick="setLang('ko')" class="hd-btn" id="langKo">í•œêµ­ì–´</button>
<button onclick="setLang('zh')" class="hd-btn" id="langZh">ä¸­æ–‡</button>
</div>
<input type="file" id="fileInput" accept=".xlsx,.xls" onchange="handleFile(this)">
<span id="fileName" style="display:none"></span><span id="fileStatus" style="display:none"></span>
</div>
<!-- KPI area removed -->
<div class="tabs" id="tabArea" style="display:none"></div>
<div id="root">
<div class="welcome">
<div class="arrow">ğŸ‘†</div>
<h2 id="welcomeTitle">íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”</h2>
<p id="welcomeDesc">ğŸ“‚ ìœ„ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”<br>
<strong>_POLE_æ»å·ç¨¼åŠ¨æ—¥åˆ«ç°å†µ</strong> íŒŒì¼ì„ ì§€ì›í•©ë‹ˆë‹¤<br>
PMè°ƒæ•´ ë°ì´í„°ë¥¼ ìë™ ë¶„ì„í•©ë‹ˆë‹¤</p>
</div>
</div>
<div class="loading" id="loadingOverlay">â³ íŒŒì¼ ë¶„ì„ ì¤‘...</div>
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
<div class="modal"><button class="close-btn" onclick="closeModal()">&times;</button><h3 id="modalTitle"></h3><div id="modalBody"></div></div>
</div>

<script>
var _nxFont="'ë„¥ìŠ¨Lv2ê³ ë”•','NEXON Lv2 Gothic',sans-serif";
Chart.defaults.font.family=_nxFont;
let D=null, charts=[];
var LANG=localStorage.getItem('dashLang')||'ko';
var I={
ko:{
fileSelect:'íŒŒì¼ ì„ íƒ',
init:'ì´ˆê¸°í™”',
waiting:'ëŒ€ê¸°ì¤‘',
uploadGuide:'ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ë¶„ì„ì´ ì‹œì‘ë©ë‹ˆë‹¤',
selectFile:'íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”',
uploadTitle:'íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”',
uploadDesc:'ìœ„ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”',
uploadSupport:'íŒŒì¼ì„ ì§€ì›í•©ë‹ˆë‹¤',
autoAnalysis:'PMè°ƒæ•´ ë°ì´í„°ë¥¼ ìë™ ë¶„ì„í•©ë‹ˆë‹¤',
analyzing:'íŒŒì¼ ë¶„ì„ ì¤‘...',
processing:'ì²˜ë¦¬ì¤‘: ',
analyzing2:'ë¶„ì„ì¤‘...',
current:'í˜„ì¬: ',
loadDone:'ë¡œë“œì™„ë£Œ',
error:'ì˜¤ë¥˜',
saved:'ì €ì¥ë¨',
savedData:'ì €ì¥ëœ ë°ì´í„°',
updateTitle:'ì—…ë°ì´íŠ¸ë¨ â€” íŒŒì¼ì„ ë‹¤ì‹œ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”',
updateDesc:'ëŒ€ì‹œë³´ë“œê°€ ì—…ë°ì´íŠ¸(v',
updateDesc2:')ë˜ì–´ íŒŒì¼ì„ ë‹¤ì‹œ ë¶ˆëŸ¬ì™€ì•¼ í•©ë‹ˆë‹¤.',
sheet:'ì‹œíŠ¸',qty:'ìˆ˜ëŸ‰',content:'ë‚´ìš©',
noData:'ë°ì´í„° ì—†ìŒ',
noDataFound:'ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
tabOverview:'ìš”ì•½',
tabLoss:'Loss',
tabStop:'ì •ì§€',
tabUtil:'ê°€ë™ìœ¨',
tabDaily:'ì •ì§€ì‹œê°„',
tabDefHm:'ë¶ˆëŸ‰ë§µ',
tabStopHm:'ì •ì§€ë§µ',
tabST:'í™˜ì‚°ê²€í† ',
lossTitle:'ì¼ê°„ Loss í˜„í™©',
lossDaily:'ì¼ê°„ Loss í˜„í™©',
lossDetail:'ìƒì„¸ Loss í˜„í™©',
accum:'ëˆ„ì ',
target:'ëª©í‘œ',
total:'í•©ê³„',
line:'ë¼ì¸',
date:'ì¼ì',
equip:'ì„¤ë¹„',
stopTime:'ì •ì§€ì‹œê°„',
defect:'ë¶ˆëŸ‰ìˆ˜ëŸ‰',
prod:'ìƒì‚°ì‹¤ì ',
plan:'ê³„íš(Capa)',
utilRate:'ê°€ë™ìœ¨',
lossRate:'Lossìœ¨',
chart:'ê·¸ë˜í”„',
ovLossChart:'ì¼ê°„ Loss ê·¸ë˜í”„',
kpiTitle:'ì„¤ë¹„ ì •ì§€ ì‹œê°„ í˜„í™©',
kpiTarget:'ëª©í‘œ: ',
yesterday:'ì „ì¼',
weekly:'ì£¼ê°„',
monthly:'ì›”ê°„',
top3Title:'ì •ì§€ Worst 3',
top3Hdr:['#','ì„¤ë¹„','ì •ì§€ì‹œê°„(ì£¼ê°„)','ì •ì§€ê±´ìˆ˜','ë¶ˆëŸ‰ìˆ˜ëŸ‰(ì£¼ê°„)','ì£¼ìš” ì¡°ì •í•­ëª©'],
noEquip:'í•´ë‹¹ ì„¤ë¹„ ì—†ìŒ',
worst5Title:'Worst 5',
worst5Stop:'ì •ì§€ì‹œê°„ ê¸°ì¤€ Worst 5',
worst5Def:'ë¶ˆëŸ‰ìˆ˜ëŸ‰ ê¸°ì¤€ Worst 5',
worst5Hdr:['#','ì„¤ë¹„','ì‹œê°„(ë¶„)','ë¶ˆëŸ‰ìˆ˜ëŸ‰','ì£¼ìš” ì¡°ì •í•­ëª©'],
worst5Trend:'ì „ì¼ ì •ì§€ì‹œê°„ Worst 5 - ì£¼ê°„ ì‹¤ì  ì¶”ì´',
worst10Title:'Worst 10',
worst10Hdr:['#','í•­ëª©','ìƒì„¸ì¡°ì •ë‚´ìš©','ë¶ˆëŸ‰ìˆ˜ëŸ‰','ì‹œê°„(ë¶„)','ì •ì§€'],
worst10Sum:'í•©ê³„ (Top10)',
sortDefect:'ë¶ˆëŸ‰ìˆ˜ëŸ‰',
sortTime:'ì¡°ì •ì‹œê°„',
allOf:'ì „ì²´',
topOf:'ì¤‘ ìƒìœ„',
items:'ê±´',
eqHmTitle:'ì„¤ë¹„ íˆíŠ¸ë§µ',
eqHmDays:'ìµœê·¼',
eqHmDaysSuffix:'ì¼',
eqHmDate:'ì¼ì',
eqHmStop:'ì •ì§€ì‹œê°„(ë¶„)',
eqHmDef:'ë¶ˆëŸ‰ìˆ˜ëŸ‰',
eqHmHelp:'ì…€ í´ë¦­ ì‹œ í•´ë‹¹ ì¼ì ìƒì„¸ ë‚´ì—­ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤',
dayDetailTitle:'Worst 5',
eqDate:'ì„¤ë¹„\\\\ì¼ì',
dailyStopDefTitle:'ì¼ìë³„ ì •ì§€ì‹œê°„ / ë¶ˆëŸ‰ìˆ˜ëŸ‰',
dailyStopVs:'ì •ì§€ vs ë¹„ì •ì§€',
dailyTimeMin:'ì‹œê°„(ë¶„)',
stop:'ì •ì§€',
nonStop:'ë¹„ì •ì§€',
category:'êµ¬ë¶„',
count:'ê±´ìˆ˜',
stTitle:'ì‹œê°„ëŒ€ë¹„ë¶„ì„',
stDiag:'ë°ì´í„° ì§„ë‹¨ (í´ë¦­í•´ì„œ í¼ì¹˜ê¸°)',
stAllSheets:'ì „ì²´ ì‹œíŠ¸: ',
stMatched:'ë§¤ì¹­ëœ æ—¥æŠ¥ ì‹œíŠ¸: ',
stProcessed:'ì²˜ë¦¬ëœ í–‰ìˆ˜: ',
stDateCnt:'ë‚ ì§œìˆ˜: ',
stWeekCnt:'ì£¼ì°¨ìˆ˜: ',
stEqs:'ìƒì‚°ì„¤ë¹„: ',
stData:'ë°ì´í„°: ',
stDays:'ì¼',
stWeeks:'ì£¼ì°¨',
stEquips:'ëŒ€',
stByDate:'ì¼ìë³„',
stByWeek:'ì£¼ì°¨ë³„',
stAccum:'ëˆ„ì ',
stDateSel:'ì¼ì ì„ íƒ: ',
stWeekSel:'ì£¼ì°¨ ì„ íƒ: ',
stWeekLabel:'ì£¼ì°¨',
stBasis:'ê¸°ì¤€: ',
stInputHelp:'âœ S/Tì…€ ì§ì ‘ ì…ë ¥ ê°€ëŠ¥ | ë”ë¸”í´ë¦­â†’ì´ˆê¸°í™”',
stResetAll:'S/T ì „ì²´ ì´ˆê¸°í™”',
stHdr:['ì„¤ë¹„','S/Tì‹¤ì œ(ì´ˆ)','Capa','ìƒì‚°ëŸ‰','ê°€ë™ìœ¨','ì°¨ì´','ì •ì§€ì‹œê°„(ë¶„)','ìˆ˜ëŸ‰í™˜ì‚°','í™˜ì‚°ì°¨ì´','ê²°ë¡ '],
stNormal:'ì •ìƒ',
stAbnormal:'S/T ì´ìƒ',
stRecordErr:'ê¸°ë¡ì´ìƒ',
stSummary:'ìš”ì•½',
stModified:'ìˆ˜ì •ë¨ (ë”ë¸”í´ë¦­â†’ì´ˆê¸°í™”)',
stDirectInput:'S/T ì§ì ‘ ì…ë ¥',
stActual:'S/Tì‹¤ì œ: ',
stConvDiff:'í™˜ì‚°ì°¨ì´: ',
stConclusion:'ê²°ë¡ : ',
stOver:'ì´ìƒ',
lossDetailHdr:['PMì¡°ì •','ì™„ì „ë¶ˆëŸ‰','ê³µì •ë¶ˆëŸ‰','ì¹˜ìˆ˜ë¶ˆëŸ‰','Leadêµì²´','Filmêµì²´','ì •ì§€','ì›ìì¬ë¶ˆëŸ‰','í’ˆì§ˆìƒ˜í”Œ','ê¸°ìˆ ì¡°ì •'],
lossNoData:'LOSS ë°ì´í„° ì—†ìŒ',
selDateLine:'ì„ íƒ ë‚ ì§œ/ë¼ì¸ ë°ì´í„° ì—†ìŒ',
min:'ë¶„',
avgDay:'ì¼í‰ê· ',
pmOnly:'PMè°ƒæ•´ Only | åœæœº/å¼€æœº ì œì™¸ | >1000ë¶„ ì œì™¸ | ì„¤ë¹„ ',
eqUnit:'ëŒ€',
utilTitle:'ê°€ë™ìœ¨í˜„í™©',
utilTarget:'ëª©í‘œ',
kpiDateLabel:'ê¸°ì¤€ì¼',
hmAvg:'í‰ê· ',
hmDefTitle:'ì„¤ë¹„ ì¼ìë³„ ë¶ˆëŸ‰ìˆ˜ëŸ‰',
hmStopTitle:'ì„¤ë¹„ ì¼ìë³„ ì¡°ì •ì‹œê°„(ë¶„)',
lineDaily:' Line ì¼ìë³„ ì •ì§€ì‹œê°„ / ë¶ˆëŸ‰ìˆ˜ëŸ‰',
lineStopVs:' Line ì •ì§€ vs ë¹„ì •ì§€',
allDaily:'ì „ì²´ ì¼ìë³„ ì •ì§€ì‹œê°„ / ë¶ˆëŸ‰ìˆ˜ëŸ‰',
ovDailyTitle:'ì¼ê°„ ì •ì§€, ë¶ˆëŸ‰ ìˆ˜ëŸ‰ í˜„í™©',
allStopVs:'ì „ì²´ ì •ì§€ vs ë¹„ì •ì§€',
tabInsp:'ê²€ì‚¬ê¸°',
inspDefChart:'ì™„ì „+ì¹˜ìˆ˜ ë¶ˆëŸ‰ í˜„í™©',
inspKpi:'ê²€ì‚¬ê¸° ì¡°ì • í˜„í™©',
inspWorst:'ì´ë²ˆì£¼ Worst 5',
fullDef:'ì™„ì „ë¶ˆëŸ‰',
dimDef:'ì¹˜ìˆ˜ë¶ˆëŸ‰',
prevDay:'ì „ì¼',
inspDefW:'ë¶ˆëŸ‰ìˆ˜ëŸ‰',
ovInspTblTitle:'ì™„ì „+ì¹˜ìˆ˜ í˜„í™©',
ovSumTitle:'ì „ì¼ìš”ì•½',
ovInspWorstTitle:'ê²€ì‚¬ê¸° ë¶ˆëŸ‰,ì •ì§€ Worst 5',
inspTimeW:'ì •ì§€ì‹œê°„'
},
zh:{
fileSelect:'é€‰æ‹©æ–‡ä»¶',
init:'åˆå§‹åŒ–',
waiting:'å¾…æœºä¸­',
uploadGuide:'ä¸Šä¼ Excelæ–‡ä»¶åå¼€å§‹åˆ†æ',
selectFile:'è¯·é€‰æ‹©æ–‡ä»¶',
uploadTitle:'è¯·ä¸Šä¼ æ–‡ä»¶',
uploadDesc:'è¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®é€‰æ‹©Excelæ–‡ä»¶',
uploadSupport:'æ–‡ä»¶',
autoAnalysis:'PMè°ƒæ•´ æ•°æ®è‡ªåŠ¨åˆ†æ',
analyzing:'æ–‡ä»¶åˆ†æä¸­...',
processing:'å¤„ç†ä¸­: ',
analyzing2:'åˆ†æä¸­...',
current:'å½“å‰: ',
loadDone:'åŠ è½½å®Œæˆ',
error:'é”™è¯¯',
saved:'å·²ä¿å­˜',
savedData:'å·²ä¿å­˜æ•°æ®',
updateTitle:'å·²æ›´æ–° â€” è¯·é‡æ–°ä¸Šä¼ æ–‡ä»¶',
updateDesc:'ä»ªè¡¨æ¿å·²æ›´æ–°(v',
updateDesc2:')ï¼Œè¯·é‡æ–°ä¸Šä¼ æ–‡ä»¶ã€‚',
sheet:'å·¥ä½œè¡¨',qty:'æ•°é‡',content:'å†…å®¹',
noData:'æ— æ•°æ®',
noDataFound:'æœªæ‰¾åˆ°æ•°æ®ã€‚',
tabOverview:'æ±‡æ€»',
tabLoss:'Loss',
tabStop:'åœæœº',
tabUtil:'ç¨¼åŠ¨ç‡',
tabDaily:'åœæœºæ—¶é—´',
tabDefHm:'ä¸è‰¯å›¾',
tabStopHm:'åœæœºå›¾',
tabST:'æ¢ç®—æ£€è®¨',
lossTitle:'æ—¥é—´ Loss ç°å†µ',
lossDaily:'æ—¥é—´ Loss ç°å†µ',
lossDetail:'è¯¦ç»† Loss ç°å†µ',
accum:'ç´¯è®¡',
target:'ç›®æ ‡',
total:'åˆè®¡',
line:'äº§çº¿',
date:'æ—¥æœŸ',
equip:'è®¾å¤‡',
stopTime:'åœæœºæ—¶é—´',
defect:'ä¸è‰¯æ•°é‡',
prod:'ç”Ÿäº§ä¸šç»©',
plan:'è®¡åˆ’(Capa)',
utilRate:'ç¨¼åŠ¨ç‡',
lossRate:'Lossç‡',
chart:'å›¾è¡¨',
ovLossChart:'æ—¥é—´ Loss å›¾è¡¨',
kpiTitle:'è®¾å¤‡åœæœºæ—¶é—´ç°å†µ',
kpiTarget:'ç›®æ ‡: ',
yesterday:'å‰æ—¥',
weekly:'å‘¨é—´',
monthly:'æœˆé—´',
top3Title:'åœæœº Worst 3',
top3Hdr:['#','è®¾å¤‡','åœæœºæ—¶é—´(å‘¨é—´)','åœæœºæ¬¡æ•°','ä¸è‰¯æ•°é‡(å‘¨é—´)','ä¸»è¦è°ƒæ•´é¡¹ç›®'],
noEquip:'æ— ç›¸å…³è®¾å¤‡',
worst5Title:'Worst 5',
worst5Stop:'åœæœºæ—¶é—´ Worst 5',
worst5Def:'ä¸è‰¯æ•°é‡ Worst 5',
worst5Hdr:['#','è®¾å¤‡','æ—¶é—´(åˆ†)','ä¸è‰¯æ•°é‡','ä¸»è¦è°ƒæ•´é¡¹ç›®'],
worst5Trend:'å‰æ—¥åœæœº Worst 5 - å‘¨é—´å®ç»©è¶‹åŠ¿',
worst10Title:'Worst 10',
worst10Hdr:['#','é¡¹ç›®','è¯¦ç»†è°ƒæ•´å†…å®¹','ä¸è‰¯æ•°é‡','æ—¶é—´(åˆ†)','åœæœº'],
worst10Sum:'åˆè®¡ (Top10)',
sortDefect:'ä¸è‰¯æ•°é‡',
sortTime:'è°ƒæ•´æ—¶é—´',
allOf:'å…¨éƒ¨',
topOf:'ä¸­å‰',
items:'ä»¶',
eqHmTitle:'è®¾å¤‡çƒ­å›¾',
eqHmDays:'æœ€è¿‘',
eqHmDaysSuffix:'å¤©',
eqHmDate:'æ—¥æœŸ',
eqHmStop:'åœæœºæ—¶é—´(åˆ†)',
eqHmDef:'ä¸è‰¯æ•°é‡',
eqHmHelp:'ç‚¹å‡»å•å…ƒæ ¼å¯æŸ¥çœ‹å½“æ—¥è¯¦æƒ…',
dayDetailTitle:'Worst 5',
eqDate:'è®¾å¤‡\\\\æ—¥æœŸ',
dailyStopDefTitle:'æ—¥åˆ«åœæœºæ—¶é—´ / ä¸è‰¯æ•°é‡',
dailyStopVs:'åœæœº vs éåœæœº',
dailyTimeMin:'æ—¶é—´(åˆ†)',
stop:'åœæœº',
nonStop:'éåœæœº',
category:'åŒºåˆ†',
count:'æ¬¡æ•°',
stTitle:'æ—¶é—´å¯¹æ¯”åˆ†æ',
stDiag:'æ•°æ®è¯Šæ–­ (ç‚¹å‡»å±•å¼€)',
stAllSheets:'å…¨éƒ¨å·¥ä½œè¡¨: ',
stMatched:'åŒ¹é…æ—¥æŠ¥å·¥ä½œè¡¨: ',
stProcessed:'å¤„ç†è¡Œæ•°: ',
stDateCnt:'æ—¥æœŸæ•°: ',
stWeekCnt:'å‘¨æ•°: ',
stEqs:'ç”Ÿäº§è®¾å¤‡: ',
stData:'æ•°æ®: ',
stDays:'å¤©',
stWeeks:'å‘¨',
stEquips:'å°',
stByDate:'æ—¥åˆ«',
stByWeek:'å‘¨åˆ«',
stAccum:'ç´¯è®¡',
stDateSel:'æ—¥æœŸé€‰æ‹©: ',
stWeekSel:'å‘¨é€‰æ‹©: ',
stWeekLabel:'å‘¨',
stBasis:'åŸºå‡†: ',
stInputHelp:'âœ S/Tå•å…ƒæ ¼å¯ç›´æ¥è¾“å…¥ | åŒå‡»â†’é‡ç½®',
stResetAll:'S/T å…¨éƒ¨é‡ç½®',
stHdr:['è®¾å¤‡','S/Tå®é™…(ç§’)','Capa','ç”Ÿäº§é‡','ç¨¼åŠ¨ç‡','å·®å¼‚','åœæœºæ—¶é—´(åˆ†)','æ•°é‡æ¢ç®—','æ¢ç®—å·®å¼‚','ç»“è®º'],
stNormal:'æ­£å¸¸',
stAbnormal:'S/T å¼‚å¸¸',
stRecordErr:'è®°å½•å¼‚å¸¸',
stSummary:'æ±‡æ€»',
stModified:'å·²ä¿®æ”¹ (åŒå‡»â†’é‡ç½®)',
stDirectInput:'S/T ç›´æ¥è¾“å…¥',
stActual:'S/Tå®é™…: ',
stConvDiff:'æ¢ç®—å·®å¼‚: ',
stConclusion:'ç»“è®º: ',
stOver:'å¼‚å¸¸',
lossDetailHdr:['PMè°ƒæ•´','å®Œå…¨ä¸è‰¯','å·¥ç¨‹ä¸è‰¯','å°ºå¯¸ä¸è‰¯','Leadæ›´æ¢','Filmæ›´æ¢','åœæœº','åŸèµ„æä¸è‰¯','å“è´¨æ ·å“','æŠ€æœ¯è°ƒæ•´'],
lossNoData:'LOSS æ— æ•°æ®',
selDateLine:'æ— æ‰€é€‰æ—¥æœŸ/äº§çº¿æ•°æ®',
min:'åˆ†',
avgDay:'æ—¥å‡',
pmOnly:'PMè°ƒæ•´ Only | åœæœº/å¼€æœº é™¤å¤– | >1000åˆ† é™¤å¤– | è®¾å¤‡ ',
eqUnit:'å°',
utilTitle:'ç¨¼åŠ¨ç‡ç°å†µ',
utilTarget:'ç›®æ ‡',
kpiDateLabel:'åŸºå‡†æ—¥',
hmAvg:'å¹³å‡',
hmDefTitle:'è®¾å¤‡æ—¥åˆ«ä¸è‰¯æ•°é‡',
hmStopTitle:'è®¾å¤‡æ—¥åˆ«è°ƒæ•´æ—¶é—´(åˆ†)',
lineDaily:' Line æ—¥åˆ«åœæœºæ—¶é—´ / ä¸è‰¯æ•°é‡',
lineStopVs:' Line åœæœº vs éåœæœº',
allDaily:'å…¨ä½“æ—¥åˆ«åœæœºæ—¶é—´ / ä¸è‰¯æ•°é‡',
ovDailyTitle:'æ—¥é—´åœæœº, ä¸è‰¯æ•°é‡ç°å†µ',
allStopVs:'å…¨ä½“åœæœº vs éåœæœº',
tabInsp:'æ£€æŸ¥æœº',
inspDefChart:'å®Œå…¨+å°ºå¯¸ ä¸è‰¯ ç°å†µ',
inspKpi:'æ£€æŸ¥æœº è°ƒæ•´ ç°å†µ',
inspWorst:'æœ¬å‘¨ Worst 5',
fullDef:'å®Œå…¨ä¸è‰¯',
dimDef:'å°ºå¯¸ä¸è‰¯',
prevDay:'å‰æ—¥',
inspDefW:'ä¸è‰¯æ•°é‡',
ovInspTblTitle:'å®Œå…¨+å°ºå¯¸ ç°å†µ',
ovSumTitle:'å‰æ—¥æ±‡æ€»',
ovInspWorstTitle:'æ£€æŸ¥æœº ä¸è‰¯,åœæœº Worst 5',
inspTimeW:'åœæœºæ—¶é—´'
}
};
function t(k){return(I[LANG]||I.ko)[k]||(I.ko)[k]||k;}
function setLang(lang){LANG=lang;localStorage.setItem('dashLang',lang);document.documentElement.lang=lang==='zh'?'zh-CN':'ko';updateLangUI();if(D)renderAll();else{updateStaticTexts();}}
function updateLangUI(){var ko=document.getElementById('langKo'),zh=document.getElementById('langZh');if(ko){ko.style.color=LANG==='ko'?'#e2e8f0':'#94a3b8';ko.style.borderColor=LANG==='ko'?'#64748b':'#2a2a2a';}if(zh){zh.style.color=LANG==='zh'?'#e2e8f0':'#94a3b8';zh.style.borderColor=LANG==='zh'?'#64748b':'#2a2a2a';}updateStaticTexts();}
function updateStaticTexts(){
var _inf=document.getElementById('info');if(_inf)_inf.textContent='';
var fn=document.getElementById('fileName');if(fn&&!D)fn.textContent=t('selectFile');
var fs=document.getElementById('fileStatus');if(fs&&!D)fs.textContent=t('waiting');
var fb=document.getElementById('fileBtnLabel');if(fb)fb.innerHTML=t('fileSelect');
var cb=document.getElementById('clearBtn');if(cb)cb.innerHTML=t('init');
var lt=document.getElementById('loadingOverlay');if(lt)lt.innerHTML='\u23f3 '+t('analyzing');
var wt=document.getElementById('welcomeTitle');if(wt)wt.textContent=t('uploadTitle');
var wd=document.getElementById('welcomeDesc');if(wd)wd.innerHTML='\ud83d\udcc2 '+t('uploadDesc')+'<br><strong>_POLE_\u6ec1\u5dde\u7a3c\u52a8\u65e5\u522b\u73b0\u51b5</strong> '+t('uploadSupport')+'<br>PM\u8c03\u6574 '+t('autoAnalysis');
}

var LOSS_DETAIL_HDR_FN=function(){return t("lossDetailHdr");};
var DATA_VERSION='14.0'; // ì´ ê°’ì´ ë°”ë€Œë©´ localStorage ìºì‹œ ìë™ ì‚­ì œ

// === IndexedDB: ì›ë³¸ ì—‘ì…€ íŒŒì¼ ìºì‹± (ë²„ì „ë³€ê²½ ì‹œ ìë™ ì¬ì²˜ë¦¬) ===
function _idbOpen(cb){
  var req=indexedDB.open('dashDB',1);
  req.onupgradeneeded=function(e){e.target.result.createObjectStore('files');};
  req.onsuccess=function(e){cb(e.target.result);};
  req.onerror=function(){cb(null);};
}
function _idbSave(buf,fname){
  _idbOpen(function(db){if(!db)return;var tx=db.transaction('files','readwrite');tx.objectStore('files').put(buf,'rawFile');tx.objectStore('files').put(fname,'fileName');});
}
function _idbLoad(cb){
  _idbOpen(function(db){if(!db){cb(null,null);return;}
    var tx=db.transaction('files','readonly');var s=tx.objectStore('files');
    var r1=s.get('rawFile'),r2=s.get('fileName');
    var buf=null,fn=null;
    r1.onsuccess=function(){buf=r1.result;};
    r2.onsuccess=function(){fn=r2.result;};
    tx.oncomplete=function(){cb(buf,fn);};
    tx.onerror=function(){cb(null,null);};
  });
}
function _idbClear(){_idbOpen(function(db){if(!db)return;var tx=db.transaction('files','readwrite');tx.objectStore('files').clear();});}
function _processAndRender(arrayBuf,fileName){
  document.getElementById('fileName').textContent=t('processing')+fileName;
  document.getElementById('fileStatus').textContent='â³ '+t('analyzing2');
  document.getElementById('fileStatus').style.color='#f59e0b';
  document.getElementById('loadingOverlay').classList.add('show');
  setTimeout(function(){
    try{
      var wb=XLSX.read(arrayBuf,{type:'array'});
      var nd=processWorkbook(wb);
      if(nd){
        D=nd;
        document.getElementById('tabArea').style.display='';
        updateLangUI();renderAll();
        try{localStorage.setItem('dashData',JSON.stringify(D));localStorage.setItem('dashFile',fileName)}catch(e){}
        document.getElementById('fileName').textContent=t('current')+fileName;
        document.getElementById('fileStatus').textContent='âœ“ '+t('loadDone')+' ('+D.totalRec.toLocaleString()+t('items')+')';
        document.getElementById('fileStatus').style.color='#22c55e';
        document.getElementById('clearBtn').style.display='';
      }
    }catch(err){alert(t('error')+': '+err.message);}
    finally{document.getElementById('loadingOverlay').classList.remove('show');}
  },50);
}
function handleFile(input){
  var file=input.files[0]; if(!file)return;
  document.getElementById('fileName').textContent=t('processing')+file.name;
  document.getElementById('fileStatus').textContent='â³ '+t('analyzing2');
  document.getElementById('fileStatus').style.color='#f59e0b';
  document.getElementById('loadingOverlay').classList.add('show');
  var reader=new FileReader();
  reader.onload=function(e){
    // ì›ë³¸ íŒŒì¼ IndexedDBì— ì €ì¥
    _idbSave(e.target.result,file.name);
    setTimeout(function(){
      try{
        var wb=XLSX.read(e.target.result,{type:'array'});
        var nd=processWorkbook(wb);
        if(nd){
          D=nd;
          document.getElementById('tabArea').style.display='';
          updateLangUI();renderAll();
          try{localStorage.setItem('dashData',JSON.stringify(D));localStorage.setItem('dashFile',file.name)}catch(e){}
          document.getElementById('fileName').textContent=t('current')+file.name;
          document.getElementById('fileStatus').textContent='âœ“ '+t('loadDone')+' ('+D.totalRec.toLocaleString()+t('items')+')';
          document.getElementById('fileStatus').style.color='#22c55e';
          document.getElementById('clearBtn').style.display='';
        }
      }catch(err){
        alert(t('error')+': '+err.message);
        document.getElementById('fileStatus').textContent='âœ— '+t('error');
        document.getElementById('fileStatus').style.color='#ef4444';
      }
      document.getElementById('loadingOverlay').classList.remove('show');
      input.value='';
    },100);
  };
  reader.readAsArrayBuffer(file);
}

function processWorkbook(wb){
  var allRows=[],inspAllRows=[];
  var _dbgAllSheets=wb.SheetNames.slice();
  var lossByLineDate={},lossAccumByLine={},lossDates=[];
  var _lossDbg={sheets:[],found:'ì—†ìŒ',rows:0,sample:''};
  var stopByDateEq={};
  var kpiStopByDateEq={}; // KPIìš©: PMè°ƒæ•´ë§Œ, åœæœº/å¼€æœº ì œì™¸, col20 ì •ì§€ì‹œê°„
  // === ì‹œíŠ¸ ë¶„ë¥˜: ì´ë¦„ìœ¼ë¡œ ë¨¼ì € íŒë³„í•˜ì—¬ í•„ìš”í•œ ì‹œíŠ¸ë§Œ íŒŒì‹± ===
  var _adjSheets=[],_niboSheets=[],_lossSheet='';
  for(var si=0;si<wb.SheetNames.length;si++){
    var sn=wb.SheetNames[si];
    if(sn.indexOf('è°ƒæ•´å±¥å†')>=0||sn.indexOf('èª¿æ•´å±¥æ­´')>=0||sn.indexOf('å±¥å†')>=0||sn.indexOf('å±¥æ­´')>=0){_adjSheets.push(sn);continue;}
    if(sn.indexOf('æ—¥æŠ¥')>=0||sn.indexOf('æ—¥å ±')>=0){_niboSheets.push(sn);continue;}
    if(sn.indexOf('æ—¥åˆ«æ±‡æ€»')>=0||sn.indexOf('æ—¥åˆ¥åŒ¯ç¸½')>=0){_lossSheet=sn;continue;}
  }
  // === è°ƒæ•´å±¥å†: allRows + stopByDateEq í•œë²ˆì— ì²˜ë¦¬ ===
  for(var ai=0;ai<_adjSheets.length;ai++){
    var raw=XLSX.utils.sheet_to_json(wb.Sheets[_adjSheets[ai]],{header:1,defval:null,raw:true});
    if(raw.length<3)continue;
    var lastDateA=null;
    for(var i=2;i<raw.length;i++){
      var r=raw[i]; if(!r||!r[3]||!r[4])continue;
      var dateStr=parseStDate(r[3]);
      if(!dateStr)continue;
      var eq=(r[4]||'').toString().trim().toUpperCase();
      if(!eq)continue;
      // stopByDateEq: ëª¨ë“  åœ í–‰ (íˆíŠ¸ë§µìš©)
      var _stopYN=(r[19]||'').toString().trim();
      if(_stopYN==='åœ'){
        var sm=typeof r[20]==='number'?r[20]:(parseFloat(r[20])||0);
        if(!stopByDateEq[dateStr])stopByDateEq[dateStr]={};
        stopByDateEq[dateStr][eq]=(stopByDateEq[dateStr][eq]||0)+sm;
      }
      // KPIìš© ì •ì§€ì‹œê°„: PMè°ƒæ•´(å¤§åˆ†ç±») + åœæœº/å¼€æœº ì œì™¸ + æœ‰æ— åœæœº=åœ + col20 åœæœºæ—¶é—´
      var _kpiCat=(r[13]||'').toString().trim();
      var _kpiSub=(r[14]||'').toString().trim();
      if(_kpiCat==='PMè°ƒæ•´' && _stopYN==='åœ' && _kpiSub!=='åœæœº' && _kpiSub!=='å¼€æœº' && _kpiSub){
        var kpiSm=typeof r[20]==='number'?r[20]:(parseFloat(r[20])||0);
        if(kpiSm>0 && kpiSm<=1000){
          if(!kpiStopByDateEq[dateStr])kpiStopByDateEq[dateStr]={};
          kpiStopByDateEq[dateStr][eq]=(kpiStopByDateEq[dateStr][eq]||0)+kpiSm;
        }
      }
      // ê²€ì‚¬ê¸° ì „ìš©: ëª¨ë“  å¤§åˆ†ç±»ì˜ ê²€ì‚¬ê¸° í–‰ ìˆ˜ì§‘
      var cat=(r[13]||'').toString().trim();
      var _sub14=(r[14]||'').toString().trim();
      var _def18=parseFloat(r[18])||0;
      if(_sub14==='æ£€æŸ¥æœº'){
        var _dtP=dateStr.split('-');
        var _ds2=_dtP[1]+'/'+_dtP[2];
        var _kpiT2=(_stopYN==='åœ')?(typeof r[20]==='number'?r[20]:(parseFloat(r[20])||0)):0;
        var _detail2=(r[15]||'').toString().trim();
        inspAllRows.push({ds:_ds2,eq:eq,cat:cat,sub:_sub14,detail:_detail2,defect:_def18,kpiTime:_kpiT2,stop:_stopYN==='åœ',line:eq[0],dateStr:dateStr});
      }
      // allRows: PMè°ƒæ•´ í–‰ë§Œ
      if(cat!=='PMè°ƒæ•´')continue;
      var sub=_sub14;
      if(sub==='åœæœº'||sub==='å¼€æœº'||!sub)continue;
      var dtParts=dateStr.split('-');
      var ds=dtParts[1]+'/'+dtParts[2];
      var stopTime=parseFloat(r[11])||0, nonStopTime=parseFloat(r[12])||0;
      var time=Math.max(stopTime,nonStopTime);
      if(time>1000)continue;
      var defect=_def18;
      var kpiTime=(_stopYN==='åœ')?(typeof r[20]==='number'?r[20]:(parseFloat(r[20])||0)):0;
      var line=eq[0];
      var detail=(r[15]||'').toString().trim();
      allRows.push({ds:ds,eq:eq,sub:sub,detail:detail,defect:defect,time:time,kpiTime:kpiTime,stop:_stopYN==='åœ',line:line,dateStr:dateStr});
    }
  }
  // === æ—¥åˆ«æ±‡æ€»: ì´ë¦„ë§¤ì¹­ â†’ ë°”ë¡œ íŒŒì‹± ===
  // ì´ë¦„ ë§¤ì¹­ ì‹¤íŒ¨ ì‹œ col Bì— K1/K2/G/H/E/Total ìˆëŠ” ì‹œíŠ¸ íƒìƒ‰
  if(!_lossSheet){
    for(var fi=0;fi<wb.SheetNames.length;fi++){
      var fsn=wb.SheetNames[fi];
      if(_adjSheets.indexOf(fsn)>=0||_niboSheets.indexOf(fsn)>=0)continue;
      var fraw=XLSX.utils.sheet_to_json(wb.Sheets[fsn],{header:1,defval:null,raw:true,sheetRows:30});
      if(!fraw||fraw.length<6)continue;
      var fmc=0;for(var fc=1;fc<Math.min(fraw.length,30);fc++){var fv=(fraw[fc]&&fraw[fc][1]!=null)?(fraw[fc][1]||'').toString().trim():'';if(['K1','K2','G','H','E','Total'].indexOf(fv)>=0)fmc++;}
      if(fmc>=3){_lossSheet=fsn;break;}
    }
  }
  if(_lossSheet&&wb.Sheets[_lossSheet]){
    var rawX=XLSX.utils.sheet_to_json(wb.Sheets[_lossSheet],{header:1,defval:null,raw:true});
    _lossDbg.found=_lossSheet;
    // æ—¥åˆ«æ±‡æ€» í—¤ë”ì—ì„œ å®Œå…¨ä¸è‰¯%/å°ºå¯¸ä¸è‰¯% ì»¬ëŸ¼ ìë™ íƒìƒ‰
    var _colCD=-1,_colDD=-1;
    for(var _xhi=0;_xhi<Math.min(rawX.length,3);_xhi++){
      var _xhr=rawX[_xhi];if(!_xhr)continue;
      for(var _xci=0;_xci<_xhr.length;_xci++){
        var _xhv=(_xhr[_xci]!=null)?String(_xhr[_xci]).trim():'';
        if(_xhv.indexOf('å®Œå…¨ä¸è‰¯')>=0&&_xhv.indexOf('%')>=0&&_colCD<0)_colCD=_xci;
        if(_xhv.indexOf('å°ºå¯¸ä¸è‰¯')>=0&&_xhv.indexOf('%')>=0&&_colDD<0)_colDD=_xci;
      }
    }
    // %ê°€ í—¤ë”ì— ì—†ìœ¼ë©´ å®Œå…¨ä¸è‰¯/å°ºå¯¸ä¸è‰¯ ì°¾ê³ , ê°’>1ì´ë©´ ë‹¤ìŒì»¬ëŸ¼ì´ %
    if(_colCD<0||_colDD<0){
      for(var _xhi2=0;_xhi2<Math.min(rawX.length,3);_xhi2++){
        var _xhr2=rawX[_xhi2];if(!_xhr2)continue;
        for(var _xci2=0;_xci2<_xhr2.length;_xci2++){
          var _xhv2=(_xhr2[_xci2]!=null)?String(_xhr2[_xci2]).trim():'';
          if(_xhv2.indexOf('å®Œå…¨ä¸è‰¯')>=0&&_colCD<0)_colCD=_xci2;
          if(_xhv2.indexOf('å°ºå¯¸ä¸è‰¯')>=0&&_colDD<0)_colDD=_xci2;
        }
      }
      // ì°¾ì€ ì»¬ëŸ¼ ê°’ì´ í°ìˆ˜(ìˆ˜ëŸ‰)ì´ë©´ +1ì´ %ì¼ ê°€ëŠ¥ì„±
      for(var _dr=1;_dr<Math.min(rawX.length,10);_dr++){
        var _drv=rawX[_dr];if(!_drv||!_drv[1])continue;
        if(_colCD>=0&&typeof _drv[_colCD]==='number'&&_drv[_colCD]>1){_colCD++;break;}
        if(_colCD>=0)break;
      }
      for(var _dr2=1;_dr2<Math.min(rawX.length,10);_dr2++){
        var _drv2=rawX[_dr2];if(!_drv2||!_drv2[1])continue;
        if(_colDD>=0&&typeof _drv2[_colDD]==='number'&&_drv2[_colDD]>1){_colDD++;break;}
        if(_colDD>=0)break;
      }
    }
    console.log('[æ—¥åˆ«æ±‡æ€»] å®Œå…¨ä¸è‰¯% col='+_colCD+', å°ºå¯¸ä¸è‰¯% col='+_colDD);
    // í—¤ë”+ì²«ë°ì´í„° ë””ë²„ê·¸
    for(var _dhi=0;_dhi<Math.min(rawX.length,3);_dhi++){var _dhr=rawX[_dhi];if(!_dhr)continue;var _dhv=[];for(var _dci=0;_dci<Math.min(_dhr.length,40);_dci++)_dhv.push(_dci+':'+(_dhr[_dci]!=null?String(_dhr[_dci]).substring(0,15):''));console.log('[æ—¥åˆ«æ±‡æ€» row'+_dhi+'] '+_dhv.join(' | '));}
    var lastXDate=null;
    for(var xr=1;xr<rawX.length;xr++){
      var rx=rawX[xr];if(!rx)continue;
      if(rx[0]!=null){var ndx=parseStDate(rx[0]);if(ndx)lastXDate=ndx;else lastXDate=null;}
      if(!lastXDate)continue;
      var rline=(rx[1]||'').toString().trim();if(!rline)continue;
      if(_lossDbg.rows===0){_lossDbg.sample='date='+lastXDate+' line='+rline+' col6='+rx[6]+' col16='+rx[16];console.log('[æ—¥åˆ«æ±‡æ€» ì²«ë°ì´í„°] '+_lossDbg.sample);}
      if(_lossDbg.rows<6&&_colCD>=0){console.log('[æ—¥åˆ«æ±‡æ€» ê²€ì‚¬ê¸°] '+rline+': cd['+_colCD+']='+rx[_colCD]+' dd['+_colDD+']='+rx[_colDD]);}
      _lossDbg.rows++;
      var rprod=typeof rx[6]==='number'?rx[6]:(parseFloat(rx[6])||0);
      var rkpi=typeof rx[15]==='number'?rx[15]:(parseFloat(rx[15])||0);
      var rloss=typeof rx[16]==='number'?rx[16]:(parseFloat(rx[16])||0);
      var rutil=typeof rx[9]==='number'?rx[9]:(parseFloat(rx[9])||0);
      var rFullDef=_colCD>=0?(typeof rx[_colCD]==='number'?rx[_colCD]:(parseFloat(rx[_colCD])||0)):0;
      var rDimDef=_colDD>=0?(typeof rx[_colDD]==='number'?rx[_colDD]:(parseFloat(rx[_colDD])||0)):0;
      if(rloss>=1.0)continue;
      if(!lossByLineDate[lastXDate])lossByLineDate[lastXDate]={};
      lossByLineDate[lastXDate][rline]={r:rloss,p:rprod,u:rutil,cd:rFullDef,dd:rDimDef};
      if(!lossAccumByLine[rline])lossAccumByLine[rline]={prod:0,loss:0};
      lossAccumByLine[rline].prod+=rprod;lossAccumByLine[rline].loss+=rkpi;
    }
    // ê°€ë™ìœ¨ ë°ì´í„° ì¡´ì¬ í™•ì¸
    var _uCnt=0,_uSample='';
    Object.keys(lossByLineDate).forEach(function(dt){Object.keys(lossByLineDate[dt]).forEach(function(ln){if(lossByLineDate[dt][ln].u>0){_uCnt++;if(!_uSample)_uSample=dt+'/'+ln+'='+lossByLineDate[dt][ln].u;}});});
    console.log('[æ—¥åˆ«æ±‡æ€»] ê°€ë™ìœ¨ ë°ì´í„°: '+_uCnt+'ê±´, ìƒ˜í”Œ='+_uSample+', ë¼ì¸ëª©ë¡='+Object.keys(lossByLineDate[Object.keys(lossByLineDate)[0]]||{}).join(','));
  }
  lossDates=Object.keys(lossByLineDate).sort();
  if(allRows.length===0&&lossDates.length===0){alert(t('noDataFound'));return null}
  if(allRows.length===0){
    return {
      daily:[],daily_G:[],daily_H:[],daily_K:[],all_dates:[],eq_order:[],
      line_equips:{G:[],H:[],K:[]},hm_def:[],hm_time:[],allRows:[],
      totalRec:0,totalDef:0,totalTime:0,stopCnt:0,eqCnt:0,
      dateRange:t('noData'),lineSummary:{G:{cnt:0,eq:0},H:{cnt:0,eq:0},K:{cnt:0,eq:0}},
      prodByDateEq:{},stopByDateEq:{},kpiStopByDateEq:{},avgEqST:{},stDates:[],
      prodByWeekEq:{},stopByWeekEq:{},weekList:[],
      prodTotalEq:{},stopTotalEq:{},eqDates:{},eqWeekDates:{},
      lossByLineDate:lossByLineDate,lossAccumByLine:lossAccumByLine,lossDates:lossDates,
      lossDetailByDateEq:{},dataVersion:DATA_VERSION,_lossDbg:_lossDbg,
      _dbg:{sheets:_dbgAllSheets,matchedSheets:[],rows:0,dates:0,weeks:0,eqs:[]}
    };
  }

  // === ì‹œê°„ëŒ€ë¹„ë¶„ì„ ë°ì´í„° ===
  function parseStDate(v){
    if(!v)return'';
    if(v instanceof Date){
      var y=v.getFullYear(),m=v.getMonth()+1,d=v.getDate();
      return y+'-'+(m<10?'0'+m:m)+'-'+(d<10?'0'+d:d);
    }
    if(typeof v==='number'){
      var ms=Math.round((v-25569)*86400000);
      var dt=new Date(ms);
      var y2=dt.getUTCFullYear(),m2=dt.getUTCMonth()+1,d2=dt.getUTCDate();
      return y2+'-'+(m2<10?'0'+m2:m2)+'-'+(d2<10?'0'+d2:d2);
    }
    if(typeof v==='string'){
      var mt=v.match(/(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})/);
      if(mt)return mt[1]+'-'+mt[2].padStart(2,'0')+'-'+mt[3].padStart(2,'0');
      var mt2=v.match(/(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})/);
      if(mt2)return mt2[3]+'-'+mt2[1].padStart(2,'0')+'-'+mt2[2].padStart(2,'0');
    }
    return'';
  }
  var prodByDateEq={}, eqStRaw={}, dateToWeek={}, eqDates={}, eqWeekDates={};
  var lossDetailByDateEq={}; // ìƒì„¸ Lossìš© ì„¤ë¹„ë³„ ë°ì´í„° (10ê°œ í•­ëª©: PMì¡°ì •~í’ˆì§ˆìƒ˜í”Œ + ê¸°ìˆ ì¡°ì •)
  var LOSS_COL_COUNT=10; // ê³ ì • 10ê°œ í•­ëª©
  // æ—¥æŠ¥ í—¤ë”â†’ì¸ë±ìŠ¤ ë§¤í•‘ (9ê°œ í•­ëª©, ì´ë¦„ ê¸°ë°˜)
  var _lossColMap=[
    {names:['PMè°ƒæ•´','PMì¡°ì •','PMèª¿æ•´'],idx:0},
    {names:['å®Œå…¨ä¸è‰¯','ì™„ì „ë¶ˆëŸ‰'],idx:1},
    {names:['å·¥ç¨‹ä¸è‰¯','ê³µì •ë¶ˆëŸ‰'],idx:2},
    {names:['å°ºå¯¸ä¸è‰¯','ì¹˜ìˆ˜ë¶ˆëŸ‰'],idx:3},
    {names:['Leadæ›´æ¢','Leadêµì²´','LEADæ›´æ¢'],idx:4},
    {names:['Filmæ›´æ¢','Filmêµì²´','FILMæ›´æ¢'],idx:5},
    {names:['åœæœº','ì •ì§€','åœæ©Ÿ'],idx:6},
    {names:['åŸèµ„æ','ì›ìì¬','åŸè³‡æ','åŸèµ„æä¸è‰¯','ì›ìì¬ë¶ˆëŸ‰'],idx:7},
    {names:['å“è´¨æ ·å“','í’ˆì§ˆìƒ˜í”Œ','å“è³ªæ¨£å“'],idx:8}
  ];
  var _dbgSheets=[],_dbgRows=0; // ë””ë²„ê·¸ìš©
  for(var ni=0;ni<_niboSheets.length;ni++){
    var nsn=_niboSheets[ni];
    _dbgSheets.push(nsn);
    var raw2=XLSX.utils.sheet_to_json(wb.Sheets[nsn],{header:1,defval:null,raw:true});
    // ì „ì²´ í—¤ë” í–‰ì—ì„œ 9ê°œ í•­ëª©ì˜ ì»¬ëŸ¼ ìœ„ì¹˜ë¥¼ ì´ë¦„ìœ¼ë¡œ ì°¾ê¸°
    var _colIdx={}; // {ì‹¤ì œì»¬ëŸ¼ë²ˆí˜¸: larrì¸ë±ìŠ¤}
    var _foundCount=0;
    for(var hr=0;hr<Math.min(raw2.length,5);hr++){
      var hrow=raw2[hr];if(!hrow)continue;
      for(var hc=0;hc<hrow.length;hc++){
        var hv=(hrow[hc]!=null)?String(hrow[hc]).trim():'';
        if(!hv)continue;
        for(var mi=0;mi<_lossColMap.length;mi++){
          if(_colIdx[hc]!==undefined)continue; // ì´ë¯¸ ë§¤í•‘ë¨
          var alreadyMapped=false;for(var ck in _colIdx){if(_colIdx[ck]===_lossColMap[mi].idx){alreadyMapped=true;break;}}
          if(alreadyMapped)continue;
          for(var mn=0;mn<_lossColMap[mi].names.length;mn++){
            if(hv.indexOf(_lossColMap[mi].names[mn])>=0){_colIdx[hc]=_lossColMap[mi].idx;_foundCount++;break;}
          }
        }
      }
      if(_foundCount>=5)break; // ì¶©ë¶„íˆ ì°¾ìœ¼ë©´ ì¤‘ë‹¨
    }
    console.log('[æ—¥æŠ¥ '+nsn+'] ì»¬ëŸ¼ë§¤í•‘('+_foundCount+'ê°œ): '+Object.keys(_colIdx).map(function(c){return 'c'+c+'â†’idx'+_colIdx[c];}).join(', '));
    var lastDate2=null,lastWeek2=null;
    for(var j=2;j<raw2.length;j++){
      var rj=raw2[j]; if(!rj)continue;
      if(rj[3]!=null){var nd2=parseStDate(rj[3]);if(nd2)lastDate2=nd2;else lastDate2=null;}
      if(rj[2]!=null){var nw2=(rj[2]||'').toString().trim();if(nw2)lastWeek2=nw2;}
      if(!lastDate2||!rj[4])continue;
      var ds2=lastDate2;
      var eq2=(rj[4]||'').toString().trim().toUpperCase(); if(!eq2)continue;
      var prod2=typeof rj[11]==='number'?rj[11]:(parseFloat(rj[11])||0);
      var st2=typeof rj[12]==='number'?rj[12]:(parseFloat(rj[12])||0);
      var wk2=lastWeek2||'';
      if(!prodByDateEq[ds2])prodByDateEq[ds2]={};
      prodByDateEq[ds2][eq2]=(prodByDateEq[ds2][eq2]||0)+prod2;
      if(st2>0){if(!eqStRaw[eq2])eqStRaw[eq2]={s:0,n:0};eqStRaw[eq2].s+=st2;eqStRaw[eq2].n++}
      if(wk2&&!dateToWeek[ds2])dateToWeek[ds2]=wk2;
      if(!eqDates[eq2])eqDates[eq2]={};eqDates[eq2][ds2]=1;
      if(wk2){if(!eqWeekDates[wk2])eqWeekDates[wk2]={};if(!eqWeekDates[wk2][eq2])eqWeekDates[wk2][eq2]={};eqWeekDates[wk2][eq2][ds2]=1;}
      // ìƒì„¸ Loss: ì´ë¦„ ê¸°ë°˜ ë§¤í•‘ìœ¼ë¡œ 9ê°œ í•­ëª© ì±„ìš°ê¸°
      if(!lossDetailByDateEq[ds2])lossDetailByDateEq[ds2]={};
      if(!lossDetailByDateEq[ds2][eq2])lossDetailByDateEq[ds2][eq2]={prod:0,st:0,larr:new Array(LOSS_COL_COUNT).fill(0)};
      lossDetailByDateEq[ds2][eq2].prod+=prod2;
      if(st2>0)lossDetailByDateEq[ds2][eq2].st=st2;
      for(var ck2 in _colIdx){
        var ci2=parseInt(ck2),li2=_colIdx[ck2];
        var cv2=typeof rj[ci2]==='number'?rj[ci2]:(parseFloat(rj[ci2])||0);
        lossDetailByDateEq[ds2][eq2].larr[li2]+=cv2;
      }
      _dbgRows++;
    }
  }
  // === ê¸°ìˆ ì¡°ì •: LGè®¾å¤‡è°ƒè¯•(G,K) + Localè®¾å¤‡è°ƒè¯•(H,E) ì‹œíŠ¸ íŒŒì‹± ===
  var _techSheets=[];
  for(var tsi=0;tsi<wb.SheetNames.length;tsi++){
    var tsn=wb.SheetNames[tsi];
    if(tsn.indexOf('LGè®¾å¤‡è°ƒè¯•')>=0||tsn.indexOf('LGè¨­å‚™èª¿è©¦')>=0){_techSheets.push({name:tsn,lines:['G','K']});}
    else if(tsn.indexOf('Localè®¾å¤‡è°ƒè¯•')>=0||tsn.indexOf('LOCALè®¾å¤‡è°ƒè¯•')>=0||tsn.indexOf('Localè¨­å‚™èª¿è©¦')>=0){_techSheets.push({name:tsn,lines:['H','E']});}
  }
  var _techCnt=0;
  for(var ti=0;ti<_techSheets.length;ti++){
    var tSheet=_techSheets[ti];
    var rawT=XLSX.utils.sheet_to_json(wb.Sheets[tSheet.name],{header:1,defval:null,raw:true});
    if(!rawT||rawT.length<2)continue;
    for(var tr=1;tr<rawT.length;tr++){
      var trow=rawT[tr];if(!trow)continue;
      var tDate=parseStDate(trow[1]); // Bì—´=ë‚ ì§œ
      if(!tDate)continue;
      var tEqRaw=(trow[2]||'').toString().trim().toUpperCase(); // Cì—´=ì„¤ë¹„ëª…ì¹­
      if(!tEqRaw)continue;
      // ì„¤ë¹„ëª… ì •ê·œí™”: K14-1 â†’ K14, G13-2 â†’ G13
      var tEq=tEqRaw.replace(/-\d+$/,'');
      // ë¼ì¸ ì²´í¬: ì„¤ë¹„ ì²«ê¸€ìê°€ í•´ë‹¹ ì‹œíŠ¸ì˜ ë¼ì¸ì— í¬í•¨ë˜ëŠ”ì§€
      var tLine=tEq[0];
      if(tSheet.lines.indexOf(tLine)<0)continue;
      var tQty=typeof trow[8]==='number'?trow[8]:(parseFloat(trow[8])||0); // Iì—´=ë¶ˆëŸ‰ìˆ˜ëŸ‰
      if(tQty===0)continue;
      var tNote=(trow[9]!=null)?String(trow[9]).trim():''; // Jì—´=ë‚´ìš©(íŒì—…ìš©)
      if(!lossDetailByDateEq[tDate])lossDetailByDateEq[tDate]={};
      if(!lossDetailByDateEq[tDate][tEq])lossDetailByDateEq[tDate][tEq]={prod:0,st:0,larr:new Array(LOSS_COL_COUNT).fill(0)};
      lossDetailByDateEq[tDate][tEq].larr[9]+=tQty; // idx 9 = ê¸°ìˆ ì¡°ì •
      // ê¸°ìˆ ì¡°ì • ìƒì„¸ ë‚´ì—­ ì €ì¥ (íŒì—…ìš©)
      if(!lossDetailByDateEq[tDate][tEq].techNotes)lossDetailByDateEq[tDate][tEq].techNotes=[];
      lossDetailByDateEq[tDate][tEq].techNotes.push({sheet:tSheet.name,eq:tEqRaw,qty:tQty,note:tNote});
      _techCnt++;
    }
    console.log('[ê¸°ìˆ ì¡°ì • '+tSheet.name+'] ë¼ì¸='+tSheet.lines.join(',')+', í–‰ìˆ˜='+rawT.length);
  }
  console.log('[ê¸°ìˆ ì¡°ì •] ì´ '+_techCnt+'ê±´ ë§¤í•‘ì™„ë£Œ, ì‹œíŠ¸ìˆ˜='+_techSheets.length);
  var avgEqST={};
  Object.keys(eqStRaw).forEach(function(eq){if(eqStRaw[eq].n>0)avgEqST[eq]=eqStRaw[eq].s/eqStRaw[eq].n});
  var stDates=Object.keys(prodByDateEq).sort();
  // ë³‘í•©ì…€ë¡œ ëˆ„ë½ëœ ì£¼ì°¨ë¥¼ ISO ì£¼ì°¨ë¡œ ë³´ì™„
  (function(){
    function isoWeek(ds){
      var d=new Date(ds+'T00:00:00');
      if(isNaN(d.getTime()))return'';
      d.setDate(d.getDate()+3-(d.getDay()+6)%7);
      var w1=new Date(d.getFullYear(),0,4);
      return String(1+Math.round(((d.getTime()-w1.getTime())/86400000-3+(w1.getDay()+6)%7)/7));
    }
    Object.keys(prodByDateEq).forEach(function(dt){
      if(!dateToWeek[dt]){var w=isoWeek(dt);if(w)dateToWeek[dt]=w;}
    });
  })();
  // eqWeekDates ì¬êµ¬ì„± (dateToWeek ë³´ì™„ í›„)
  eqWeekDates={};
  Object.keys(prodByDateEq).forEach(function(dt){
    var wk=dateToWeek[dt]; if(!wk)return;
    Object.keys(prodByDateEq[dt]).forEach(function(eq){
      if(!eqWeekDates[wk])eqWeekDates[wk]={};
      if(!eqWeekDates[wk][eq])eqWeekDates[wk][eq]={};
      eqWeekDates[wk][eq][dt]=1;
    });
  });
  // ì£¼ì°¨ë³„/ëˆ„ì  ì§‘ê³„
  var prodByWeekEq={},stopByWeekEq={},prodTotalEq={},stopTotalEq={};
  Object.keys(prodByDateEq).forEach(function(dt){
    var wk=dateToWeek[dt];
    Object.keys(prodByDateEq[dt]).forEach(function(eq){
      var v=prodByDateEq[dt][eq];
      if(wk){if(!prodByWeekEq[wk])prodByWeekEq[wk]={};prodByWeekEq[wk][eq]=(prodByWeekEq[wk][eq]||0)+v;}
      prodTotalEq[eq]=(prodTotalEq[eq]||0)+v;
    });
  });
  Object.keys(stopByDateEq).forEach(function(dt){
    var wk=dateToWeek[dt];
    Object.keys(stopByDateEq[dt]).forEach(function(eq){
      var v=stopByDateEq[dt][eq];
      if(wk){if(!stopByWeekEq[wk])stopByWeekEq[wk]={};stopByWeekEq[wk][eq]=(stopByWeekEq[wk][eq]||0)+v;}
      stopTotalEq[eq]=(stopTotalEq[eq]||0)+v;
    });
  });
  var weekList=Object.keys(prodByWeekEq).sort(function(a,b){return+a-+b});
  var all_dates=[]; var dateSet={};
  for(var ai=0;ai<allRows.length;ai++){if(!dateSet[allRows[ai].ds]){dateSet[allRows[ai].ds]=1;all_dates.push(allRows[ai].ds)}}
  all_dates.sort();

  var eqCnt={};for(var bi=0;bi<allRows.length;bi++){eqCnt[allRows[bi].eq]=(eqCnt[allRows[bi].eq]||0)+1}
  var lineOrder={K:0,H:1,G:2};
  var eq_order=Object.keys(eqCnt).sort(function(a,b){var la=lineOrder[a[0]]!=null?lineOrder[a[0]]:9,lb=lineOrder[b[0]]!=null?lineOrder[b[0]]:9;if(la!==lb)return la-lb;return eqCnt[b]-eqCnt[a]});

  function buildDaily(rows){
    var m={};
    for(var di=0;di<rows.length;di++){
      var rr=rows[di];
      if(!m[rr.ds])m[rr.ds]={ì¼ìstr:rr.ds,cnt:0,defect:0,time:0,stop:0,_eqKpi:{}};
      m[rr.ds].cnt++;m[rr.ds].defect+=rr.defect;m[rr.ds].time+=rr.time;if(rr.stop)m[rr.ds].stop++;
      // KPI ë°©ì‹: åœì¸ í–‰ë§Œ, col20(kpiTime) ì‚¬ìš©, ì„¤ë¹„ë³„ ì§‘ê³„
      if(rr.stop&&rr.kpiTime>0){
        if(!m[rr.ds]._eqKpi[rr.eq])m[rr.ds]._eqKpi[rr.eq]=0;
        m[rr.ds]._eqKpi[rr.eq]+=rr.kpiTime;
      }
    }
    return all_dates.map(function(d){
      var r=m[d]||{ì¼ìstr:d,cnt:0,defect:0,time:0,stop:0,_eqKpi:{}};
      var eqs=Object.keys(r._eqKpi).filter(function(eq){return r._eqKpi[eq]>0});
      r.avgTime=eqs.length>0?eqs.reduce(function(s,eq){return s+r._eqKpi[eq]},0)/eqs.length:0;
      delete r._eqKpi;
      return r;
    });
  }
  var rowsByLine={G:[],H:[],K:[]};
  for(var ri=0;ri<allRows.length;ri++){var rl=allRows[ri].line;if(rowsByLine[rl])rowsByLine[rl].push(allRows[ri]);}
  var daily=buildDaily(allRows);
  var daily_G=buildDaily(rowsByLine.G);
  var daily_H=buildDaily(rowsByLine.H);
  var daily_K=buildDaily(rowsByLine.K);

  var hdMap={},htMap={};
  for(var hi=0;hi<allRows.length;hi++){var rh=allRows[hi];var k=rh.eq+'|'+rh.ds;hdMap[k]=(hdMap[k]||0)+rh.defect;if(rh.stop)htMap[k]=(htMap[k]||0)+rh.time}
  var hm_def=[],hm_time=[];
  for(var hk in hdMap){var sp=hk.split('|');hm_def.push({ì„¤ë¹„í˜¸:sp[0],ì¼ìstr:sp[1],ë¶ˆëŸ‰ìˆ˜ëŸ‰:hdMap[hk]})}
  for(var tk in htMap){var sp2=tk.split('|');hm_time.push({ì„¤ë¹„í˜¸:sp2[0],ì¼ìstr:sp2[1],time:htMap[tk]})}

  var line_equips={G:[],H:[],K:[]};
  for(var ei=0;ei<eq_order.length;ei++){var ln=eq_order[ei][0];if(line_equips[ln])line_equips[ln].push(eq_order[ei])}
  var lineSummary={};
  ['G','H','K'].forEach(function(ln){lineSummary[ln]={cnt:rowsByLine[ln].length,eq:line_equips[ln].length}});

  return {
    daily:daily,daily_G:daily_G,daily_H:daily_H,daily_K:daily_K,
    all_dates:all_dates,eq_order:eq_order,line_equips:line_equips,
    hm_def:hm_def,hm_time:hm_time,allRows:allRows,inspAllRows:inspAllRows,
    totalRec:allRows.length,totalDef:Math.round(allRows.reduce(function(s,r){return s+r.defect},0)),
    totalTime:Math.round(allRows.reduce(function(s,r){return s+r.time},0)),
    stopCnt:allRows.filter(function(r){return r.stop}).length,
    eqCnt:eq_order.length,
    dateRange:all_dates[0]+' ~ '+all_dates[all_dates.length-1],
    lineSummary:lineSummary,
    prodByDateEq:prodByDateEq,stopByDateEq:stopByDateEq,kpiStopByDateEq:kpiStopByDateEq,avgEqST:avgEqST,stDates:stDates,
    prodByWeekEq:prodByWeekEq,stopByWeekEq:stopByWeekEq,weekList:weekList,
    prodTotalEq:prodTotalEq,stopTotalEq:stopTotalEq,eqDates:eqDates,eqWeekDates:eqWeekDates,
    lossByLineDate:lossByLineDate,lossAccumByLine:lossAccumByLine,lossDates:lossDates,
    lossDetailByDateEq:lossDetailByDateEq,
    dataVersion:DATA_VERSION,_lossDbg:_lossDbg,
    _dbg:{sheets:_dbgAllSheets,matchedSheets:_dbgSheets,rows:_dbgRows,dates:Object.keys(prodByDateEq).length,weeks:weekList.length,eqs:Object.keys(prodTotalEq).filter(function(e){return(prodTotalEq[e]||0)>0})}
  };
}

function go(i){document.querySelectorAll('.pn').forEach(function(p,x){p.classList.toggle('on',x===i)});document.querySelectorAll('.tab').forEach(function(t,x){t.classList.toggle('on',x===i)});setTimeout(function(){var pn=document.querySelectorAll('.pn')[i];if(pn)pn.querySelectorAll('.hc').forEach(function(el){el.scrollLeft=el.scrollWidth;});},50);}

// === íˆíŠ¸ë§µ íŒ”ë ˆíŠ¸ ì‹œìŠ¤í…œ ===
var _warmPal=[
  {bg:'#FFFFFF',c:'#333'},{bg:'#FFF5D7',c:'#333'},
  {bg:'#FFE6B4',c:'#333'},{bg:'#FAC88C',c:'#333'},
  {bg:'#F59B3C',c:'#333',fw:1},{bg:'#E65523',c:'#fff',fw:1},
  {bg:'#C81914',c:'#fff',fw:1}
];
var HM_PALETTES={
  red:_warmPal,blue_red:_warmPal,orange_red:_warmPal,green_red:_warmPal,purple:_warmPal
};
// ì»¤ìŠ¤í…€ íŒ”ë ˆíŠ¸: í˜ì´ì§€ë³„ ë…ë¦½, localStorage ì €ì¥
var _defaultCustom=['#1e3a5f','#2563eb','#f97316','#ec4899','#ef4444','#dc2626','#991b1b'];
function _loadCustomPal(page){
  try{var s=localStorage.getItem('hmCustom_'+page);if(s)return JSON.parse(s);}catch(e){}
  return _defaultCustom.slice();
}
function _saveCustomPal(page,colors){localStorage.setItem('hmCustom_'+page,JSON.stringify(colors));}
function _hexToRgba(hex,a){var r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return'rgba('+r+','+g+','+b+','+a+')';}
function _brightness(hex){var r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);return(r*299+g*587+b*114)/1000;}
function _buildCustomPalette(colors){
  var alphas=[0.25,0.38,0.50,0.58,0.68,0.80,0.92];
  return colors.map(function(hex,i){var bright=_brightness(hex);var fc=bright*alphas[i]>128?'#1a1a1a':'#fff';return{bg:_hexToRgba(hex,alphas[i]),c:fc,fw:i>=4?1:0};});
}
var HM_PALETTE_NAMES={red:'ë¹¨ê°•',blue_red:'íŒŒë‘â†’ë¹¨ê°•',orange_red:'ì£¼í™©â†’ë¹¨ê°•',green_red:'ì´ˆë¡â†’ë¹¨ê°•',purple:'ë³´ë¼',custom:'ì»¤ìŠ¤í…€'};
// í˜ì´ì§€ë³„ ë…ë¦½ ì„¤ì •: def(ë¶ˆëŸ‰íˆíŠ¸ë§µ), stop(ì •ì§€íˆíŠ¸ë§µ), loss(LOSSìš”ì•½)
var _hmCfg={
  def:{pal:localStorage.getItem('hmPal_def')||'blue_red',axis:localStorage.getItem('hmAxis_def')||'all'},
  stop:{pal:localStorage.getItem('hmPal_stop')||'red',axis:localStorage.getItem('hmAxis_stop')||'all'},
  loss:{pal:localStorage.getItem('hmPal_loss')||'green_red',axis:localStorage.getItem('hmAxis_loss')||'all'}
};

function getHmStyle(v,mx,page){
  if(!v||v===0)return'';
  var cfg=_hmCfg[page||'def']||_hmCfg.def;
  var pal=cfg.pal==='custom'?_buildCustomPalette(_loadCustomPal(page||'def')):(HM_PALETTES[cfg.pal]||HM_PALETTES.red);
  var r=v/mx;
  var idx=r<.08?0:r<.16?1:r<.28?2:r<.42?3:r<.58?4:r<.75?5:6;
  var s=pal[idx];
  return'background:'+s.bg+';color:'+s.c+(s.fw?';font-weight:700':'');
}

function buildHmLegend(page){
  var cfg=_hmCfg[page||'def']||_hmCfg.def;
  var pal=cfg.pal==='custom'?_buildCustomPalette(_loadCustomPal(page||'def')):(HM_PALETTES[cfg.pal]||HM_PALETTES.red);
  var h='<div class="lg"><div class="li"><div class="lc" style="background:#fff;border:1px solid #333"></div>0</div>';
  for(var i=0;i<7;i++){h+='<div class="li"><div class="lc" style="background:'+pal[i].bg+'"></div>'+(i+1)+'</div>';}
  return h+'</div>';
}

function buildHmSettings(page){
  var cfg=_hmCfg[page]||_hmCfg.def;
  var ss='font-size:11px;padding:3px 8px;border-radius:4px;border:1px solid #333;cursor:pointer;';
  var h='<span style="color:#666;font-size:11px;font-weight:700">ê¸°ì¤€</span>';
  [{k:'all',l:'ì „ì²´'},{k:'row',l:'ì„¸ë¡œ'},{k:'col',l:'ê°€ë¡œ'}].forEach(function(o){
    var on=o.k===cfg.axis;
    h+='<button onclick="setHmAxis(\''+page+'\',\''+o.k+'\')" style="'+ss+'background:'+(on?'#3b82f6':'#f0f0f0')+';color:'+(on?'#fff':'#666')+'">'+o.l+'</button>';
  });
  return h;
}

function setHmPalette(page,p){_hmCfg[page].pal=p;localStorage.setItem('hmPal_'+page,p);refreshPage(page);}
function setHmAxis(page,a){_hmCfg[page].axis=a;localStorage.setItem('hmAxis_'+page,a);refreshPage(page);}
function setCustomColor(page,idx,color){var cols=_loadCustomPal(page);cols[idx]=color;_saveCustomPal(page,cols);refreshPage(page);}
function resetCustomPal(page){localStorage.removeItem('hmCustom_'+page);refreshPage(page);}

function refreshPage(page){
  if(!D)return;
  if(page==='def'){
    var el=document.getElementById('hm_def');
    var st=document.getElementById('hm_def_settings');
    if(el)el.innerHTML=buildDailyHT(D.hm_def,'ë¶ˆëŸ‰ìˆ˜ëŸ‰',D.eq_order,D.all_dates,false,'def');
    if(st)st.innerHTML=buildHmSettings('def');
  } else if(page==='stop'){
    var el2=document.getElementById('hm_time');
    var st2=document.getElementById('hm_time_settings');
    if(el2){
      var _htStop={};
      (D.allRows||[]).forEach(function(rh){if(rh.stop){var k=rh.eq+'|'+rh.ds;_htStop[k]=(_htStop[k]||0)+rh.time}});
      var _hmTF=[];for(var _tk in _htStop){var _sp=_tk.split('|');_hmTF.push({ì„¤ë¹„í˜¸:_sp[0],ì¼ìstr:_sp[1],time:_htStop[_tk]})}
      el2.innerHTML=buildDailyHT(_hmTF,'time',D.eq_order,D.all_dates,true,'stop');
    }
    if(st2)st2.innerHTML=buildHmSettings('stop');
  } else if(page==='loss'){
    var lp=document.getElementById('lossPanel');
    if(lp){lp.innerHTML=buildLossPage();}
  }
}

function buildDailyHT(data,vk,equips,dates,isAvg,page){
  var pg=page||'def';
  var cfg=_hmCfg[pg]||_hmCfg.def;
  var lk={},mx=0;
  for(var i=0;i<data.length;i++){var r=data[i];var k=r['ì„¤ë¹„í˜¸']+'|'+r['ì¼ìstr'];var v=r[vk]||0;lk[k]=v;if(v>mx)mx=v}
  var lo={K:0,H:1,G:2};
  var et=equips.map(function(e){return{e:e,t:dates.reduce(function(s,d){return s+(lk[e+'|'+d]||0)},0)}}).sort(function(a,b){var la=lo[a.e[0]]!=null?lo[a.e[0]]:9,lb=lo[b.e[0]]!=null?lo[b.e[0]]:9;if(la!==lb)return la-lb;return b.t-a.t}).map(function(x){return x.e});
  // ê¸°ì¤€ë³„ max ê³„ì‚° (ì „ì²´maxì˜ 30%ë¥¼ í•˜í•œìœ¼ë¡œ)
  var rowMx={},colMx={},hmFloor=(mx||1)*0.3;
  if(cfg.axis==='row'){et.forEach(function(eq){var rm=0;dates.forEach(function(d){var v=lk[eq+'|'+d]||0;if(v>rm)rm=v});rowMx[eq]=Math.max(rm,hmFloor)||1})}
  if(cfg.axis==='col'){dates.forEach(function(d){var cm=0;et.forEach(function(eq){var v=lk[eq+'|'+d]||0;if(v>cm)cm=v});colMx[d]=Math.max(cm,hmFloor)||1})}
  function getMx(eq,d){if(cfg.axis==='row')return rowMx[eq]||1;if(cfg.axis==='col')return colMx[d]||1;return mx||1}
  var h='<table class="ht"><thead><tr><th>'+t('eqDate')+'</th>';
  dates.forEach(function(d){h+='<th>'+d+'</th>'});
  var sumLabel=isAvg?t('hmAvg'):t('total');
  h+='<th style="background:#1a1a1a;color:#e2e8f0;font-weight:700">'+sumLabel+'</th></tr></thead><tbody>';
  var sortField=vk==='time'?'time':'defect';
  et.forEach(function(eq){h+='<tr><th>'+eq+'</th>';var rs=0,rn=0;dates.forEach(function(d){var v=lk[eq+'|'+d]||0;rs+=v;if(v>0)rn++;
    if(v){h+='<td style="'+getHmStyle(v,getMx(eq,d),pg)+'" class="hm-click" onclick="showDetail(\''+eq+'\',\''+d+'\',\''+sortField+'\')">'+Math.round(v).toLocaleString()+'</td>'}
    else{h+='<td class="h0"></td>'}
  });var rowVal=isAvg&&rn>0?rs/rn:rs;h+='<td style="background:#1a1a1a;font-weight:700;color:#e2e8f0">'+Math.round(rowVal).toLocaleString()+'</td></tr>'});
  h+='<tr><th style="background:#1a1a1a;color:#e2e8f0;font-weight:700">'+sumLabel+'</th>';var gt=0,gn=0;
  dates.forEach(function(d){var cs=0,cn=0;et.forEach(function(e){var v=lk[e+'|'+d]||0;cs+=v;if(v>0)cn++;});var colVal=isAvg&&cn>0?cs/cn:cs;gt+=colVal;gn++;h+='<td style="background:#1a1a1a;font-weight:700;color:#e2e8f0">'+Math.round(colVal).toLocaleString()+'</td>'});
  h+='<td style="background:#2a2a2a;font-weight:700;color:#e2e8f0">'+Math.round(isAvg&&gn>0?gt/gn:gt).toLocaleString()+'</td></tr></tbody></table>';
  return h;
}

function showDetail(eq,date,sortBy){
  var rows=(D.allRows||[]).filter(function(r){return r.eq===eq&&r.ds===date&&(sortBy!=='time'||r.stop)});
  if(!rows.length){closeModal();return}
  rows.sort(function(a,b){return b[sortBy]-a[sortBy]});
  var totalAll=rows.length;
  var top10=rows.slice(0,10);
  var totalDef=top10.reduce(function(s,r){return s+r.defect},0);
  var totalTime=top10.reduce(function(s,r){return s+r.time},0);
  var label=sortBy==='defect'?t('sortDefect'):t('sortTime');
  document.getElementById('modalTitle').textContent=eq+' Â· '+date+' '+t('worst10Title')+' ('+label+' , '+t('allOf')+' '+totalAll+t('items')+' '+t('topOf')+' '+top10.length+t('items')+')';
  var tb='<table><thead><tr>'+t('worst10Hdr').map(function(h){return'<th>'+h+'</th>'}).join('')+'</tr></thead><tbody>';
  top10.forEach(function(r,i){
    var defCls=sortBy==='defect'&&i===0?' class="highlight"':'';
    var timeCls=sortBy==='time'&&i===0?' class="highlight"':'';
    tb+='<tr><td>'+(i+1)+'</td><td>'+r.sub+'</td><td>'+(r.detail||'-')+'</td><td'+defCls+'>'+Math.round(r.defect).toLocaleString()+'</td><td'+timeCls+'>'+Math.round(r.time).toLocaleString()+'</td><td>'+(r.stop?'â›”':'')+'</td></tr>';
  });
  tb+='<tr style="background:#1a1a1a;font-weight:700"><td></td><td>'+t('worst10Sum')+'</td><td></td><td>'+Math.round(totalDef).toLocaleString()+'</td><td>'+Math.round(totalTime).toLocaleString()+'</td><td></td></tr>';
  tb+='</tbody></table>';
  document.getElementById('modalBody').innerHTML=tb;
  document.getElementById('modalOverlay').classList.add('show');
}
function closeModal(){document.getElementById('modalOverlay').classList.remove('show')}

function _ovPopDt(){var dates=D.lossDates||[];return _ovSumDate&&dates.indexOf(_ovSumDate)>=0?_ovSumDate:dates[dates.length-1];}
function _ovMl(eq,ln){if(!ln)return true;if(ln==='K')return eq[0]==='K';return eq[0]===ln;}
var _ovPopRa='text-align:right';
var _ovPop1Type='',_ovPop1Line=null;

function showOvSumPopup(type,line){
  if(!D)return;var dt=_ovPopDt();if(!dt)return;
  _ovPop1Type=type;_ovPop1Line=line;
  var title='',tb='',lineLbl=line||'Total',ra=_ovPopRa;
  var cs='cursor:pointer';

  if(type==='loss'||type==='pmLoss'){
    title=(type==='loss'?'ìƒì„¸ Loss í˜„í™©':'PMì¡°ì • Loss í˜„í™©')+' ('+lineLbl+' Â· '+dt+')';
    var dateData=D.lossDetailByDateEq[dt]||{};
    var eqList=Object.keys(dateData).filter(function(eq){
      if(!_ovMl(eq,line))return false;
      var d=dateData[eq];return d.prod>0||d.larr.some(function(v){return v>0;});
    }).sort(function(a,b){
      var da=dateData[a],db=dateData[b];
      var la=da.prod>0?da.larr.reduce(function(s,v){return s+v},0)/da.prod:0;
      var lb=db.prod>0?db.larr.reduce(function(s,v){return s+v},0)/db.prod:0;
      return lb-la;
    });
    // buildLossDetailê³¼ ë™ì¼í•œ ìŠ¤íƒ€ì¼
    var thS='background:#1a1a1a;color:#e2e8f0;padding:5px 8px;font-size:11px;border:1px solid #333;white-space:nowrap;text-align:center';
    var tdS='padding:4px 8px;font-size:11px;border:1px solid #333;text-align:center;white-space:nowrap;background:#000;color:#cbd5e1';
    var stkL='position:sticky;left:0;z-index:1;';
    var _hdr=t('lossDetailHdr');var _nCols=_hdr.length;
    // íˆíŠ¸ë§µ max ê³„ì‚°
    var dtlCfg=_hmCfg.loss||{pal:'green_red',axis:'all'};
    var eqVals={},allDtlMx=0,colMaxLoss=0,colMaxArr=new Array(_nCols).fill(0);
    eqList.forEach(function(eq){
      var d=dateData[eq],prod=d.prod||0;
      var lossSum=0;d.larr.forEach(function(v){lossSum+=v;});
      var lossR=prod>0?lossSum/prod:0;
      if(lossR>colMaxLoss)colMaxLoss=lossR;if(lossR>allDtlMx)allDtlMx=lossR;
      var pcts=d.larr.map(function(v,i){var p=prod>0&&v>0?v/prod:0;if(p>colMaxArr[i])colMaxArr[i]=p;if(p>allDtlMx)allDtlMx=p;return p;});
      eqVals[eq]={lossR:lossR,pcts:pcts};
    });
    var dtlFloor=(allDtlMx||0.001)*0.3;
    var dtlRowMx={},dtlColMx={};
    if(dtlCfg.axis==='row'){eqList.forEach(function(eq){var rm=eqVals[eq].lossR;eqVals[eq].pcts.forEach(function(p){if(p>rm)rm=p});dtlRowMx[eq]=Math.max(rm,dtlFloor)||0.001})}
    if(dtlCfg.axis==='col'){dtlColMx['_loss']=Math.max(colMaxLoss,dtlFloor)||0.001;for(var ci=0;ci<_nCols;ci++)dtlColMx[ci]=Math.max(colMaxArr[ci],dtlFloor)||0.001}
    function getDtlMx(eq,colIdx){if(dtlCfg.axis==='row')return dtlRowMx[eq]||(allDtlMx||0.001);if(dtlCfg.axis==='col')return dtlColMx[colIdx]||0.001;return allDtlMx||0.001}
    // í…Œì´ë¸” ë Œë”ë§
    tb='<div style="overflow-x:auto;-webkit-overflow-scrolling:touch">';
    tb+='<table style="border-collapse:collapse;min-width:max-content"><thead><tr>';
    tb+='<th style="'+thS+';'+stkL+'background:#1a1a1a;min-width:56px">'+t('equip')+'</th>';
    tb+='<th style="'+thS+'">'+t('plan')+'</th><th style="'+thS+'">'+t('prod')+'</th><th style="'+thS+'">'+t('utilRate')+'</th><th style="'+thS+'">'+t('lossRate')+'</th>';
    _hdr.forEach(function(c){tb+='<th style="'+thS+'">'+c+'</th>';});
    tb+='</tr></thead><tbody>';
    var totProd=0,totCapa=0,totLarr=new Array(_nCols).fill(0);
    eqList.forEach(function(eq){
      var d=dateData[eq];var prod=d.prod||0;
      var stA=getSTActual(eq)||(d.st>0?d.st:0);
      var capa=stA>0?Math.round(86400/stA):0;
      var util=capa>0?prod/capa:0;
      var ev=eqVals[eq];totProd+=prod;totCapa+=capa;
      tb+='<tr style="'+cs+'" onclick="showOvSumDetail2(\''+eq+'\')">';
      tb+='<td style="'+tdS+';'+stkL+'background:#1a1a1a;color:#60a5fa;font-weight:700;min-width:56px;text-decoration:underline">'+eq+'</td>';
      tb+='<td style="'+tdS+'">'+capa.toLocaleString()+'</td>';
      tb+='<td style="'+tdS+'">'+Math.round(prod).toLocaleString()+'</td>';
      tb+='<td style="'+tdS+';color:'+(util>=0.9?'#22c55e':util>=0.7?'#f59e0b':'#ef4444')+'">'+(util>0?(util*100).toFixed(1)+'%':'-')+'</td>';
      tb+='<td style="'+tdS+';'+getHmStyle(ev.lossR,getDtlMx(eq,'_loss'),'loss')+'">'+fmtLoss(ev.lossR)+'</td>';
      d.larr.forEach(function(v,i){
        totLarr[i]+=v;var pct=ev.pcts[i];
        var cellTxt;
        if(i===9&&v>0&&prod===0){cellTxt=Math.round(v).toLocaleString();}
        else{cellTxt=pct>0?(pct*100).toFixed(2)+'%':'-';}
        var sty=getHmStyle(pct,getDtlMx(eq,i),'loss');
        tb+='<td style="'+tdS+';'+sty+'">'+cellTxt+'</td>';
      });
      tb+='</tr>';
    });
    // Total í–‰
    var totUtil=totCapa>0?totProd/totCapa:0;
    var totLossSum=0;totLarr.forEach(function(v){totLossSum+=v;});
    var totLoss=totProd>0?totLossSum/totProd:0;
    tb+='<tr style="background:#1a1a1a;font-weight:700">';
    tb+='<td style="'+tdS+';'+stkL+'background:#1a1a1a;color:#e2e8f0;min-width:56px">'+t('total')+'</td>';
    tb+='<td style="'+tdS+'">'+totCapa.toLocaleString()+'</td>';
    tb+='<td style="'+tdS+'">'+Math.round(totProd).toLocaleString()+'</td>';
    tb+='<td style="'+tdS+';color:'+(totUtil>=0.9?'#22c55e':totUtil>=0.7?'#f59e0b':'#ef4444')+'">'+(totUtil>0?(totUtil*100).toFixed(1)+'%':'-')+'</td>';
    tb+='<td style="'+tdS+';'+getHmStyle(totLoss,getDtlMx('_total','_loss'),'loss')+'">'+fmtLoss(totLoss)+'</td>';
    totLarr.forEach(function(v,i){
      var pct=totProd>0&&v>0?v/totProd:0;
      var cellTxt=pct>0?(pct*100).toFixed(2)+'%':'-';
      tb+='<td style="'+tdS+';'+getHmStyle(pct,getDtlMx('_total',i),'loss')+'">'+cellTxt+'</td>';
    });
    tb+='</tr>';
    tb+='</tbody></table></div>';
    tb+='<p style="color:#94a3b8;font-size:10px;margin-top:8px">ì„¤ë¹„ í´ë¦­ â†’ ì¡°ì •ì´ë ¥ ìƒì„¸</p>';
  }
  else if(type==='pmStop'){
    title='PMì¡°ì • ì •ì§€ ìƒì„¸ ('+lineLbl+' Â· '+dt+')';
    var rows=(D.allRows||[]).filter(function(r){return r.dateStr===dt&&_ovMl(r.eq,line)&&r.stop;});
    rows.sort(function(a,b){return(b.kpiTime||0)-(a.kpiTime||0);});
    var tmMax=0;rows.forEach(function(r){if((r.kpiTime||0)>tmMax)tmMax=r.kpiTime;});
    tb='<div style="overflow-x:auto"><table style="border-collapse:collapse;width:100%;font-size:12px"><thead><tr><th>#</th><th>ì„¤ë¹„</th><th>ì†Œë¶„ë¥˜</th><th>ë‚´ìš©</th><th style="'+ra+'">ì •ì§€(ë¶„)</th></tr></thead><tbody>';
    var total=0;rows.forEach(function(r,i){total+=r.kpiTime||0;
      tb+='<tr><td>'+(i+1)+'</td><td>'+r.eq+'</td><td>'+(r.sub||'')+'</td><td>'+(r.detail||'')+'</td><td style="'+ra+';'+getHmStyle(r.kpiTime||0,tmMax,'loss')+'">'+Math.round(r.kpiTime||0)+'</td></tr>';
    });
    tb+='<tr style="font-weight:700;border-top:2px solid #3b82f6"><td></td><td colspan="3">í•©ê³„ ('+rows.length+'ê±´)</td><td style="'+ra+'">'+Math.round(total)+'ë¶„</td></tr>';
    tb+='<tr style="color:#f59e0b"><td></td><td colspan="3">í‰ê·  ('+rows.length+'ëŒ€)</td><td style="'+ra+'">'+(rows.length>0?Math.round(total/rows.length):0)+'ë¶„</td></tr></tbody></table></div>';
  }
  else if(type==='fullDef'){
    title='ì™„ì „ë¶ˆëŸ‰ Worst ('+lineLbl+' Â· '+dt+')';
    var dd2=D.lossDetailByDateEq[dt]||{};
    var eqs=Object.keys(dd2).filter(function(eq){if(!_ovMl(eq,line))return false;var li=eq[0]==='H'?3:1;return dd2[eq].larr[li]>0;});
    eqs.sort(function(a,b){var la=a[0]==='H'?3:1;var lb=b[0]==='H'?3:1;return dd2[b].larr[lb]-dd2[a].larr[la];});
    var defMax=0;eqs.forEach(function(eq){var d=dd2[eq];var li=eq[0]==='H'?3:1;var pv=d.prod>0?d.larr[li]/d.prod*100:0;if(pv>defMax)defMax=pv;});
    tb='<div style="overflow-x:auto"><table style="border-collapse:collapse;width:100%;font-size:12px"><thead><tr><th>#</th><th>ì„¤ë¹„</th><th style="'+ra+'">ë¶ˆëŸ‰ìˆ˜ëŸ‰</th><th style="'+ra+'">ìƒì‚°</th><th style="'+ra+'">ë¶ˆëŸ‰ìœ¨</th></tr></thead><tbody>';
    eqs.forEach(function(eq,i){var d=dd2[eq];var li=eq[0]==='H'?3:1;var pv=d.prod>0?d.larr[li]/d.prod*100:0;
      tb+='<tr style="'+cs+'" onclick="showOvSumDetail2(\''+eq+'\')">';
      tb+='<td>'+(i+1)+'</td><td style="color:#60a5fa;text-decoration:underline">'+eq+'</td><td style="'+ra+'">'+Math.round(d.larr[li]).toLocaleString()+'</td><td style="'+ra+'">'+Math.round(d.prod).toLocaleString()+'</td><td style="'+ra+';'+getHmStyle(pv,defMax,'loss')+'">'+(pv>0?pv.toFixed(2):'0')+'%</td></tr>';
    });
    tb+='</tbody></table></div>';
    tb+='<p style="color:#94a3b8;font-size:10px;margin-top:8px">ì„¤ë¹„ í´ë¦­ â†’ ì¡°ì •ì´ë ¥ ìƒì„¸</p>';
  }
  else if(type==='inspStop'){
    title='ê²€ì‚¬ê¸° ì •ì§€ ìƒì„¸ ('+lineLbl+' Â· '+dt+')';
    var rows=(D.inspAllRows||[]).filter(function(r){return r.dateStr===dt&&_ovMl(r.eq,line)&&r.stop;});
    rows.sort(function(a,b){return(b.kpiTime||0)-(a.kpiTime||0);});
    var tmMax=0;rows.forEach(function(r){if((r.kpiTime||0)>tmMax)tmMax=r.kpiTime;});
    tb='<div style="overflow-x:auto"><table style="border-collapse:collapse;width:100%;font-size:12px"><thead><tr><th>#</th><th>ì„¤ë¹„</th><th>ë¶„ë¥˜</th><th>ë‚´ìš©</th><th style="'+ra+'">ì •ì§€(ë¶„)</th></tr></thead><tbody>';
    var total=0;rows.forEach(function(r,i){total+=r.kpiTime||0;tb+='<tr><td>'+(i+1)+'</td><td>'+r.eq+'</td><td>'+(r.cat||'')+'</td><td>'+(r.detail||'')+'</td><td style="'+ra+';'+getHmStyle(r.kpiTime||0,tmMax,'loss')+'">'+Math.round(r.kpiTime||0)+'</td></tr>';});
    tb+='<tr style="font-weight:700;border-top:2px solid #3b82f6"><td></td><td colspan="3">í•©ê³„ ('+rows.length+'ê±´)</td><td style="'+ra+'">'+Math.round(total)+'ë¶„</td></tr></tbody></table></div>';
  }
  else if(type==='tech'){
    title='ê¸°ìˆ ì¡°ì • ìƒì„¸ ('+lineLbl+' Â· '+dt+')';
    var dd=D.lossDetailByDateEq[dt]||{};
    var eqs=Object.keys(dd).filter(function(eq){return _ovMl(eq,line)&&dd[eq].larr[9]>0;});
    eqs.sort(function(a,b){return dd[b].larr[9]-dd[a].larr[9];});
    var qtyMax=0;eqs.forEach(function(eq){var d=dd[eq];var notes=d.techNotes||[];if(notes.length>0)notes.forEach(function(n){if(n.qty>qtyMax)qtyMax=n.qty;});else if(d.larr[9]>qtyMax)qtyMax=d.larr[9];});
    tb='<div style="overflow-x:auto"><table style="border-collapse:collapse;width:100%;font-size:12px"><thead><tr><th>#</th><th>ì„¤ë¹„</th><th style="'+ra+'">ìˆ˜ëŸ‰</th><th>ë‚´ìš©</th></tr></thead><tbody>';
    var total=0,idx=0;
    eqs.forEach(function(eq){var d=dd[eq];var notes=d.techNotes||[];
      if(notes.length>0){notes.forEach(function(n){idx++;total+=n.qty;tb+='<tr><td>'+idx+'</td><td>'+n.eq+'</td><td style="'+ra+';'+getHmStyle(n.qty,qtyMax,'loss')+'">'+Math.round(n.qty)+'</td><td>'+n.note+'</td></tr>';});}
      else{idx++;total+=d.larr[9];tb+='<tr><td>'+idx+'</td><td>'+eq+'</td><td style="'+ra+';'+getHmStyle(d.larr[9],qtyMax,'loss')+'">'+Math.round(d.larr[9])+'</td><td></td></tr>';}
    });
    tb+='<tr style="font-weight:700;border-top:2px solid #3b82f6"><td></td><td>í•©ê³„</td><td style="'+ra+'">'+Math.round(total)+'ea</td><td></td></tr></tbody></table></div>';
  }
  document.getElementById('modalTitle').textContent=title;
  document.getElementById('modalBody').innerHTML=tb;
  document.getElementById('modalOverlay').classList.add('show');
}

function showOvSumDetail2(eq){
  if(!D)return;var dt=_ovPopDt();if(!dt)return;
  var ra=_ovPopRa;var type=_ovPop1Type;var line=_ovPop1Line;
  var back='<div style="margin-bottom:10px"><span onclick="showOvSumPopup(\''+type+'\','+(line?"'"+line+"'":'null')+')" style="cursor:pointer;color:#60a5fa;font-size:12px">&larr; ëª©ë¡ìœ¼ë¡œ</span></div>';
  var title=eq+' ì¡°ì •ì´ë ¥ ('+dt+')';
  var rows=(D.allRows||[]).filter(function(r){return r.dateStr===dt&&r.eq===eq;});
  rows.sort(function(a,b){return(b.time||0)-(a.time||0);});
  var defMax=0,tmMax=0;rows.forEach(function(r){if((r.defect||0)>defMax)defMax=r.defect;if((r.time||0)>tmMax)tmMax=r.time;});
  var tb=back+'<div style="overflow-x:auto"><table style="border-collapse:collapse;width:100%;font-size:12px"><thead><tr><th>#</th><th>ì†Œë¶„ë¥˜</th><th>ë‚´ìš©</th><th style="'+ra+'">ë¶ˆëŸ‰ìˆ˜ëŸ‰</th><th style="'+ra+'">ì •ì§€ì‹œê°„</th><th>ì •ì§€</th></tr></thead><tbody>';
  var tDef=0,tTime=0;
  rows.forEach(function(r,i){tDef+=r.defect||0;tTime+=r.time||0;
    tb+='<tr><td>'+(i+1)+'</td><td>'+(r.sub||'')+'</td><td>'+(r.detail||'')+'</td><td style="'+ra+';'+getHmStyle(r.defect||0,defMax,'loss')+'">'+Math.round(r.defect||0).toLocaleString()+'</td><td style="'+ra+';'+getHmStyle(r.time||0,tmMax,'loss')+'">'+Math.round(r.time||0)+'</td><td>'+(r.stop?'â›”':'')+'</td></tr>';
  });
  tb+='<tr style="font-weight:700;border-top:2px solid #3b82f6"><td></td><td colspan="2">í•©ê³„ ('+rows.length+'ê±´)</td><td style="'+ra+'">'+Math.round(tDef).toLocaleString()+'</td><td style="'+ra+'">'+Math.round(tTime)+'</td><td></td></tr></tbody></table></div>';
  document.getElementById('modalTitle').textContent=title;
  document.getElementById('modalBody').innerHTML=tb;
}

function showKpiDetail(datesArr,line){
  var dts=datesArr;
  var lineLbl=line?line+' Line':'ì „ì²´';
  var rows=[];
  dts.forEach(function(dt){
    var fd=null;
    if(D.allRows){D.allRows.some(function(r){if(r.ds===dt&&r.dateStr){fd=r.dateStr;return true}});}
    if(!fd){var kk=Object.keys(D.kpiStopByDateEq||{});kk.some(function(f){var p=f.split('-');if(p.length===3&&p[1]+'/'+p[2]===dt){fd=f;return true}});}
    if(!fd)return;
    var stops=(D.kpiStopByDateEq||{})[fd];if(!stops)return;
    Object.keys(stops).forEach(function(eq){
      if(line&&eq[0]!==line)return;
      if(stops[eq]>0)rows.push({date:dt,eq:eq,time:stops[eq]});
    });
  });
  rows.sort(function(a,b){return a.date===b.date?b.time-a.time:a.date>b.date?1:-1});
  var period=dts.length===1?dts[0]:(dts[0]+' ~ '+dts[dts.length-1]);
  document.getElementById('modalTitle').textContent='KPI ì •ì§€ì‹œê°„ ìƒì„¸ - '+lineLbl+' ('+period+')';
  var tb='<table><thead><tr><th>ì¼ì</th><th>ì„¤ë¹„</th><th>ì •ì§€ì‹œê°„(ë¶„)</th></tr></thead><tbody>';
  var totalTime=0;
  rows.forEach(function(r){
    totalTime+=r.time;
    tb+='<tr><td>'+r.date+'</td><td>'+r.eq+'</td><td>'+Math.round(r.time)+'</td></tr>';
  });
  tb+='<tr style="background:#1a1a1a;font-weight:700"><td colspan="2">í•©ê³„ ('+rows.length+'ê±´)</td><td>'+Math.round(totalTime)+'</td></tr>';
  tb+='</tbody></table>';
  if(!rows.length)tb='<p style="color:#94a3b8;padding:12px">í•´ë‹¹ ê¸°ê°„ ì •ì§€ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
  document.getElementById('modalBody').innerHTML=tb;
  document.getElementById('modalOverlay').classList.add('show');
}

function showEqHeatmap(eq){
  if(!D||!D.allRows||!D.all_dates)return;
  var dates=D.all_dates;
  var recentDates=dates.slice(Math.max(0,dates.length-14));
  // Build daily data for this equipment
  var dayTime={},dayDef={},mxT=0,mxD=0;
  recentDates.forEach(function(d){
    var rows=D.allRows.filter(function(r){return r.eq===eq&&r.ds===d});
    var t=rows.reduce(function(s,r){return s+r.time},0);
    var df=rows.reduce(function(s,r){return s+r.defect},0);
    dayTime[d]=t;dayDef[d]=df;
    if(t>mxT)mxT=t;if(df>mxD)mxD=df;
  });

  document.getElementById('modalTitle').textContent=eq+' '+t('eqHmTitle')+' ('+t('eqHmDays')+' '+recentDates.length+t('eqHmDaysSuffix')+')';
  var hm='<div style="overflow-x:auto">';
  hm+='<table style="border-collapse:collapse;width:100%;font-size:12px">';
  hm+='<thead><tr><th style="background:#1a1a1a;color:#e2e8f0;padding:6px 4px;border:1px solid #333;white-space:nowrap">'+t('eqHmDate')+'</th>';
  recentDates.forEach(function(d){hm+='<th style="background:#1a1a1a;color:#e2e8f0;padding:6px 4px;border:1px solid #333;font-size:10px;white-space:nowrap">'+d+'</th>'});
  hm+='<th style="background:#1a1a1a;color:#e2e8f0;font-weight:700;padding:6px 4px;border:1px solid #333">'+t('total')+'</th></tr></thead><tbody>';

  // Time row
  hm+='<tr><th style="background:#1a1a1a;color:#e65523;padding:6px 8px;border:1px solid #333;white-space:nowrap;font-weight:700">'+t('eqHmStop')+'</th>';
  var sumT=0;
  recentDates.forEach(function(d){
    var v=dayTime[d]||0;sumT+=v;
    var sty=v?getHmStyle(v,mxT,'stop'):'';
    hm+='<td style="padding:6px 4px;border:1px solid #333;text-align:center;font-size:11px;cursor:pointer;background:#000;color:#cbd5e1;'+sty+'" onclick="showDetail(\''+eq+'\',\''+d+'\',\'time\')">'+(v?Math.round(v).toLocaleString():'')+'</td>';
  });
  hm+='<td style="background:#1a1a1a;font-weight:700;color:#e2e8f0;padding:6px 4px;border:1px solid #333;text-align:center">'+Math.round(sumT).toLocaleString()+'</td></tr>';

  // Defect row
  hm+='<tr><th style="background:#1a1a1a;color:#c81914;padding:6px 8px;border:1px solid #333;white-space:nowrap;font-weight:700">'+t('eqHmDef')+'</th>';
  var sumD=0;
  recentDates.forEach(function(d){
    var v=dayDef[d]||0;sumD+=v;
    var sty=v?getHmStyle(v,mxD,'def'):'';
    hm+='<td style="padding:6px 4px;border:1px solid #333;text-align:center;font-size:11px;cursor:pointer;background:#000;color:#cbd5e1;'+sty+'" onclick="showDetail(\''+eq+'\',\''+d+'\',\'defect\')">'+(v?Math.round(v).toLocaleString():'')+'</td>';
  });
  hm+='<td style="background:#1a1a1a;font-weight:700;color:#e2e8f0;padding:6px 4px;border:1px solid #333;text-align:center">'+Math.round(sumD).toLocaleString()+'</td></tr>';

  hm+='</tbody></table></div>';

  // Legend
  hm+=buildHmLegend('stop');
  hm+='<div style="margin-top:6px;font-size:10px;color:#94a3b8">* '+t('eqHmHelp')+'</div>';

  document.getElementById('modalBody').innerHTML=hm;
  document.getElementById('modalOverlay').classList.add('show');
}

function showDayDetail(date,lineFilt){
  var rows=(D.allRows||[]).filter(function(r){return r.ds===date&&(!lineFilt||r.line===lineFilt)});
  if(!rows.length){closeModal();return}
  var byDefect=rows.slice().sort(function(a,b){return b.defect-a.defect||b.time-a.time}).slice(0,5);
  var byTime=rows.slice().sort(function(a,b){return b.time-a.time||b.defect-a.defect}).slice(0,5);
  var titleTxt=date+' '+t('dayDetailTitle')+(lineFilt?' ('+lineFilt+' Line)':' ('+t('total')+')');
  document.getElementById('modalTitle').textContent=titleTxt;
  var defTotalDef=byDefect.reduce(function(s,r){return s+r.defect},0);
  var defTotalTime=byDefect.reduce(function(s,r){return s+r.time},0);
  var timeTotalDef=byTime.reduce(function(s,r){return s+r.defect},0);
  var timeTotalTime=byTime.reduce(function(s,r){return s+r.time},0);
  var dd='<div style="margin-bottom:14px"><div style="color:#ef4444;font-weight:700;font-size:13px;margin-bottom:6px">ğŸ”´ '+t('worst5Def')+'</div>';
  dd+='<table><thead><tr><th>#</th><th>'+t('equip')+'</th><th>'+t('category')+'</th><th>'+t('worst10Hdr')[2]+'</th><th>'+t('defect')+'</th><th>'+t('dailyTimeMin')+'</th></tr></thead><tbody>';
  byDefect.forEach(function(r,i){
    var defCls=i===0?' class="highlight"':'';
    dd+='<tr><td>'+(i+1)+'</td><td>'+r.eq+'</td><td>'+r.sub+'</td><td>'+(r.detail||'-')+'</td><td'+defCls+'>'+Math.round(r.defect).toLocaleString()+'</td><td>'+Math.round(r.time).toLocaleString()+'</td></tr>';
  });
  dd+='<tr style="background:#1a1a1a;font-weight:700"><td></td><td>'+t('total')+'</td><td></td><td></td><td>'+Math.round(defTotalDef).toLocaleString()+'</td><td>'+Math.round(defTotalTime).toLocaleString()+'</td></tr>';
  dd+='</tbody></table></div>';
  dd+='<div><div style="color:#22c55e;font-weight:700;font-size:13px;margin-bottom:6px">ğŸŸ¢ '+t('worst5Stop')+'</div>';
  dd+='<table><thead><tr><th>#</th><th>'+t('equip')+'</th><th>'+t('category')+'</th><th>'+t('worst10Hdr')[2]+'</th><th>'+t('defect')+'</th><th>'+t('dailyTimeMin')+'</th></tr></thead><tbody>';
  byTime.forEach(function(r,i){
    var timeCls=i===0?' style="color:#22c55e;font-weight:700"':'';
    dd+='<tr><td>'+(i+1)+'</td><td>'+r.eq+'</td><td>'+r.sub+'</td><td>'+(r.detail||'-')+'</td><td>'+Math.round(r.defect).toLocaleString()+'</td><td'+timeCls+'>'+Math.round(r.time).toLocaleString()+'</td></tr>';
  });
  dd+='<tr style="background:#1a1a1a;font-weight:700"><td></td><td>'+t('total')+'</td><td></td><td></td><td>'+Math.round(timeTotalDef).toLocaleString()+'</td><td>'+Math.round(timeTotalTime).toLocaleString()+'</td></tr>';
  dd+='</tbody></table></div>';
  document.getElementById('modalBody').innerHTML=dd;
  document.getElementById('modalOverlay').classList.add('show');
}

function makeDailyChart(canvasId, data, title, barColor, lineFilt, yMax, y1Max){
  // Compute unique equipment count per date
  var eqCntByDate={};
  data.forEach(function(r){
    var d=r['ì¼ìstr'];
    var rows=D.allRows.filter(function(rr){return rr.ds===d&&(!lineFilt||rr.line===lineFilt)});
    var eqs={};rows.forEach(function(rr){eqs[rr.eq]=1});
    eqCntByDate[d]=Object.keys(eqs).length;
  });
  var labels=data.map(function(r){var d=r['ì¼ìstr'];return[d,(eqCntByDate[d]||0)+t('eqUnit')]});
  var ch=new Chart(canvasId,{type:'bar',data:{labels:labels,datasets:[
    {label:t('dailyTimeMin')+'('+t('hmAvg')+')',data:data.map(function(r){return Math.round(r.avgTime||0)}),backgroundColor:barColor+'B3',borderRadius:4,yAxisID:'y',order:2},
    {label:t('defect'),data:data.map(function(r){return Math.round(r.defect)}),type:'line',borderColor:'#ef4444',borderWidth:2,pointRadius:3,pointBackgroundColor:'#ef4444',yAxisID:'y1',tension:.3,order:1}
  ]},options:{responsive:true,maintainAspectRatio:true,onClick:function(evt,els){
    if(!els.length)return;var idx=els[0].index;var date=data[idx]['ì¼ìstr'];showDayDetail(date,lineFilt||null);
  },plugins:{legend:{labels:{color:'#94a3b8',font:{size:10}}},tooltip:{backgroundColor:'#0a0a0a',titleColor:'#60a5fa',bodyColor:'#e2e8f0',callbacks:{title:function(items){if(!items.length)return'';var idx=items[0].dataIndex;return data[idx]['ì¼ìstr']+' ('+( eqCntByDate[data[idx]['ì¼ìstr']]||0)+'ëŒ€)'},label:function(c){return c.dataset.label+': '+c.parsed.y.toLocaleString()}}}},scales:{
    x:{ticks:{color:'#94a3b8',font:{size:10},callback:function(val,idx){var lb=this.getLabelForValue(idx);if(Array.isArray(lb))return lb;return[lb]}},grid:{color:'#1a1a1a'}},
    y:{position:'left',ticks:{color:barColor,callback:function(v){return v.toLocaleString()}},grid:{color:'#1a1a1a'},title:{display:true,text:t('dailyTimeMin')+'('+t('hmAvg')+')',color:barColor,font:{size:10}},beginAtZero:true,max:yMax||undefined},
    y1:{position:'right',ticks:{color:'#ef4444',font:{size:9},callback:function(v){return v.toLocaleString()}},grid:{drawOnChartArea:false},title:{display:true,text:t('defect'),color:'#ef4444',font:{size:10}},beginAtZero:true,max:y1Max||undefined}
  }}});
  return ch;
}

function makeStopChart(canvasId, data, barColorStop, barColorNon){
  return new Chart(canvasId,{type:'bar',data:{labels:data.map(function(r){return r['ì¼ìstr']}),datasets:[
    {label:t('stop'),data:data.map(function(r){return r.stop}),backgroundColor:barColorStop,borderRadius:3},
    {label:t('nonStop'),data:data.map(function(r){return r.cnt-r.stop}),backgroundColor:barColorNon,borderRadius:3}
  ]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{labels:{color:'#94a3b8',font:{size:10}}},tooltip:{backgroundColor:'#0a0a0a',bodyColor:'#e2e8f0',callbacks:{label:function(c){return c.dataset.label+': '+c.parsed.y.toLocaleString()}}}},scales:{
    x:{stacked:true,ticks:{color:'#94a3b8',font:{size:10}},grid:{color:'#1a1a1a'}},
    y:{stacked:true,ticks:{color:'#94a3b8',callback:function(v){return v.toLocaleString()}},grid:{color:'#1a1a1a'}}
  }}});
}

function buildStopTable(data){
  var ts=0,tn=0;
  var h='<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">';
  h+='<div style="max-height:400px;overflow-y:auto"><table class="worst-tbl"><thead><tr><th colspan="2" style="color:#ef4444">â›” '+t('stop')+'</th></tr><tr><th>'+t('date')+'</th><th>'+t('count')+'</th></tr></thead><tbody>';
  data.forEach(function(r){var v=r.stop;ts+=v;h+='<tr><td>'+r['ì¼ìstr']+'</td><td'+(v>0?' style="color:#ef4444;font-weight:700"':'')+'>'+v+'</td></tr>'});
  h+='<tr style="background:#1a1a1a;color:#e2e8f0"><td style="font-weight:700;color:#fff">'+t('total')+'</td><td style="font-weight:700;color:#ef4444">'+ts+'</td></tr>';
  h+='</tbody></table></div>';
  h+='<div style="max-height:400px;overflow-y:auto"><table class="worst-tbl"><thead><tr><th colspan="2" style="color:#22c55e">âœ… '+t('nonStop')+'</th></tr><tr><th>'+t('date')+'</th><th>'+t('count')+'</th></tr></thead><tbody>';
  data.forEach(function(r){var v=r.cnt-r.stop;tn+=v;h+='<tr><td>'+r['ì¼ìstr']+'</td><td'+(v>0?' style="color:#22c55e;font-weight:700"':'')+'>'+v+'</td></tr>'});
  h+='<tr style="background:#1a1a1a;color:#e2e8f0"><td style="font-weight:700;color:#fff">'+t('total')+'</td><td style="font-weight:700;color:#22c55e">'+tn+'</td></tr>';
  h+='</tbody></table></div></div>';
  return h;
}

function buildStopTableWide(data){
  var h='<div class="hc"><table class="ht"><thead><tr><th>'+t('category')+'</th>';
  data.forEach(function(r){h+='<th>'+r['ì¼ìstr']+'</th>'});
  h+='<th style="background:#1a1a1a;color:#e2e8f0">'+t('total')+'</th></tr></thead><tbody>';
  var tc=0;
  h+='<tr><th style="color:#60a5fa">ğŸ“‹ '+t('count')+'</th>';
  data.forEach(function(r){var v=r.cnt;tc+=v;h+='<td style="color:#60a5fa;font-weight:700">'+v+'</td>'});
  h+='<td style="background:#1a1a1a;font-weight:700;color:#e2e8f0">'+tc+'</td></tr>';
  var ts=0;
  h+='<tr><th style="color:#ef4444">â›” '+t('stop')+'</th>';
  data.forEach(function(r){var v=r.stop;ts+=v;h+='<td'+(v>0?' style="color:#ef4444;font-weight:700"':'')+'>'+v+'</td>'});
  h+='<td style="background:#1a1a1a;font-weight:700;color:#c81914">'+ts+'</td></tr>';
  var tn=0;
  h+='<tr><th style="color:#22c55e">âœ… '+t('nonStop')+'</th>';
  data.forEach(function(r){var v=r.cnt-r.stop;tn+=v;h+='<td'+(v>0?' style="color:#22c55e;font-weight:700"':'')+'>'+v+'</td>'});
  h+='<td style="background:#1a1a1a;font-weight:700;color:#2e7d32">'+tn+'</td></tr>';
  h+='</tbody></table></div>';
  return h;
}

var _summaryDate='';
var _ovSumDate='';
function renderOverviewSum(date){
  _ovSumDate=date;
  var panel=document.getElementById('overviewPanel');
  if(panel){panel.innerHTML=buildOverviewPage();initOverviewLossChart();initOverviewUtilChart();initOverviewInspChart();initOverviewDailyChart();
    setTimeout(function(){panel.querySelectorAll('.hc').forEach(function(el){el.scrollLeft=el.scrollWidth;});},50);}
}
function renderSummaryWithDate(date){
  _summaryDate=date;
  var panel=document.getElementById('summaryPanel');
  if(panel){panel.innerHTML=buildSummaryPage();renderWorstWeekChart();}
}
function buildSummaryPage(){
  if(!D||!D.allRows||!D.all_dates||D.all_dates.length===0)return'<div style="padding:20px;color:#94a3b8">'+t('noData')+'</div>';
  var KPI_TARGET=50;
  var dates=D.all_dates;
  var lastDate=_summaryDate&&dates.indexOf(_summaryDate)>=0?_summaryDate:dates[dates.length-1];
  var lastIdx=dates.indexOf(lastDate);
  var lines=['K','G','H'];
  var lineColors={K:'#f59e0b',G:'#06b6d4',H:'#22c55e'};

  var weekDates=dates.slice(Math.max(0,lastIdx-6),lastIdx+1);
  var monthDates=dates.slice(Math.max(0,lastIdx-29),lastIdx+1);

  // dsâ†’fullDate ë§¤í•‘ (02/13 â†’ 2026-02-13)
  var _dsToFull={};
  D.allRows.forEach(function(r){if(r.ds&&r.dateStr&&!_dsToFull[r.ds])_dsToFull[r.ds]=r.dateStr;});
  // kpiStopByDateEq ë‚ ì§œë„ ë§¤í•‘ ì¶”ê°€ (allRowsì— ì—†ëŠ” ë‚ ì§œ ë³´ì™„)
  Object.keys(D.kpiStopByDateEq||{}).forEach(function(fd){
    var p=fd.split('-');if(p.length===3){var ds=p[1]+'/'+p[2];if(!_dsToFull[ds])_dsToFull[ds]=fd;}
  });
  // kpiStopByDateEq ê¸°ë°˜ ì •ì§€ì‹œê°„ ê³„ì‚° (PMè°ƒæ•´ë§Œ, åœæœº/å¼€æœº ì œì™¸, col20)
  console.log('[KPI DEBUG] _dsToFull keys:', Object.keys(_dsToFull).slice(-5));
  console.log('[KPI DEBUG] kpiStopByDateEq keys:', Object.keys(D.kpiStopByDateEq||{}).slice(-5));
  console.log('[KPI DEBUG] lastDate=', lastDate, 'â†’ fullDate=', _dsToFull[lastDate]);
  var _debugFd=_dsToFull[lastDate];
  if(_debugFd){
    var _debugStops=(D.kpiStopByDateEq||{})[_debugFd];
    console.log('[KPI DEBUG] kpiStopByDateEq['+_debugFd+']=', JSON.stringify(_debugStops));
    var _debugSBDE=(D.stopByDateEq||{})[_debugFd];
    console.log('[KPI DEBUG] stopByDateEq['+_debugFd+']=', JSON.stringify(_debugSBDE));
  } else {
    console.log('[KPI DEBUG] _dsToFull ë§¤í•‘ ì—†ìŒ! allRows ë‚ ì§œ ìƒ˜í”Œ:', D.allRows.slice(-3).map(function(r){return r.ds+'â†’'+r.dateStr}));
  }
  function getLineEqAvgStop(dt,line){
    var fd=_dsToFull[dt];if(!fd)return 0;
    var stops=(D.kpiStopByDateEq||{})[fd];if(!stops)return 0;
    var eqs=Object.keys(stops).filter(function(eq){return eq[0]===line&&stops[eq]>0;});
    if(!eqs.length)return 0;
    var total=eqs.reduce(function(s,eq){return s+stops[eq]},0);
    console.log('[KPI] '+dt+' '+line+'Line: eqs='+JSON.stringify(eqs.map(function(e){return e+'='+stops[e]}))+' total='+total+' avg='+Math.round(total/eqs.length));
    return total/eqs.length;
  }
  function getLineEqAvgStopMulti(dts,line){
    if(!dts.length)return 0;
    var vals=dts.map(function(dt){return getLineEqAvgStop(dt,line);}).filter(function(v){return v>0;});
    if(!vals.length)return 0;
    return vals.reduce(function(s,v){return s+v},0)/vals.length;
  }
  function getAllEqAvgStop(dt){
    var fd=_dsToFull[dt];if(!fd)return 0;
    var stops=(D.kpiStopByDateEq||{})[fd];if(!stops)return 0;
    var eqs=Object.keys(stops).filter(function(eq){return stops[eq]>0;});
    if(!eqs.length)return 0;
    var total=eqs.reduce(function(s,eq){return s+stops[eq]},0);
    return total/eqs.length;
  }
  function getAllEqAvgStopMulti(dts){
    if(!dts.length)return 0;
    var vals=dts.map(function(dt){return getAllEqAvgStop(dt);}).filter(function(v){return v>0;});
    if(!vals.length)return 0;
    return vals.reduce(function(s,v){return s+v},0)/vals.length;
  }

  function fmtCell(v,target){
    var rounded=Math.round(v);
    var cls=rounded<=target?'good':'bad';
    return'<span class="'+cls+'">'+rounded.toLocaleString()+t('min')+'</span>';
  }

  // === Section 1: Stop Time KPI by Line (per-equipment average) ===
  var selS2='background:#1a1a1a;color:#e2e8f0;border:1px solid #3b82f6;border-radius:6px;padding:4px 8px;font-size:12px;margin-left:8px';
  var h='<div class="sum-section"><div class="bx"><h3 style="display:flex;align-items:center;flex-wrap:wrap">&#9201; '+t('kpiTitle')+' <em>'+t('kpiTarget')+KPI_TARGET+t('min')+'</em>';
  h+='<span style="margin-left:auto"><label style="color:#94a3b8;font-size:11px">'+t('kpiDateLabel')+'</label><select onchange="renderSummaryWithDate(this.value)" style="'+selS2+'">';
  dates.slice().reverse().forEach(function(d){h+='<option value="'+d+'"'+(d===lastDate?' selected':'')+'>'+d+'</option>';});
  h+='</select></span></h3>';
  h+='<table class="sum-tbl"><thead><tr><th>'+t('category')+'</th><th style="color:#60a5fa">'+t('total')+'</th>';
  lines.forEach(function(ln){h+='<th style="color:'+lineColors[ln]+'">'+ln+' Line</th>'});
  h+='</tr></thead><tbody>';

  // KPI íŒì—…ìš© ë‚ ì§œ ë°ì´í„° ì „ì—­ ì €ì¥
  window._kpiDates={day:[lastDate],week:weekDates,month:monthDates};

  // ì „ì¼
  var allDayAvg=getAllEqAvgStop(lastDate);
  h+='<tr><td>'+t('yesterday')+'</td>';
  h+='<td class="hm-click" onclick="showKpiDetail(window._kpiDates.day,\'\')">'+fmtCell(allDayAvg,KPI_TARGET)+'</td>';
  lines.forEach(function(ln){
    var v=getLineEqAvgStop(lastDate,ln);
    h+='<td class="hm-click" onclick="showKpiDetail(window._kpiDates.day,\''+ln+'\')">'+fmtCell(v,KPI_TARGET)+'</td>';
  });
  h+='</tr>';

  // ì£¼ê°„
  var allWeekAvg=getAllEqAvgStopMulti(weekDates);
  h+='<tr><td>'+t('weekly')+'</td>';
  h+='<td class="hm-click" onclick="showKpiDetail(window._kpiDates.week,\'\')">'+fmtCell(allWeekAvg,KPI_TARGET)+'</td>';
  lines.forEach(function(ln){
    var v=getLineEqAvgStopMulti(weekDates,ln);
    h+='<td class="hm-click" onclick="showKpiDetail(window._kpiDates.week,\''+ln+'\')">'+fmtCell(v,KPI_TARGET)+'</td>';
  });
  h+='</tr>';

  // ì›”ê°„
  var allMonthAvg=getAllEqAvgStopMulti(monthDates);
  h+='<tr><td>'+t('monthly')+'</td>';
  h+='<td class="hm-click" onclick="showKpiDetail(window._kpiDates.month,\'\')">'+fmtCell(allMonthAvg,KPI_TARGET)+'</td>';
  lines.forEach(function(ln){
    var v=getLineEqAvgStopMulti(monthDates,ln);
    h+='<td class="hm-click" onclick="showKpiDetail(window._kpiDates.month,\''+ln+'\')">'+fmtCell(v,KPI_TARGET)+'</td>';
  });
  h+='</tr>';
  h+='</tbody></table></div></div>';

  // === Section 1-2: Persistent Problem Equipment (Top 3) ===
  // Find equipment with consistently high stop time + defect over 7+ days
  var recentDates=dates.slice(Math.max(0,lastIdx-6),lastIdx+1);
  var allEqs=Object.keys(D.allRows.reduce(function(m,r){m[r.eq]=1;return m},{}));

  var eqScores=[];
  allEqs.forEach(function(eq){
    var dailyTime=recentDates.map(function(dt){
      return D.allRows.filter(function(r){return r.eq===eq&&r.ds===dt&&r.stop}).reduce(function(s,r){return s+r.time},0);
    });
    var dailyDef=recentDates.map(function(dt){
      return D.allRows.filter(function(r){return r.eq===eq&&r.ds===dt}).reduce(function(s,r){return s+r.defect},0);
    });
    // Count days with non-zero stop time
    var activeDays=dailyTime.filter(function(v){return v>0}).length;
    if(activeDays<Math.min(3,recentDates.length))return; // at least 3 days active
    var avgTime=dailyTime.reduce(function(a,b){return a+b},0)/recentDates.length;
    var avgDef=dailyDef.reduce(function(a,b){return a+b},0)/recentDates.length;
    var totalTime=dailyTime.reduce(function(a,b){return a+b},0);
    var totalDef=dailyDef.reduce(function(a,b){return a+b},0);
    // Get top adjustment items
    var subMap={};
    D.allRows.filter(function(r){return r.eq===eq&&recentDates.indexOf(r.ds)>=0}).forEach(function(r){
      var k=r.sub||'ê¸°íƒ€';subMap[k]=(subMap[k]||0)+1;
    });
    var topSubs=Object.keys(subMap).sort(function(a,b){return subMap[b]-subMap[a]}).slice(0,3).map(function(k){return k+'('+subMap[k]+')'}).join(', ');
    eqScores.push({eq:eq,activeDays:activeDays,avgTime:avgTime,avgDef:avgDef,totalTime:totalTime,totalDef:totalDef,dailyTime:dailyTime,dailyDef:dailyDef,topSubs:topSubs});
  });
  // Sort by combined score: total stop time + total defect (both high = problem)
  eqScores.sort(function(a,b){return(b.totalTime+b.totalDef)-(a.totalTime+a.totalDef)});
  var top3=eqScores.slice(0,3);

  h+='<div class="sum-section"><div class="bx"><h3>&#9888; '+t('top3Title')+' <em>'+t('eqHmDays')+' '+recentDates.length+t('eqHmDaysSuffix')+'</em></h3>';
  h+='<table class="sum-tbl" style="font-size:11px;table-layout:fixed;width:100%"><colgroup><col style="width:24px"><col style="width:18%"><col style="width:22%"><col style="width:14%"><col style="width:18%"><col></colgroup><thead><tr>'+t('top3Hdr').map(function(hh){return'<th>'+hh+'</th>'}).join('')+'</tr></thead><tbody>';
  if(top3.length){
    top3.forEach(function(item,idx){
      var stopCnt=D.allRows.filter(function(r){return r.eq===item.eq&&recentDates.indexOf(r.ds)>=0&&r.stop}).length;
      h+='<tr>';
      h+='<td style="font-weight:700">'+(idx+1)+'</td>';
      h+='<td style="font-weight:700;color:#60a5fa;cursor:pointer;text-decoration:underline" onclick="showEqHeatmap(\''+item.eq+'\')">'+item.eq+'</td>';
      h+='<td style="color:#f59e0b;font-weight:700;word-break:break-all">'+Math.round(item.totalTime).toLocaleString()+t('min')+'<br><span style="font-size:9px;color:#94a3b8;font-weight:400">'+t('avgDay')+Math.round(item.avgTime).toLocaleString()+'</span></td>';
      h+='<td style="word-break:break-all">'+stopCnt+t('items')+'<br><span style="font-size:9px;color:#94a3b8">'+item.activeDays+'/'+recentDates.length+'</span></td>';
      h+='<td style="color:#ef4444;font-weight:700;word-break:break-all">'+Math.round(item.totalDef).toLocaleString()+'<br><span style="font-size:9px;color:#94a3b8;font-weight:400">'+t('avgDay')+Math.round(item.avgDef).toLocaleString()+'</span></td>';
      h+='<td style="text-align:left;font-size:10px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+item.topSubs+'</td>';
      h+='</tr>';
    });
  }else{
    h+='<tr><td colspan="6" style="color:#22c55e">'+t('noEquip')+'</td></tr>';
  }
  h+='</tbody></table></div></div>';

  // === Section 2: Previous day Worst 5 - Combined Time + Defect + Adjustment Items ===
  var prevRows=D.allRows.filter(function(r){return r.ds===lastDate});

  // Aggregate by equipment: time, defect, adjustment items
  var eqAgg={};
  prevRows.forEach(function(r){
    if(!eqAgg[r.eq])eqAgg[r.eq]={time:0,defect:0,subs:{}};
    eqAgg[r.eq].time+=r.time;
    eqAgg[r.eq].defect+=r.defect;
    var subKey=r.sub||'ê¸°íƒ€';
    if(!eqAgg[r.eq].subs[subKey])eqAgg[r.eq].subs[subKey]=0;
    eqAgg[r.eq].subs[subKey]++;
  });

  // Get top adjustment items summary for an equipment
  function getTopSubs(subsMap){
    var arr=Object.keys(subsMap).map(function(k){return{name:k,cnt:subsMap[k]}}).sort(function(a,b){return b.cnt-a.cnt});
    return arr.slice(0,3).map(function(s){return s.name+'('+s.cnt+')'}).join(', ');
  }

  // Sort by time desc for Worst 5
  var timeWorst5=Object.keys(eqAgg).map(function(eq){return{eq:eq,time:eqAgg[eq].time,defect:eqAgg[eq].defect,subs:eqAgg[eq].subs}}).sort(function(a,b){return b.time-a.time}).slice(0,5);
  // Sort by defect desc for Worst 5
  var defWorst5=Object.keys(eqAgg).map(function(eq){return{eq:eq,time:eqAgg[eq].time,defect:eqAgg[eq].defect,subs:eqAgg[eq].subs}}).sort(function(a,b){return b.defect-a.defect}).slice(0,5);

  h+='<div class="sum-section"><div class="bx"><h3>&#128308; '+t('yesterday')+' ('+lastDate+') '+t('worst5Title')+'</h3>';
  h+='<div class="worst-grid">';

  // Time Worst 5
  h+='<div class="worst-card"><h4 style="color:#f59e0b">&#9200; '+t('worst5Stop')+'</h4>';
  h+='<table class="worst-tbl"><thead><tr><th>#</th><th>'+t('equip')+'</th><th>'+t('dailyTimeMin')+'<br><span style="font-size:10px;color:#94a3b8">'+t('defect')+'</span></th><th>'+t('worst5Hdr')[4]+'</th></tr></thead><tbody>';
  timeWorst5.forEach(function(item,i){
    h+='<tr><td>'+(i+1)+'</td><td>'+item.eq+'</td>';
    h+='<td><span style="color:#f59e0b;font-weight:700">'+Math.round(item.time).toLocaleString()+t('min')+'</span><br><span style="font-size:11px;color:#94a3b8">'+t('defect')+' '+Math.round(item.defect).toLocaleString()+'</span></td>';
    h+='<td style="text-align:left;font-size:11px">'+getTopSubs(item.subs)+'</td></tr>';
  });
  if(!timeWorst5.length)h+='<tr><td colspan="4" style="color:#94a3b8">'+t('noData')+'</td></tr>';
  h+='</tbody></table></div>';

  // Defect Worst 5
  h+='<div class="worst-card"><h4 style="color:#ef4444">&#128165; '+t('worst5Def')+'</h4>';
  h+='<table class="worst-tbl"><thead><tr><th>#</th><th>'+t('equip')+'</th><th>'+t('defect')+'<br><span style="font-size:10px;color:#94a3b8">'+t('dailyTimeMin')+'</span></th><th>'+t('worst5Hdr')[4]+'</th></tr></thead><tbody>';
  defWorst5.forEach(function(item,i){
    h+='<tr><td>'+(i+1)+'</td><td>'+item.eq+'</td>';
    h+='<td><span style="color:#ef4444;font-weight:700">'+Math.round(item.defect).toLocaleString()+'</span><br><span style="font-size:11px;color:#94a3b8">'+Math.round(item.time).toLocaleString()+t('min')+'</span></td>';
    h+='<td style="text-align:left;font-size:11px">'+getTopSubs(item.subs)+'</td></tr>';
  });
  if(!defWorst5.length)h+='<tr><td colspan="4" style="color:#94a3b8">'+t('noData')+'</td></tr>';
  h+='</tbody></table></div>';

  h+='</div></div></div>';

  // === Section 3: Weekly performance chart for worst 5 equipment (by time) ===
  h+='<div class="sum-section"><div class="bx"><h3>&#128200; '+t('worst5Trend')+'</h3>';
  h+='<canvas id="worstWeekChart"></canvas>';
  h+='</div></div>';

  return h;
}

function renderWorstWeekChart(){
  if(!D||!D.allRows||!D.all_dates||D.all_dates.length===0)return;
  var dates=D.all_dates;
  var lastDate=_summaryDate&&dates.indexOf(_summaryDate)>=0?_summaryDate:dates[dates.length-1];
  var lastIdx=dates.indexOf(lastDate);
  var weekDates=dates.slice(Math.max(0,lastIdx-6),lastIdx+1);

  // Get worst 5 by time for previous day
  var prevRows=D.allRows.filter(function(r){return r.ds===lastDate});
  var eqTimeMap={};
  prevRows.forEach(function(r){
    if(!eqTimeMap[r.eq])eqTimeMap[r.eq]=0;
    eqTimeMap[r.eq]+=r.time;
  });
  var worst5=Object.keys(eqTimeMap).map(function(eq){return{eq:eq,val:eqTimeMap[eq]}}).sort(function(a,b){return b.val-a.val}).slice(0,5);
  if(!worst5.length)return;

  var colors=['#ef4444','#f59e0b','#3b82f6','#22c55e','#a855f7'];
  var datasets=worst5.map(function(item,idx){
    var data=weekDates.map(function(d){
      return D.allRows.filter(function(r){return r.eq===item.eq&&r.ds===d}).reduce(function(s,r){return s+r.time},0);
    });
    return{
      label:item.eq,
      data:data,
      borderColor:colors[idx%5],
      backgroundColor:colors[idx%5]+'33',
      borderWidth:2,
      pointRadius:4,
      pointBackgroundColor:colors[idx%5],
      tension:0.3,
      fill:false
    };
  });

  var canvas=document.getElementById('worstWeekChart');
  if(!canvas)return;
  var ch=new Chart(canvas,{
    type:'line',
    data:{labels:weekDates,datasets:datasets},
    options:{
      responsive:true,maintainAspectRatio:true,aspectRatio:2,
      plugins:{
        legend:{labels:{color:'#e2e8f0',font:{size:11}},position:'bottom'},
        tooltip:{backgroundColor:'#0a0a0a',titleColor:'#60a5fa',bodyColor:'#e2e8f0',callbacks:{label:function(c){return c.dataset.label+': '+Math.round(c.parsed.y).toLocaleString()+t('min')}}}
      },
      scales:{
        x:{ticks:{color:'#94a3b8',font:{size:11}},grid:{color:'#1a1a1a'}},
        y:{ticks:{color:'#94a3b8',callback:function(v){return v+t('min')}},grid:{color:'#1a1a1a'},title:{display:true,text:t('stopTime')+'('+t('min')+')',color:'#94a3b8',font:{size:11}},
          beginAtZero:true
        }
      }
    }
  });
  charts.push(ch);
}

// ===================== LOSS ìš”ì•½ =====================
var LOSS_LINE_COLORS={K1:'#3b82f6',K2:'#8b5cf6',G:'#06b6d4',H:'#22c55e',E:'#f59e0b',Total:'#f87171'};
var LOSS_DETAIL_HDR=t('lossDetailHdr');
var _lossSubView='detail',_lossDate='',_lossLine='K1';
var LOSS_TARGET=0.06;

function eqToLine(eq){
  if(!eq)return'';
  var n=parseInt(eq.slice(1));
  if(eq[0]==='K'&&n<=8)return'K1';
  if(eq[0]==='K'&&n>=9)return'K2';
  return eq[0]==='G'?'G':eq[0]==='H'?'H':eq[0]==='E'?'E':'';
}

function fmtLoss(v){
  if(v===null||v===undefined||v===''||v===0)return'-';
  return(v*100).toFixed(2)+'%';
}
function lossClr(v){
  if(!v||v===0)return'';
  return getHmStyle(v,0.20,'loss');
}
function detailClr(ratio){
  if(!ratio||ratio<=0)return'';
  return getHmStyle(ratio,1,'loss');
}

// ===================== ìš”ì•½ í˜ì´ì§€ =====================
function buildOverviewPage(){
  if(!D)return'<div style="padding:20px;color:#94a3b8">'+t('noData')+'</div>';
  var h='';
  var dates=D.lossDates||[];
  var allDates=D.all_dates||[];

  // --- 0) ì „ì¼ìš”ì•½ ---
  if(dates.length>0){
    var _ovLast=_ovSumDate&&dates.indexOf(_ovSumDate)>=0?_ovSumDate:dates[dates.length-1];
    var _ovLS=D.lineSummary||{};
    var _ovLns=['G','H','K'];
    // ê°€ë™ì„¤ë¹„
    var _ovEqT=0;_ovLns.forEach(function(ln){_ovEqT+=(_ovLS[ln]||{}).eq||0;});
    // Lossìœ¨: K=K1+K2 ê°€ì¤‘í‰ê· 
    function _ovLoss(ln){
      if(ln==='K'){var k1=D.lossByLineDate[_ovLast]&&D.lossByLineDate[_ovLast]['K1'];var k2=D.lossByLineDate[_ovLast]&&D.lossByLineDate[_ovLast]['K2'];var tp=(k1?k1.p:0)+(k2?k2.p:0);var tl=(k1?k1.p*k1.r:0)+(k2?k2.p*k2.r:0);return tp>0?tl/tp*100:0;}
      var dd=D.lossByLineDate[_ovLast]&&D.lossByLineDate[_ovLast][ln];return dd&&dd.p>0?dd.r*100:0;
    }
    var _ovLossT=0,_ovLossTP=0;['K1','K2','G','H','E'].forEach(function(l){var dd=D.lossByLineDate[_ovLast]&&D.lossByLineDate[_ovLast][l];if(dd){_ovLossTP+=dd.p;_ovLossT+=dd.p*dd.r;}});
    var _ovLossTot=_ovLossTP>0?_ovLossT/_ovLossTP*100:0;
    // ì¡°ì •Loss (PMì¡°ì •=larr[0])
    function _ovPmLoss(line){var dd=D.lossDetailByDateEq[_ovLast]||{};var pm=0,pr=0;Object.keys(dd).forEach(function(eq){if(!line||eq[0]===line){pm+=dd[eq].larr[0];}});
      if(line==='K'){var k1=D.lossByLineDate[_ovLast]&&D.lossByLineDate[_ovLast]['K1'];var k2=D.lossByLineDate[_ovLast]&&D.lossByLineDate[_ovLast]['K2'];pr=(k1?k1.p:0)+(k2?k2.p:0);}
      else if(!line){['K1','K2','G','H','E'].forEach(function(l){var v=D.lossByLineDate[_ovLast]&&D.lossByLineDate[_ovLast][l];if(v)pr+=v.p;});}
      else{var v=D.lossByLineDate[_ovLast]&&D.lossByLineDate[_ovLast][line];pr=v?v.p:0;}
      return pr>0?pm/pr*100:0;}
    // ì¡°ì •ì •ì§€ (KPI í‰ê· )
    var _ovDsToFull={};(D.allRows||[]).forEach(function(r){if(r.ds&&r.dateStr&&!_ovDsToFull[r.ds])_ovDsToFull[r.ds]=r.dateStr;});
    Object.keys(D.kpiStopByDateEq||{}).forEach(function(fd){var p=fd.split('-');if(p.length===3){var ds=p[1]+'/'+p[2];if(!_ovDsToFull[ds])_ovDsToFull[ds]=fd;}});
    var _ovLastDs=allDates.length?allDates[allDates.length-1]:'';
    function _ovStopAvg(line){var fd=_ovDsToFull[_ovLastDs];if(!fd)return 0;var stops=(D.kpiStopByDateEq||{})[fd];if(!stops)return 0;var eqs=Object.keys(stops).filter(function(eq){return(!line||eq[0]===line)&&stops[eq]>0;});if(!eqs.length)return 0;return eqs.reduce(function(s,eq){return s+stops[eq]},0)/eqs.length;}
    // ì™„ì „ë¶ˆëŸ‰
    function _ovFullDef(ln){
      if(ln==='K'){var k1=D.lossByLineDate[_ovLast]&&D.lossByLineDate[_ovLast]['K1'];var k2=D.lossByLineDate[_ovLast]&&D.lossByLineDate[_ovLast]['K2'];var tp=(k1?k1.p:0)+(k2?k2.p:0);var td=(k1?k1.cd:0)+(k2?k2.cd:0);return tp>0?td/tp*100:0;}
      if(ln==='H'){var dd=D.lossByLineDate[_ovLast]&&D.lossByLineDate[_ovLast]['H'];return dd&&dd.p>0?dd.dd/dd.p*100:0;}
      var dd2=D.lossByLineDate[_ovLast]&&D.lossByLineDate[_ovLast][ln];return dd2&&dd2.p>0?dd2.cd/dd2.p*100:0;
    }
    var _ovFullDefT=0,_ovFullDefTP=0;['K1','K2','G'].forEach(function(l){var dd=D.lossByLineDate[_ovLast]&&D.lossByLineDate[_ovLast][l];if(dd&&dd.p>0){_ovFullDefTP+=dd.p;_ovFullDefT+=dd.cd;}});
    var hdd=D.lossByLineDate[_ovLast]&&D.lossByLineDate[_ovLast]['H'];if(hdd&&hdd.p>0){_ovFullDefTP+=hdd.p;_ovFullDefT+=hdd.dd;}
    var _ovFullDefTot=_ovFullDefTP>0?_ovFullDefT/_ovFullDefTP*100:0;
    // ê²€ì‚¬ì •ì§€
    var _ovInsp=D.inspAllRows||[];
    function _ovInspTime(line){return _ovInsp.filter(function(r){return r.dateStr===_ovLast&&(!line||r.line===line)&&r.stop}).reduce(function(s,r){return s+(r.kpiTime||0)},0);}
    // ê¸°ìˆ ì¡°ì •
    function _ovTech(line){var dd=D.lossDetailByDateEq[_ovLast]||{};var s=0;Object.keys(dd).forEach(function(eq){if(!line||eq[0]===line)s+=dd[eq].larr[9];});return s;}

    var _ovSelS='background:#1a1a1a;color:#e2e8f0;border:1px solid #2a2a2a;border-radius:4px;padding:2px 6px;font-size:11px';
    h+='<div class="bx"><h3 style="display:flex;align-items:center;flex-wrap:wrap">'+t('ovSumTitle')+' ('+_ovLast+')';
    h+='<span style="margin-left:auto"><select onchange="renderOverviewSum(this.value)" style="'+_ovSelS+'">';
    dates.forEach(function(d){h+='<option value="'+d+'"'+(d===_ovLast?' selected':'')+'>'+d+'</option>';});
    h+='</select></span></h3>';
    var _ovLnC={G:'#06b6d4',H:'#22c55e',K:'#f59e0b'};var _ovLnBg={G:'rgba(6,182,212,0.08)',H:'rgba(34,197,94,0.08)',K:'rgba(245,158,11,0.08)'};
    // ëª©í‘œê°’
    var _ovTgt={equip:null,loss:6,pmLoss:1,pmStop:50,fullDef:0.8,inspStop:20,tech:null};
    // ë‹¬ì„±ìœ¨ ê³„ì‚°: % í•­ëª©ì€ ëª©í‘œ ì´í•˜ê°€ ë‹¬ì„± (ì‹¤ì /ëª©í‘œ*100 ì—­ìˆ˜), ì‹œê°„ë„ ëª©í‘œ ì´í•˜ê°€ ë‹¬ì„±
    function _ovAchv(val,tgt,isLower){if(tgt==null||tgt===0)return null;if(isLower)return tgt/val*100;return val/tgt*100;}
    function _ovAchvTd(val,tgt){if(tgt==null)return'<td>-</td>';var a=val<=0?100:(val<=tgt?100:Math.round(tgt/val*100));var clr=a>=100?'#22c55e':'#ef4444';return'<td style="color:'+clr+';font-weight:700">'+a+'%</td>';}
    function _ovAchvTdMin(val,tgt){if(tgt==null)return'<td>-</td>';var a=val<=0?100:(val<=tgt?100:Math.round(tgt/val*100));var clr=a>=100?'#22c55e':'#ef4444';return'<td style="color:'+clr+';font-weight:700">'+a+'%</td>';}
    var _pmLT=_ovPmLoss(null);
    var _psT=Math.round(_ovStopAvg(null));
    var _isT=Math.round(_ovInspTime(null));

    h+='<div style="overflow-x:auto"><table class="sum-tbl ov-sum"><thead><tr><th>'+t('category')+'</th><th>ëª©í‘œ</th><th style="color:#60a5fa">ì‹¤ì </th><th>ë‹¬ì„±ìœ¨</th>';
    _ovLns.forEach(function(ln){h+='<th style="color:'+_ovLnC[ln]+';background:rgba('+{G:'6,182,212',H:'34,197,94',K:'245,158,11'}[ln]+',0.10)">'+ln+' Line</th>';});
    h+='</tr></thead><tbody>';
    // ê°€ë™ì„¤ë¹„
    h+='<tr><td>'+t('equip')+'</td><td>-</td><td style="font-weight:700">'+_ovEqT+t('eqUnit')+'</td><td>-</td>';
    _ovLns.forEach(function(ln){h+='<td style="background:'+_ovLnBg[ln]+'">'+((_ovLS[ln]||{}).eq||0)+t('eqUnit')+'</td>';});h+='</tr>';
    // Loss
    h+='<tr><td>Loss</td><td>6%</td><td onclick="showOvSumPopup(\'loss\',null)" style="font-weight:700">'+_ovLossTot.toFixed(1)+'%</td>'+_ovAchvTd(_ovLossTot,6);
    _ovLns.forEach(function(ln){h+='<td onclick="showOvSumPopup(\'loss\',\''+ln+'\')" style="background:'+_ovLnBg[ln]+'">'+_ovLoss(ln).toFixed(1)+'%</td>';});h+='</tr>';
    // ì¡°ì •Loss
    h+='<tr><td>'+t('lossDetailHdr')[0]+'Loss</td><td>1%</td><td onclick="showOvSumPopup(\'pmLoss\',null)" style="font-weight:700">'+_pmLT.toFixed(1)+'%</td>'+_ovAchvTd(_pmLT,1);
    _ovLns.forEach(function(ln){h+='<td onclick="showOvSumPopup(\'pmLoss\',\''+ln+'\')" style="background:'+_ovLnBg[ln]+'">'+_ovPmLoss(ln).toFixed(1)+'%</td>';});h+='</tr>';
    // ì¡°ì •ì •ì§€
    h+='<tr><td>'+t('lossDetailHdr')[0]+t('stop')+'</td><td>50ë¶„</td><td onclick="showOvSumPopup(\'pmStop\',null)" style="font-weight:700">'+_psT+t('min')+'</td>'+_ovAchvTdMin(_psT,50);
    _ovLns.forEach(function(ln){h+='<td onclick="showOvSumPopup(\'pmStop\',\''+ln+'\')" style="background:'+_ovLnBg[ln]+'">'+Math.round(_ovStopAvg(ln))+t('min')+'</td>';});h+='</tr>';
    // ì™„ì „ë¶ˆëŸ‰
    h+='<tr><td>'+t('fullDef')+'</td><td>0.8%</td><td onclick="showOvSumPopup(\'fullDef\',null)" style="font-weight:700">'+_ovFullDefTot.toFixed(1)+'%</td>'+_ovAchvTd(_ovFullDefTot,0.8);
    _ovLns.forEach(function(ln){h+='<td onclick="showOvSumPopup(\'fullDef\',\''+ln+'\')" style="background:'+_ovLnBg[ln]+'">'+_ovFullDef(ln).toFixed(1)+'%</td>';});h+='</tr>';
    // ê²€ì‚¬ì •ì§€
    h+='<tr><td>'+t('tabInsp')+t('stop')+'</td><td>20ë¶„</td><td onclick="showOvSumPopup(\'inspStop\',null)" style="font-weight:700">'+_isT+t('min')+'</td>'+_ovAchvTdMin(_isT,20);
    _ovLns.forEach(function(ln){h+='<td onclick="showOvSumPopup(\'inspStop\',\''+ln+'\')" style="background:'+_ovLnBg[ln]+'">'+Math.round(_ovInspTime(ln))+t('min')+'</td>';});h+='</tr>';
    // ê¸°ìˆ ì¡°ì •
    h+='<tr><td>'+t('lossDetailHdr')[9]+'</td><td>-</td><td onclick="showOvSumPopup(\'tech\',null)" style="font-weight:700">'+Math.round(_ovTech(null))+'ea</td><td>-</td>';
    _ovLns.forEach(function(ln){var v=Math.round(_ovTech(ln));h+='<td onclick="showOvSumPopup(\'tech\',\''+ln+'\')" style="background:'+_ovLnBg[ln]+'">'+(v>0?v+'ea':'')+'</td>';});h+='</tr>';
    h+='</tbody></table></div>';
  }

  // (Loss íˆíŠ¸ë§µ í…Œì´ë¸”ì€ Loss í˜ì´ì§€ë¡œ ì´ë™ë¨)

  // --- 2) ì¼ê°„ Loss ê·¸ë˜í”„ ---
  h+='<div class="bx"><h3 style="display:flex;align-items:center;flex-wrap:wrap">'+t('ovLossChart');
  h+='<span style="margin-left:auto;display:flex;gap:6px;flex-wrap:wrap;font-size:9px;font-weight:400">';
  ['K1','K2','G','H','E','Total'].forEach(function(ln){h+='<span style="display:flex;align-items:center;gap:2px"><span style="display:inline-block;width:14px;height:3px;background:'+LOSS_LINE_COLORS[ln]+'"></span>'+ln+'</span>';});
  h+='<span style="display:flex;align-items:center;gap:2px"><span style="display:inline-block;width:14px;height:0;border-top:2px dashed #f59e0b"></span>'+t('target')+'6%</span>';
  h+='</span></h3>';
  h+='<canvas id="ovLossChart"></canvas></div>';

  // --- 3) Total ê°€ë™ìœ¨ ê·¸ë˜í”„ (í´ë¦­â†’ê°€ë™ìœ¨íƒ­) ---
  h+='<div class="bx" style="cursor:pointer" onclick="go(2)"><h3 style="display:flex;align-items:center;flex-wrap:wrap">'+t('utilTitle')+' <em style="color:#94a3b8;font-size:10px">â–¶ '+t('tabUtil')+'</em>';
  h+='<span style="margin-left:auto;display:flex;gap:6px;font-size:9px;font-weight:400">';
  h+='<span style="display:flex;align-items:center;gap:2px"><span style="display:inline-block;width:14px;height:3px;background:#f87171"></span>'+t('utilRate')+'</span>';
  h+='<span style="display:flex;align-items:center;gap:2px"><span style="display:inline-block;width:14px;height:0;border-top:2px dashed #f59e0b"></span>'+t('utilTarget')+'95%</span>';
  h+='</span></h3>';
  h+='<canvas id="ovUtilChart"></canvas></div>';

  // --- 3.5) ì „ì²´ ì¼ìë³„ ì •ì§€ì‹œê°„/ë¶ˆëŸ‰ìˆ˜ëŸ‰ ê·¸ë˜í”„ (í´ë¦­â†’ì •ì§€ì‹œê°„íƒ­) ---
  h+='<div class="bx" style="cursor:pointer" onclick="go(3)"><h3 style="display:flex;align-items:center;flex-wrap:wrap">'+t('ovDailyTitle')+' <em style="color:#94a3b8;font-size:10px">â–¶ '+t('tabDaily')+'</em>';
  h+='<span style="margin-left:auto;display:flex;gap:6px;font-size:9px;font-weight:400">';
  h+='<span style="display:flex;align-items:center;gap:2px"><span style="display:inline-block;width:14px;height:8px;background:#3b82f6B3;border-radius:2px"></span>'+t('dailyTimeMin')+'</span>';
  h+='<span style="display:flex;align-items:center;gap:2px"><span style="display:inline-block;width:14px;height:3px;background:#ef4444"></span>'+t('defect')+'</span>';
  h+='</span></h3>';
  h+='<canvas id="ovDailyChart"></canvas></div>';

  // --- 4~6) ì •ì§€ì‹œê°„ KPI + TOP3 + Worst5 (buildSummaryPage ë¡œì§) ---
  if(allDates.length>0){
    var KPI_TARGET=50;
    var sDates=allDates;
    var sLastDate=_summaryDate&&sDates.indexOf(_summaryDate)>=0?_summaryDate:sDates[sDates.length-1];
    var sLastIdx=sDates.indexOf(sLastDate);
    var sWeek=sDates.slice(Math.max(0,sLastIdx-6),sLastIdx+1);
    var sMonth=sDates.slice(Math.max(0,sLastIdx-29),sLastIdx+1);
    var lines=['K','G','H'];
    var lineColors={K:'#f59e0b',G:'#06b6d4',H:'#22c55e'};
    var _dsToFull={};
    D.allRows.forEach(function(r){if(r.ds&&r.dateStr&&!_dsToFull[r.ds])_dsToFull[r.ds]=r.dateStr;});
    Object.keys(D.kpiStopByDateEq||{}).forEach(function(fd){var p=fd.split('-');if(p.length===3){var ds=p[1]+'/'+p[2];if(!_dsToFull[ds])_dsToFull[ds]=fd;}});
    function _getLineAvg(dt,line){var fd=_dsToFull[dt];if(!fd)return 0;var stops=(D.kpiStopByDateEq||{})[fd];if(!stops)return 0;var eqs=Object.keys(stops).filter(function(eq){return eq[0]===line&&stops[eq]>0;});if(!eqs.length)return 0;return eqs.reduce(function(s,eq){return s+stops[eq]},0)/eqs.length;}
    function _getLineAvgM(dts,line){var vs=dts.map(function(dt){return _getLineAvg(dt,line);}).filter(function(v){return v>0;});return vs.length?vs.reduce(function(a,b){return a+b},0)/vs.length:0;}
    function _getAllAvg(dt){var fd=_dsToFull[dt];if(!fd)return 0;var stops=(D.kpiStopByDateEq||{})[fd];if(!stops)return 0;var eqs=Object.keys(stops).filter(function(eq){return stops[eq]>0;});if(!eqs.length)return 0;return eqs.reduce(function(s,eq){return s+stops[eq]},0)/eqs.length;}
    function _getAllAvgM(dts){var vs=dts.map(function(dt){return _getAllAvg(dt);}).filter(function(v){return v>0;});return vs.length?vs.reduce(function(a,b){return a+b},0)/vs.length:0;}
    function _fc(v){var r=Math.round(v);return'<span class="'+(r<=KPI_TARGET?'good':'bad')+'">'+r.toLocaleString()+t('min')+'</span>';}
    window._kpiDates={day:[sLastDate],week:sWeek,month:sMonth};

    // 4) KPI í‘œ
    h+='<div class="bx"><h3>'+t('kpiTitle')+' = '+t('target')+' '+KPI_TARGET+t('min')+'</h3>';
    h+='<table class="sum-tbl"><thead><tr><th>'+t('category')+'</th><th style="color:#60a5fa">'+t('total')+'</th>';
    lines.forEach(function(ln){h+='<th style="color:'+lineColors[ln]+'">'+ln+' Line</th>';});
    h+='</tr></thead><tbody>';
    [{label:t('yesterday'),dts:[sLastDate],pk:'day'},{label:t('weekly'),dts:sWeek,pk:'week'},{label:t('monthly'),dts:sMonth,pk:'month'}].forEach(function(p){
      var allV=p.dts.length===1?_getAllAvg(p.dts[0]):_getAllAvgM(p.dts);
      h+='<tr><td>'+p.label+'</td><td class="hm-click" onclick="showKpiDetail(window._kpiDates.'+p.pk+',\'\')">'+_fc(allV)+'</td>';
      lines.forEach(function(ln){var v=p.dts.length===1?_getLineAvg(p.dts[0],ln):_getLineAvgM(p.dts,ln);h+='<td class="hm-click" onclick="showKpiDetail(window._kpiDates.'+p.pk+',\''+ln+'\')">'+_fc(v)+'</td>';});
      h+='</tr>';
    });
    h+='</tbody></table></div>';

    // 5) TOP3
    var recentDts=sDates.slice(Math.max(0,sLastIdx-6),sLastIdx+1);
    var allEqs=Object.keys(D.allRows.reduce(function(m,r){m[r.eq]=1;return m},{}));
    var eqScores=[];
    allEqs.forEach(function(eq){
      var dTime=recentDts.map(function(dt){return D.allRows.filter(function(r){return r.eq===eq&&r.ds===dt&&r.stop}).reduce(function(s,r){return s+r.time},0);});
      var dDef=recentDts.map(function(dt){return D.allRows.filter(function(r){return r.eq===eq&&r.ds===dt}).reduce(function(s,r){return s+r.defect},0);});
      var act=dTime.filter(function(v){return v>0}).length;
      if(act<Math.min(3,recentDts.length))return;
      var tTime=dTime.reduce(function(a,b){return a+b},0),tDef=dDef.reduce(function(a,b){return a+b},0);
      var subMap={};D.allRows.filter(function(r){return r.eq===eq&&recentDts.indexOf(r.ds)>=0}).forEach(function(r){var k=r.sub||'ê¸°íƒ€';subMap[k]=(subMap[k]||0)+1;});
      var topS=Object.keys(subMap).sort(function(a,b){return subMap[b]-subMap[a]}).slice(0,3).map(function(k){return k+'('+subMap[k]+')'}).join(', ');
      eqScores.push({eq:eq,act:act,tTime:tTime,tDef:tDef,aTime:tTime/recentDts.length,aDef:tDef/recentDts.length,topS:topS});
    });
    eqScores.sort(function(a,b){return(b.tTime+b.tDef)-(a.tTime+a.tDef)});
    var top3=eqScores.slice(0,3);
    h+='<div class="bx"><h3>'+t('top3Title')+' <em>'+recentDts.length+t('eqHmDaysSuffix')+'</em></h3>';
    h+='<table class="sum-tbl" style="font-size:11px;table-layout:fixed;width:100%"><colgroup><col style="width:24px"><col style="width:18%"><col style="width:22%"><col style="width:14%"><col style="width:18%"><col></colgroup><thead><tr>'+t('top3Hdr').map(function(hh){return'<th>'+hh+'</th>'}).join('')+'</tr></thead><tbody>';
    if(top3.length){top3.forEach(function(item,idx){
      var sc=D.allRows.filter(function(r){return r.eq===item.eq&&recentDts.indexOf(r.ds)>=0&&r.stop}).length;
      h+='<tr><td style="font-weight:700">'+(idx+1)+'</td><td style="font-weight:700;color:#60a5fa;cursor:pointer;text-decoration:underline" onclick="showEqHeatmap(\''+item.eq+'\')">'+item.eq+'</td>';
      h+='<td style="color:#f59e0b;font-weight:700;word-break:break-all">'+Math.round(item.tTime).toLocaleString()+t('min')+'<br><span style="font-size:9px;color:#94a3b8;font-weight:400">'+t('avgDay')+Math.round(item.aTime).toLocaleString()+'</span></td>';
      h+='<td style="word-break:break-all">'+sc+t('items')+'<br><span style="font-size:9px;color:#94a3b8">'+item.act+'/'+recentDts.length+'</span></td>';
      h+='<td style="color:#ef4444;font-weight:700;word-break:break-all">'+Math.round(item.tDef).toLocaleString()+'<br><span style="font-size:9px;color:#94a3b8;font-weight:400">'+t('avgDay')+Math.round(item.aDef).toLocaleString()+'</span></td>';
      h+='<td style="text-align:left;font-size:10px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">'+item.topS+'</td></tr>';
    });}else{h+='<tr><td colspan="6" style="color:#22c55e">'+t('noEquip')+'</td></tr>';}
    h+='</tbody></table></div>';

    // 6) ì „ì¼ Worst 5
    var prevRows=D.allRows.filter(function(r){return r.ds===sLastDate});
    var eqAgg={};
    prevRows.forEach(function(r){if(!eqAgg[r.eq])eqAgg[r.eq]={time:0,defect:0,subs:{}};eqAgg[r.eq].time+=r.time;eqAgg[r.eq].defect+=r.defect;var sk=r.sub||'ê¸°íƒ€';eqAgg[r.eq].subs[sk]=(eqAgg[r.eq].subs[sk]||0)+1;});
    function _topSubs(sm){return Object.keys(sm).map(function(k){return{n:k,c:sm[k]}}).sort(function(a,b){return b.c-a.c}).slice(0,3).map(function(s){return s.n+'('+s.c+')'}).join(', ');}
    var tw5=Object.keys(eqAgg).map(function(eq){return{eq:eq,time:eqAgg[eq].time,def:eqAgg[eq].defect,subs:eqAgg[eq].subs}}).sort(function(a,b){return b.time-a.time}).slice(0,5);
    var dw5=Object.keys(eqAgg).map(function(eq){return{eq:eq,time:eqAgg[eq].time,def:eqAgg[eq].defect,subs:eqAgg[eq].subs}}).sort(function(a,b){return b.def-a.def}).slice(0,5);
    h+='<div class="bx"><h3>'+t('yesterday')+' ('+sLastDate+') '+t('worst5Title')+'</h3><div class="worst-grid">';
    h+='<div class="worst-card"><h4 style="color:#f59e0b">'+t('worst5Stop')+'</h4>';
    h+='<table class="worst-tbl"><thead><tr><th>#</th><th>'+t('equip')+'</th><th>'+t('dailyTimeMin')+'</th><th>'+t('worst5Hdr')[4]+'</th></tr></thead><tbody>';
    tw5.forEach(function(item,i){h+='<tr><td>'+(i+1)+'</td><td>'+item.eq+'</td><td><span style="color:#f59e0b;font-weight:700">'+Math.round(item.time).toLocaleString()+t('min')+'</span></td><td style="text-align:left;font-size:10px">'+_topSubs(item.subs)+'</td></tr>';});
    if(!tw5.length)h+='<tr><td colspan="4" style="color:#94a3b8">'+t('noData')+'</td></tr>';
    h+='</tbody></table></div>';
    h+='<div class="worst-card"><h4 style="color:#ef4444">'+t('worst5Def')+'</h4>';
    h+='<table class="worst-tbl"><thead><tr><th>#</th><th>'+t('equip')+'</th><th>'+t('defect')+'</th><th>'+t('worst5Hdr')[4]+'</th></tr></thead><tbody>';
    dw5.forEach(function(item,i){h+='<tr><td>'+(i+1)+'</td><td>'+item.eq+'</td><td><span style="color:#ef4444;font-weight:700">'+Math.round(item.def).toLocaleString()+'</span></td><td style="text-align:left;font-size:10px">'+_topSubs(item.subs)+'</td></tr>';});
    if(!dw5.length)h+='<tr><td colspan="4" style="color:#94a3b8">'+t('noData')+'</td></tr>';
    h+='</tbody></table></div></div></div>';
  }

  // --- 7~10) ê²€ì‚¬ê¸° ê´€ë ¨ ---
  if(dates.length>0){
    var inspRows=D.inspAllRows||[];
    var iLines=['K','G','H'];
    var iColors={K:'#f59e0b',G:'#06b6d4',H:'#22c55e'};
    var iLastDate=dates[dates.length-1];
    var iLastIdx=dates.indexOf(iLastDate);
    var iWeek=dates.slice(Math.max(0,iLastIdx-6),iLastIdx+1);
    function _iSum(dts,line){var d=0,tm=0;dts.forEach(function(ds){inspRows.forEach(function(r){if(r.dateStr===ds&&(!line||r.line===line)){d+=r.defect;if(r.stop)tm+=r.kpiTime||0;}});});return{def:Math.round(d),time:Math.round(tm)};}

    // 7) ê²€ì‚¬ê¸° ì¡°ì •í˜„í™©
    h+='<div class="bx"><h3>'+t('inspKpi')+' ('+t('prevDay')+': '+iLastDate+')</h3>';
    h+='<table class="sum-tbl" style="font-size:12px"><thead><tr><th></th><th style="color:#60a5fa">'+t('total')+'</th>';
    iLines.forEach(function(ln){h+='<th style="color:'+iColors[ln]+'">'+ln+' Line</th>';});
    h+='</tr></thead><tbody>';
    var iAll=_iSum([iLastDate],null);
    h+='<tr><td style="font-size:10px;color:#94a3b8">'+t('inspDefW')+'</td>';
    h+='<td style="color:#ef4444;font-weight:700;cursor:pointer;text-decoration:underline" onclick="showInspDetail(\'prev\',null)">'+iAll.def.toLocaleString()+'</td>';
    iLines.forEach(function(ln){var v=_iSum([iLastDate],ln);h+='<td style="color:#ef4444;cursor:pointer;text-decoration:underline" onclick="showInspDetail(\'prev\',\''+ln+'\')">'+v.def.toLocaleString()+'</td>';});
    h+='</tr><tr><td style="font-size:10px;color:#94a3b8">'+t('inspTimeW')+'</td>';
    h+='<td style="color:#60a5fa;font-weight:700;cursor:pointer;text-decoration:underline" onclick="showInspDetail(\'prev\',null)">'+iAll.time.toLocaleString()+t('min')+'</td>';
    iLines.forEach(function(ln){var v=_iSum([iLastDate],ln);h+='<td style="color:#60a5fa;cursor:pointer;text-decoration:underline" onclick="showInspDetail(\'prev\',\''+ln+'\')">'+v.time.toLocaleString()+t('min')+'</td>';});
    h+='</tr></tbody></table></div>';

    // 8) ì™„ì „ì¹˜ìˆ˜ë¶ˆëŸ‰ ê·¸ë˜í”„
    h+='<div class="bx"><h3 style="display:flex;align-items:center;flex-wrap:wrap">'+t('inspDefChart');
    h+='<span style="margin-left:auto;display:flex;gap:6px;font-size:9px;font-weight:400">';
    h+='<span style="display:flex;align-items:center;gap:2px"><span style="display:inline-block;width:14px;height:3px;background:#3b82f6"></span>K1</span>';
    h+='<span style="display:flex;align-items:center;gap:2px"><span style="display:inline-block;width:14px;height:3px;background:#8b5cf6"></span>K2</span>';
    h+='<span style="display:flex;align-items:center;gap:2px"><span style="display:inline-block;width:14px;height:3px;background:#06b6d4"></span>G</span>';
    h+='<span style="display:flex;align-items:center;gap:2px"><span style="display:inline-block;width:14px;height:3px;background:#22c55e"></span>H</span>';
    h+='</span></h3>';
    h+='<canvas id="ovInspChart" style="max-height:200px"></canvas></div>';

    // 9) ì™„ì „+ì¹˜ìˆ˜ í˜„í™©
    var iLines2=[{ln:'K1',key:'cd'},{ln:'K2',key:'cd'},{ln:'G',key:'cd'},{ln:'H',key:'dd'}];
    h+='<div class="bx"><h3>'+t('ovInspTblTitle')+'</h3><div class="hc">';
    h+='<table class="ht"><thead><tr><th>'+t('line')+'</th>';
    dates.forEach(function(d){var dt=new Date(d+'T00:00:00');h+='<th>'+(dt.getMonth()+1)+'/'+(dt.getDate())+'</th>';});
    h+='</tr></thead><tbody>';
    var iVals=[];
    iLines2.forEach(function(cfg){dates.forEach(function(dt){var dd=D.lossByLineDate[dt]&&D.lossByLineDate[dt][cfg.ln];if(dd&&dd.p>0){var vv=dd[cfg.key]/dd.p*100;if(vv>0)iVals.push(vv);}});});
    var iMx=iVals.length?Math.max.apply(null,iVals):1;
    iLines2.forEach(function(cfg){
      h+='<tr><th>'+cfg.ln+'</th>';
      dates.forEach(function(dt){var dd=D.lossByLineDate[dt]&&D.lossByLineDate[dt][cfg.ln];var v=0;if(dd&&dd.p>0)v=dd[cfg.key]/dd.p*100;h+='<td style="'+getHmStyle(v,iMx,'def')+'">'+((v>0)?v.toFixed(2)+'%':'')+'</td>';});
      h+='</tr>';
    });
    h+='</tbody></table></div></div>';

    // 10) ê²€ì‚¬ê¸° ë¶ˆëŸ‰,ì •ì§€ Worst 5 (1ê°œ í…Œì´ë¸”)
    var iEqMap={};
    iWeek.forEach(function(ds){inspRows.forEach(function(r){if(r.dateStr===ds){if(!iEqMap[r.eq])iEqMap[r.eq]={eq:r.eq,def:0,time:0};iEqMap[r.eq].def+=r.defect;if(r.stop)iEqMap[r.eq].time+=(r.kpiTime||0);}});});
    var iByDef=Object.keys(iEqMap).map(function(k){return iEqMap[k];}).sort(function(a,b){return b.def-a.def}).slice(0,5);
    h+='<div class="bx"><h4 style="margin-bottom:8px;font-size:12px">'+t('ovInspWorstTitle')+'</h4>';
    h+='<table class="worst-tbl"><thead><tr><th>#</th><th>'+t('equip')+'</th><th style="color:#ef4444">'+t('inspDefW')+'</th><th style="color:#60a5fa">'+t('inspTimeW')+'</th></tr></thead><tbody>';
    iByDef.forEach(function(item,i){h+='<tr style="cursor:pointer" onclick="showInspEqDetail(\''+item.eq.replace(/'/g,"\\'")+'\',\'week\')"><td>'+(i+1)+'</td><td>'+item.eq+'</td><td style="color:#ef4444;font-weight:700">'+Math.round(item.def).toLocaleString()+'</td><td style="color:#60a5fa;font-weight:700">'+Math.round(item.time).toLocaleString()+t('min')+'</td></tr>';});
    if(!iByDef.length)h+='<tr><td colspan="4" style="color:#94a3b8">'+t('noData')+'</td></tr>';
    h+='</tbody></table></div>';
  }
  return h;
}

// ìš”ì•½ ì°¨íŠ¸ ì´ˆê¸°í™”
function initOverviewLossChart(){
  var canvas=document.getElementById('ovLossChart');
  if(!canvas||!D||!D.lossDates||!D.lossDates.length)return;
  var dates=D.lossDates;var lines=['K1','K2','G','H','E'];
  var datasets=lines.map(function(ln){return{label:ln,data:dates.map(function(dt){var v=D.lossByLineDate[dt]&&D.lossByLineDate[dt][ln];return v&&v.r>0?Math.round(v.r*10000)/100:null;}),borderColor:LOSS_LINE_COLORS[ln],backgroundColor:'transparent',pointRadius:2,tension:0.3,spanGaps:true,borderWidth:1.5};});
  datasets.push({label:'Total',data:dates.map(function(dt){var tp=0,tl=0;lines.forEach(function(l){var dd=D.lossByLineDate[dt]&&D.lossByLineDate[dt][l];if(dd){tp+=dd.p;tl+=dd.p*dd.r;}});return tp>0?Math.round(tl/tp*10000)/100:null;}),borderColor:LOSS_LINE_COLORS.Total,backgroundColor:'transparent',pointRadius:2,tension:0.3,spanGaps:true,borderWidth:2});
  datasets.push({label:t('target')+'(6%)',data:dates.map(function(){return 6;}),borderColor:'#f59e0b',borderDash:[5,5],pointRadius:0,tension:0});
  var _lossLbl={id:'ovLossLbl',afterDatasetsDraw:function(chart){var ctx=chart.ctx;ctx.save();ctx.font='11px sans-serif';ctx.textAlign='center';ctx.textBaseline='bottom';var numDs=chart.data.datasets.length-1;for(var i=0;i<chart.data.labels.length;i++){var mx=-1,mxDs=-1;for(var d=0;d<numDs;d++){var v=chart.data.datasets[d].data[i];if(v!=null&&v>mx){mx=v;mxDs=d;}}if(mxDs>=0&&mx>0){var pt=chart.getDatasetMeta(mxDs).data[i];ctx.fillStyle=chart.data.datasets[mxDs].borderColor;ctx.fillText(Math.round(mx)+'%',pt.x,pt.y-4);}}ctx.restore();}};
  var ch=new Chart(canvas,{type:'line',plugins:[_lossLbl],data:{labels:dates.map(function(d){var dt=new Date(d+'T00:00:00');return(dt.getMonth()+1)+'/'+(dt.getDate());}),datasets:datasets},
    options:{responsive:true,maintainAspectRatio:true,aspectRatio:2.5,plugins:{legend:{display:false}},
      scales:{x:{ticks:{color:'#94a3b8',font:{size:9}},grid:{color:'#1f2937'}},y:{ticks:{color:'#94a3b8',font:{size:9},callback:function(v){return v+'%'}},grid:{color:'#1f2937'},min:0}}}});
  charts.push(ch);
}
function initOverviewUtilChart(){
  var canvas=document.getElementById('ovUtilChart');
  if(!canvas||!D||!D.lossDates||!D.lossDates.length)return;
  var dates=D.lossDates;
  var data=dates.map(function(dt){var dd=D.lossByLineDate[dt]&&D.lossByLineDate[dt].Total;if(!dd||!dd.u||dd.u<=0)return null;return dd.u>1?Math.round(dd.u*100)/100:Math.round(dd.u*10000)/100;});
  var _lp={id:'ovUtilLbl',afterDatasetsDraw:function(chart){var ds=chart.data.datasets[0];if(!ds)return;var meta=chart.getDatasetMeta(0);var ctx=chart.ctx;ctx.save();ctx.font='11px sans-serif';ctx.textAlign='center';ctx.textBaseline='bottom';meta.data.forEach(function(pt,i){var v=ds.data[i];if(v==null)return;ctx.fillStyle='#f87171';ctx.fillText(Math.round(v)+'%',pt.x,pt.y-5);});ctx.restore();}};
  var ch=new Chart(canvas,{type:'line',plugins:[_lp],data:{labels:dates.map(function(d){var dt=new Date(d+'T00:00:00');return(dt.getMonth()+1)+'/'+(dt.getDate());}),
    datasets:[{label:'Total '+t('utilRate'),data:data,borderColor:'#f87171',backgroundColor:'#f8717120',pointRadius:2,borderWidth:1.5,tension:0.3,fill:true,spanGaps:true},{label:t('utilTarget')+'(95%)',data:dates.map(function(){return 95;}),borderColor:'#f59e0b',borderDash:[5,5],pointRadius:0,tension:0,borderWidth:1}]},
    options:{responsive:true,maintainAspectRatio:true,aspectRatio:2.5,plugins:{legend:{display:false}},
      scales:{x:{ticks:{color:'#94a3b8',font:{size:9}},grid:{color:'#1f2937'}},y:{ticks:{color:'#94a3b8',font:{size:9},callback:function(v){return v+'%'}},grid:{color:'#1f2937'},min:50,max:110}}}});
  charts.push(ch);
}
function initOverviewInspChart(){
  var canvas=document.getElementById('ovInspChart');
  if(!canvas||!D||!D.lossDates||!D.lossDates.length)return;
  var dates=D.lossDates;
  var cfgs=[{ln:'K1',key:'cd',label:'K1 '+t('fullDef'),color:'#3b82f6'},{ln:'K2',key:'cd',label:'K2 '+t('fullDef'),color:'#8b5cf6'},{ln:'G',key:'cd',label:'G '+t('fullDef'),color:'#06b6d4'},{ln:'H',key:'dd',label:'H '+t('dimDef'),color:'#22c55e'}];
  var datasets=cfgs.map(function(cfg){return{label:cfg.label,data:dates.map(function(dt){var d=D.lossByLineDate[dt]&&D.lossByLineDate[dt][cfg.ln];if(!d||!d.p||d.p<=0)return null;var v=d[cfg.key];return v>0?Math.round(v/d.p*10000)/100:null;}),borderColor:cfg.color,backgroundColor:'transparent',pointRadius:2,tension:0.3,spanGaps:true,borderWidth:1.5};});
  var _inspLbl={id:'ovInspLbl',afterDatasetsDraw:function(chart){var ctx=chart.ctx;ctx.save();ctx.font='11px sans-serif';ctx.textAlign='center';ctx.textBaseline='bottom';var numDs=chart.data.datasets.length;for(var i=0;i<chart.data.labels.length;i++){var mx=-1,mxDs=-1;for(var d=0;d<numDs;d++){var v=chart.data.datasets[d].data[i];if(v!=null&&v>mx){mx=v;mxDs=d;}}if(mxDs>=0&&mx>0){var pt=chart.getDatasetMeta(mxDs).data[i];ctx.fillStyle=chart.data.datasets[mxDs].borderColor;ctx.fillText(Math.round(mx)+'%',pt.x,pt.y-4);}}ctx.restore();}};
  var ch=new Chart(canvas,{type:'line',plugins:[_inspLbl],data:{labels:dates.map(function(d){var dt=new Date(d+'T00:00:00');return(dt.getMonth()+1)+'/'+(dt.getDate());}),datasets:datasets},
    options:{responsive:true,maintainAspectRatio:true,aspectRatio:2.5,plugins:{legend:{display:false}},
      scales:{x:{ticks:{color:'#94a3b8',font:{size:9}},grid:{color:'#1f2937'}},y:{ticks:{color:'#94a3b8',font:{size:9},callback:function(v){return v+'%'}},grid:{color:'#1f2937'},min:0}}}});
  charts.push(ch);
}
function initOverviewDailyChart(){
  var canvas=document.getElementById('ovDailyChart');
  if(!canvas||!D||!D.daily||!D.daily.length)return;
  var data=D.daily;
  var labels=data.map(function(r){return r['ì¼ìstr'];});
  var barData=data.map(function(r){return Math.round(r.avgTime||0);});
  var lineData=data.map(function(r){return Math.round(r.defect);});
  var _dailyLbl={id:'ovDailyLbl',afterDatasetsDraw:function(chart){var ctx=chart.ctx;ctx.save();
    // ë§‰ëŒ€(ì •ì§€ì‹œê°„) ë°” ì•ˆìª½ í•˜ë‹¨(ì¼ì ìœ„) í°ìƒ‰
    var barDs=chart.data.datasets[0];var barMeta=chart.getDatasetMeta(0);
    ctx.font='11px sans-serif';ctx.textAlign='center';ctx.fillStyle='#fff';
    barMeta.data.forEach(function(bar,i){var v=barDs.data[i];if(v>0){ctx.textBaseline='bottom';ctx.fillText(v+t('min'),bar.x,bar.base-2);}});
    // êº¾ì€ì„ (ë¶ˆëŸ‰ìˆ˜ëŸ‰) ìœ„ ë¹¨ê°„ìƒ‰ kë‹¨ìœ„
    if(chart.data.datasets.length>1){var lineDs2=chart.data.datasets[1];var lineMeta2=chart.getDatasetMeta(1);ctx.fillStyle='#ef4444';ctx.textBaseline='bottom';
    lineMeta2.data.forEach(function(pt,i){var v=lineDs2.data[i];if(v!=null&&v>0){var txt=v>=1000?Math.round(v/1000)+'k':v.toString();ctx.fillText(txt,pt.x,pt.y-4);}});}
    ctx.restore();}};
  var ch=new Chart(canvas,{type:'bar',plugins:[_dailyLbl],data:{labels:labels,datasets:[
    {label:t('dailyTimeMin'),data:barData,backgroundColor:'#3b82f6B3',borderRadius:4,yAxisID:'y',order:2},
    {label:t('defect'),data:lineData,type:'line',borderColor:'#ef4444',borderWidth:1.5,pointRadius:2,pointBackgroundColor:'#ef4444',yAxisID:'y1',tension:.3,order:1}
  ]},options:{responsive:true,maintainAspectRatio:true,aspectRatio:2.5,plugins:{legend:{display:false},tooltip:{backgroundColor:'#0a0a0a',bodyColor:'#e2e8f0'}},scales:{
    x:{ticks:{color:'#94a3b8',font:{size:9}},grid:{color:'#1a1a1a'}},
    y:{position:'left',ticks:{color:'#3b82f6',font:{size:8}},grid:{color:'#1a1a1a'},beginAtZero:true},
    y1:{position:'right',ticks:{color:'#ef4444',font:{size:8},callback:function(v){return v>=1000?(v/1000)+'k':v;}},grid:{drawOnChartArea:false},beginAtZero:true}
  }}});
  charts.push(ch);
}
// ===================== ìš”ì•½ ë =====================

function buildLossPage(){
  if(!D)return'<div style="padding:20px;color:#94a3b8">'+t('noData')+'</div>';
  var h='';
  // ì¼ê°„ Loss í˜„í™© íˆíŠ¸ë§µ í…Œì´ë¸”
  h+='<div class="bx"><h3 style="display:flex;align-items:center;flex-wrap:wrap">'+t('lossTitle');
  h+='<span style="margin-left:auto;display:flex;gap:6px;align-items:center">'+buildHmSettings('loss')+'</span></h3>';
  h+='<div class="hc">';
  _buildLossDailyTableOnly=true;h+=buildLossDaily();_buildLossDailyTableOnly=false;
  h+='</div></div>';
  // ìƒì„¸ Loss í˜„í™©
  h+='<div class="bx"><h3 style="display:flex;align-items:center;flex-wrap:wrap">'+t('lossDetail');
  h+='<span style="margin-left:auto;display:flex;gap:6px;align-items:center">'+buildHmSettings('loss')+'</span></h3>';
  h+=buildLossDetail();
  h+='</div>';
  return h;
}

function buildLossDaily(){
  var dates=D.lossDates||[];
  if(!dates.length){var dbg=D._lossDbg||{};return'<div style="color:#94a3b8;padding:16px;font-size:12px">âš  '+t('lossNoData')+'<br>'+t('stMatched')+dbg.found+'<br>'+t('stAllSheets')+((dbg.sheets||[]).join(', '))+'<br>rows:'+dbg.rows+'<br>sample:'+dbg.sample+'</div>';}
  var lines=['K1','K2','G','H','E'];
  var all=lines.concat(['Total']);
  var lossCfg=_hmCfg.loss||{pal:'green_red',axis:'all'};
  // 1) ëª¨ë“  ê°’ ë¯¸ë¦¬ ê³„ì‚°
  var vals={},accumVals={},allMx=0;
  all.forEach(function(ln){
    var isT=ln==='Total';
    var accum;
    if(isT){var tp=0,tl=0;lines.forEach(function(l){var a=D.lossAccumByLine[l]||{prod:0,loss:0};tp+=a.prod;tl+=a.loss;});accum=tp>0?tl/tp:0;}
    else{var a2=D.lossAccumByLine[ln]||{prod:0,loss:0};accum=a2.prod>0?a2.loss/a2.prod:0;}
    accumVals[ln]=accum;if(!isT&&accum>allMx)allMx=accum;
    vals[ln]={};
    dates.forEach(function(dt){
      var v;
      if(isT){var tp2=0,tl2=0;lines.forEach(function(l){var dd=D.lossByLineDate[dt]&&D.lossByLineDate[dt][l];if(dd){tp2+=dd.p;tl2+=dd.p*dd.r;}});v=tp2>0?tl2/tp2:0;}
      else{var dd2=D.lossByLineDate[dt]&&D.lossByLineDate[dt][ln];v=dd2?dd2.r:0;}
      vals[ln][dt]=v;if(!isT&&v>allMx)allMx=v;
    });
  });
  // 2) ê¸°ì¤€ë³„ max
  var rowMx={},colMx={};
  var lossFloor=(allMx||0.01)*0.3;
  if(lossCfg.axis==='row'){lines.forEach(function(ln){var rm=accumVals[ln];dates.forEach(function(dt){if(vals[ln][dt]>rm)rm=vals[ln][dt]});rowMx[ln]=Math.max(rm,lossFloor)||0.01})}
  if(lossCfg.axis==='col'){colMx['_accum']=0;lines.forEach(function(ln){if(accumVals[ln]>colMx['_accum'])colMx['_accum']=accumVals[ln]});dates.forEach(function(dt){var cm=0;lines.forEach(function(ln){if(vals[ln][dt]>cm)cm=vals[ln][dt]});colMx[dt]=Math.max(cm,lossFloor)||0.01});colMx['_accum']=Math.max(colMx['_accum'],lossFloor)||0.01}
  function getLossMx(ln,dt){if(lossCfg.axis==='row')return rowMx[ln]||0.01;if(lossCfg.axis==='col')return colMx[dt]||0.01;return allMx||0.01}
  // 3) ë Œë”ë§
  var thS='background:#1a1a1a;color:#e2e8f0;padding:5px 8px;font-size:11px;border:1px solid #333;white-space:nowrap;text-align:center';
  var tdS='padding:4px 8px;font-size:11px;border:1px solid #333;text-align:center;white-space:nowrap;background:#000;color:#cbd5e1';
  var stickyA='position:sticky;left:0;z-index:1;';
  var h='<div class="hc">';
  h+='<table class="ht" style="min-width:max-content"><thead><tr>';
  h+='<th style="'+thS+';'+stickyA+'background:#1a1a1a;min-width:52px">'+t('line')+'</th>';
  h+='<th style="'+thS+';background:#1a1a1a;min-width:70px">'+t('accum')+'</th>';
  dates.forEach(function(dt){var d=new Date(dt+'T00:00:00');h+='<th style="'+thS+'">'+(d.getMonth()+1)+'/'+(d.getDate())+'</th>';});
  h+='</tr></thead><tbody>';
  all.forEach(function(ln){
    var isT=ln==='Total';
    var lc=LOSS_LINE_COLORS[ln]||'#94a3b8';
    var rowBg=isT?'background:#1a1a1a;':'';
    h+='<tr style="'+rowBg+'">';
    h+='<td style="'+tdS+';'+stickyA+'background:'+(isT?'#1a1a1a':'#111')+';color:'+(isT?'#e2e8f0':lc)+';font-weight:700;min-width:52px">'+ln+' Line</td>';
    var accum=accumVals[ln];
    h+='<td style="'+tdS+';'+getHmStyle(accum,getLossMx(ln,'_accum'),'loss')+';font-weight:700;min-width:70px">'+fmtLoss(accum)+'</td>';
    dates.forEach(function(dt){
      var v=vals[ln][dt];
      h+='<td style="'+tdS+';'+getHmStyle(v,getLossMx(ln,dt),'loss')+'">'+fmtLoss(v)+'</td>';
    });
    h+='</tr>';
  });
  // ëª©í‘œí–‰
  h+='<tr><td style="'+tdS+';'+stickyA+'background:#1a1a1a;color:#e65523;font-weight:700;min-width:52px">'+t('target')+'</td>';
  h+='<td style="'+tdS+';background:#1a1a1a;color:#e65523;font-weight:700;min-width:70px">6.00%</td>';
  dates.forEach(function(){h+='<td style="'+tdS+';color:#e65523">6.00%</td>';});
  h+='</tr></tbody></table></div>';
  if(_buildLossDailyTableOnly)return h;
  h+='</div><div class="bx"><h3>ğŸ“ˆ '+t('lossDaily')+' '+t('lossRate')+' '+t('worst5Trend')+'</h3>';
  h+='<canvas id="lossChart"></canvas>';
  return h;
}
var _buildLossDailyTableOnly=false;

function buildLossDetail(){
  var dates=D.lossDates&&D.lossDates.length?D.lossDates:(D.stDates||[]);
  if(!dates.length)return'<div style="color:#94a3b8;padding:20px">'+t('noData')+'</div>';
  if(!_lossDate||dates.indexOf(_lossDate)<0)_lossDate=dates[dates.length-1];
  var selS='background:#1a1a1a;color:#e2e8f0;border:1px solid #3b82f6;border-radius:6px;padding:5px 10px;font-size:13px;margin-left:6px';
  var h='<div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:12px;align-items:center">';
  h+='<div><label style="color:#94a3b8;font-size:13px">'+t('date')+'</label><select onchange="setLossDetail(this.value,\'date\')" style="'+selS+'">';
  dates.slice().reverse().forEach(function(d){h+='<option value="'+d+'"'+(d===_lossDate?' selected':'')+'>'+d+'</option>';});
  h+='</select></div>';
  h+='</div>';
  var dateData=D.lossDetailByDateEq[_lossDate]||{};
  var eqList=Object.keys(dateData).filter(function(eq){var d=dateData[eq];return d.prod>0||d.larr.some(function(v){return v>0;});}).sort();
  if(!eqList.length)return h+'<div style="color:#94a3b8;padding:20px">'+t('selDateLine')+'</div>';
  var thS='background:#1a1a1a;color:#e2e8f0;padding:5px 8px;font-size:11px;border:1px solid #333;white-space:nowrap;text-align:center';
  var tdS='padding:4px 8px;font-size:11px;border:1px solid #333;text-align:center;white-space:nowrap;background:#000;color:#cbd5e1';
  var stkL='position:sticky;left:0;z-index:1;';
  h+='<div style="overflow-x:auto;-webkit-overflow-scrolling:touch">';
  h+='<table style="border-collapse:collapse;min-width:max-content"><thead><tr>';
  h+='<th style="'+thS+';'+stkL+'background:#1a1a1a;min-width:56px">'+t('equip')+'</th>';
  h+='<th style="'+thS+'">'+t('plan')+'</th><th style="'+thS+'">'+t('prod')+'</th><th style="'+thS+'">'+t('utilRate')+'</th><th style="'+thS+'">'+t('lossRate')+'</th>';
  var _hdr=t('lossDetailHdr');
  var _nCols=_hdr.length;
  _hdr.forEach(function(c){h+='<th style="'+thS+'">'+c+'</th>';});
  h+='</tr></thead><tbody>';
  var totProd=0,totCapa=0,totLarr=new Array(_nCols).fill(0);
  var dtlCfg=_hmCfg.loss||{pal:'green_red',axis:'all'};
  // 1) ëª¨ë“  ì…€ ê°’ ë¯¸ë¦¬ ê³„ì‚°
  var eqVals={},allDtlMx=0;
  var colMaxLoss=0,colMaxArr=new Array(_nCols).fill(0);
  eqList.forEach(function(eq){
    var d=dateData[eq],prod=d.prod||0;
    var lossSum=0;d.larr.forEach(function(v){lossSum+=v;});
    var lossR=prod>0?lossSum/prod:0;
    if(lossR>colMaxLoss)colMaxLoss=lossR;if(lossR>allDtlMx)allDtlMx=lossR;
    var pcts=d.larr.map(function(v,i){var p=prod>0&&v>0?v/prod:0;if(p>colMaxArr[i])colMaxArr[i]=p;if(p>allDtlMx)allDtlMx=p;return p;});
    eqVals[eq]={lossR:lossR,pcts:pcts};
  });
  // 2) ê¸°ì¤€ë³„ max (í–‰=ì„¤ë¹„, ì—´=Lossí•­ëª©) - ì „ì²´maxì˜ 30%ë¥¼ í•˜í•œìœ¼ë¡œ ì ìš©
  var dtlRowMx={},dtlColMx={},dtlFloor=(allDtlMx||0.001)*0.3;
  if(dtlCfg.axis==='row'){eqList.forEach(function(eq){var rm=eqVals[eq].lossR;eqVals[eq].pcts.forEach(function(p){if(p>rm)rm=p});dtlRowMx[eq]=Math.max(rm,dtlFloor)||0.001})}
  if(dtlCfg.axis==='col'){dtlColMx['_loss']=Math.max(colMaxLoss,dtlFloor)||0.001;for(var ci=0;ci<_nCols;ci++)dtlColMx[ci]=Math.max(colMaxArr[ci],dtlFloor)||0.001}
  function getDtlMx(eq,colIdx){if(dtlCfg.axis==='row')return dtlRowMx[eq]||(allDtlMx||0.001);if(dtlCfg.axis==='col')return dtlColMx[colIdx]||0.001;return allDtlMx||0.001}
  // 3) ë Œë”ë§
  eqList.forEach(function(eq){
    var d=dateData[eq];
    var prod=d.prod||0;
    var stA=getSTActual(eq)||(d.st>0?d.st:0);
    var capa=stA>0?Math.round(86400/stA):0;
    var util=capa>0?prod/capa:0;
    var ev=eqVals[eq];
    totProd+=prod;totCapa+=capa;
    h+='<tr><td style="'+tdS+';'+stkL+'background:#1a1a1a;color:#1a6cb5;font-weight:700;min-width:56px">'+eq+'</td>';
    h+='<td style="'+tdS+'">'+capa.toLocaleString()+'</td>';
    h+='<td style="'+tdS+'">'+Math.round(prod).toLocaleString()+'</td>';
    h+='<td style="'+tdS+';color:'+(util>=0.9?'#22c55e':util>=0.7?'#f59e0b':'#ef4444')+'">'+( util>0?(util*100).toFixed(1)+'%':'-')+'</td>';
    h+='<td style="'+tdS+';'+getHmStyle(ev.lossR,getDtlMx(eq,'_loss'),'loss')+'">'+fmtLoss(ev.lossR)+'</td>';
    d.larr.forEach(function(v,i){
      totLarr[i]+=v;
      var pct=ev.pcts[i];
      var cellTxt;
      if(i===9&&v>0&&prod===0){cellTxt=Math.round(v).toLocaleString();}
      else{cellTxt=pct>0?(pct*100).toFixed(2)+'%':'-';}
      var sty=getHmStyle(pct,getDtlMx(eq,i),'loss');
      if(i===9&&v>0&&d.techNotes&&d.techNotes.length>0){
        h+='<td style="'+tdS+';'+sty+';cursor:pointer;text-decoration:underline" onclick="showTechPopup(\''+_lossDate+'\',\''+eq+'\')">'+ cellTxt+'</td>';
      } else {
        h+='<td style="'+tdS+';'+sty+'">'+cellTxt+'</td>';
      }
    });
    h+='</tr>';
  });
  // Total í–‰
  var totUtil=totCapa>0?totProd/totCapa:0;
  var totLossSum=0;totLarr.forEach(function(v){totLossSum+=v;});
  var totLoss=totProd>0?totLossSum/totProd:0;
  h+='<tr style="background:#1a1a1a;font-weight:700">';
  h+='<td style="'+tdS+';'+stkL+'background:#1a1a1a;color:#e2e8f0;min-width:56px">'+t('total')+'</td>';
  h+='<td style="'+tdS+'">'+totCapa.toLocaleString()+'</td>';
  h+='<td style="'+tdS+'">'+Math.round(totProd).toLocaleString()+'</td>';
  h+='<td style="'+tdS+';color:'+(totUtil>=0.9?'#22c55e':totUtil>=0.7?'#f59e0b':'#ef4444')+'">'+( totUtil>0?(totUtil*100).toFixed(1)+'%':'-')+'</td>';
  h+='<td style="'+tdS+';'+getHmStyle(totLoss,getDtlMx('_total','_loss'),'loss')+'">'+fmtLoss(totLoss)+'</td>';
  totLarr.forEach(function(v,i){
    var pct=totProd>0&&v>0?v/totProd:0;
    var cellTxt;
    if(i===9&&v>0&&totProd===0){cellTxt=Math.round(v).toLocaleString();}
    else{cellTxt=pct>0?(pct*100).toFixed(2)+'%':'-';}
    h+='<td style="'+tdS+';'+getHmStyle(pct,getDtlMx('_total',i),'loss')+'">'+cellTxt+'</td>';
  });
  h+='</tr>';
  h+='</tbody></table></div>';
  return h;
}

function renderLoss(subView){
  _lossSubView='detail';
  var panel=document.getElementById('lossPanel');
  if(panel){panel.innerHTML=buildLossPage();
    setTimeout(function(){panel.querySelectorAll('.hc').forEach(function(el){el.scrollLeft=el.scrollWidth;});},50);}
}
function setLossDetail(val,field){
  if(field==='date')_lossDate=val; else if(field==='line')_lossLine=val;
  renderLoss('detail');
}
function initLossChart(){
  var canvas=document.getElementById('lossChart');
  if(!canvas||!D||!D.lossDates||!D.lossDates.length)return;
  var dates=D.lossDates;
  var lines=['K1','K2','G','H','E'];
  var datasets=lines.map(function(ln){
    return{label:ln,data:dates.map(function(dt){var v=D.lossByLineDate[dt]&&D.lossByLineDate[dt][ln];return v&&v.r>0?Math.round(v.r*10000)/100:null;}),
      borderColor:LOSS_LINE_COLORS[ln],backgroundColor:'transparent',pointRadius:3,tension:0.3,spanGaps:true};
  });
  // Total ì¶”ê°€ (ê°€ì¤‘í‰ê· )
  datasets.push({label:'Total',data:dates.map(function(dt){
    var tp=0,tl=0;lines.forEach(function(l){var dd=D.lossByLineDate[dt]&&D.lossByLineDate[dt][l];if(dd){tp+=dd.p;tl+=dd.p*dd.r;}});
    return tp>0?Math.round(tl/tp*10000)/100:null;
  }),borderColor:LOSS_LINE_COLORS.Total,backgroundColor:'transparent',pointRadius:3,tension:0.3,spanGaps:true,borderWidth:2});
  datasets.push({label:t('target')+'(6%)',data:dates.map(function(){return 6;}),borderColor:'#f59e0b',borderDash:[5,5],pointRadius:0,tension:0});
  var ctx=canvas.getContext('2d');
  var ch=new Chart(ctx,{type:'line',
    data:{labels:dates.map(function(d){var dt=new Date(d+'T00:00:00');return(dt.getMonth()+1)+'/'+(dt.getDate());}),datasets:datasets},
    options:{responsive:true,maintainAspectRatio:true,aspectRatio:2,
      plugins:{legend:{labels:{color:'#94a3b8',font:{size:11}}}},
      scales:{x:{ticks:{color:'#94a3b8',font:{size:10}},grid:{color:'#1f2937'}},
        y:{ticks:{color:'#94a3b8',font:{size:10},callback:function(v){return v+'%'}},grid:{color:'#1f2937'},min:0,
          title:{display:true,text:t('lossRate')+'(%)',color:'#64748b',font:{size:10}}}}}});
  charts.push(ch);
}
// ===================== LOSS ë =====================

// ===================== ê°€ë™ìœ¨í˜„í™© =====================
function buildUtilPage(){
  if(!D||!D.lossDates||!D.lossDates.length)return'<div style="padding:20px;color:#94a3b8">'+t('noData')+'</div>';
  var dates=D.lossDates;
  var lineGroups=[
    {key:'Total',color:'#f87171',label:'Total'},
    {key:'K1',color:'#3b82f6',label:'K1'},
    {key:'K2',color:'#8b5cf6',label:'K2'},
    {key:'G',color:'#06b6d4',label:'G'},
    {key:'H',color:'#22c55e',label:'H'},
    {key:'E',color:'#f59e0b',label:'E'}
  ];
  var h='';
  lineGroups.forEach(function(g){
    h+='<div class="bx" style="border-left:3px solid '+g.color+'"><h3>ğŸ“Š '+g.label+' '+t('utilTitle')+'</h3>';
    h+='<canvas id="utilChart_'+g.key+'"></canvas></div>';
  });
  return h;
}

function initUtilCharts(){
  if(!D||!D.lossDates||!D.lossDates.length)return;
  var dates=D.lossDates;
  var lineGroups=[
    {key:'Total',color:'#f87171'},
    {key:'K1',color:'#3b82f6'},
    {key:'K2',color:'#8b5cf6'},
    {key:'G',color:'#06b6d4'},
    {key:'H',color:'#22c55e'},
    {key:'E',color:'#f59e0b'}
  ];
  lineGroups.forEach(function(g){
    var canvas=document.getElementById('utilChart_'+g.key);
    if(!canvas)return;
    var data=dates.map(function(dt){
      var dd=D.lossByLineDate[dt]&&D.lossByLineDate[dt][g.key];
      if(!dd||!dd.u||dd.u<=0)return null;
      // ì†Œìˆ˜(0.85)ë©´ Ã—100, ì´ë¯¸ ë°±ë¶„ìœ¨(85.5)ì´ë©´ ê·¸ëŒ€ë¡œ
      var uv=dd.u>1?dd.u:dd.u*100;
      return Math.round(uv*100)/100;
    });
    var _utilLabelPlugin={id:'utilLabel_'+g.key,afterDatasetsDraw:function(chart){
      var ds=chart.data.datasets[0];if(!ds)return;
      var meta=chart.getDatasetMeta(0);
      var ctx=chart.ctx;ctx.save();ctx.font='bold 10px sans-serif';ctx.textAlign='center';ctx.textBaseline='bottom';
      meta.data.forEach(function(pt,i){var v=ds.data[i];if(v==null)return;ctx.fillStyle=g.color;ctx.fillText(Math.round(v)+'%',pt.x,pt.y-5);});
      ctx.restore();
    }};
    var ch=new Chart(canvas,{type:'line',
      plugins:[_utilLabelPlugin],
      data:{labels:dates.map(function(d){var dt=new Date(d+'T00:00:00');return(dt.getMonth()+1)+'/'+(dt.getDate());}),
        datasets:[
          {label:g.key+' '+t('utilRate'),data:data,borderColor:g.color,backgroundColor:g.color+'20',pointRadius:3,tension:0.3,fill:true,spanGaps:true},
          {label:t('utilTarget')+'(90%)',data:dates.map(function(){return 90;}),borderColor:'#f59e0b',borderDash:[5,5],pointRadius:0,tension:0}
        ]},
      options:{responsive:true,maintainAspectRatio:true,aspectRatio:3,
        plugins:{legend:{labels:{color:'#94a3b8',font:{size:11}}}},
        scales:{x:{ticks:{color:'#94a3b8',font:{size:10}},grid:{color:'#1f2937'}},
          y:{ticks:{color:'#94a3b8',font:{size:10},callback:function(v){return v+'%'}},grid:{color:'#1f2937'},min:50,max:110,
            title:{display:true,text:t('utilRate')+'(%)',color:'#64748b',font:{size:10}}}}}});
    charts.push(ch);
  });
}
// ===================== ê°€ë™ìœ¨ ë =====================

function renderAll(){
  charts.forEach(function(c){try{c.destroy()}catch(e){}});charts=[];
  if(!D)return;

  var ls=D.lineSummary||{};


  document.getElementById('tabArea').innerHTML=
    '<div class="tab on" onclick="go(0)">'+t('tabOverview')+'</div>'+
    '<div class="tab" onclick="go(1)">'+t('tabLoss')+'</div>'+
    '<div class="tab" onclick="go(2)">'+t('tabUtil')+'</div>'+
    '<div class="tab" onclick="go(3)">'+t('tabDaily')+'</div>'+
    '<div class="tab" onclick="go(4)">'+t('tabDefHm')+'</div>'+
    '<div class="tab" onclick="go(5)">'+t('tabStopHm')+'</div>'+
    '<div class="tab" onclick="go(6)">'+t('tabST')+'</div>'+
    '<div class="tab" onclick="go(7)">'+t('tabInsp')+'</div>';


  document.getElementById('root').innerHTML=
  '<div class="pn on" id="overviewPanel">'+buildOverviewPage()+'</div>'+
  '<div class="pn" id="lossPanel">'+buildLossPage()+'</div>'+
  '<div class="pn" id="utilPanel">'+buildUtilPage()+'</div>'+
  '<div class="pn">'+
    '<div class="bx"><h3>ğŸ“… '+t('allDaily')+'<em>Total '+D.totalRec.toLocaleString()+t('items')+'</em></h3><canvas id="dAll"></canvas></div>'+
    '<div class="bx"><h3>ğŸ“Š '+t('allStopVs')+'</h3><div class="hc" id="tAllS"></div></div>'+
    '<hr style="border:1px solid #1a1a1a;margin:20px 0">'+
    '<div class="bx" style="border-left:3px solid #06b6d4"><h3><span class="line-label" style="background:#06b6d420;color:#06b6d4">G Line</span> '+t('lineDaily').replace(' Line','')+'<em>'+((ls.G||{}).cnt||0).toLocaleString()+t('items')+' Â· '+t('equip')+' '+((ls.G||{}).eq||0)+t('eqUnit')+'</em></h3><canvas id="dG"></canvas></div>'+
    '<div class="bx" style="border-left:3px solid #06b6d4"><h3><span class="line-label" style="background:#06b6d420;color:#06b6d4">G Line</span> '+t('lineStopVs').replace(' Line','')+'</h3><div id="tGS"></div></div>'+
    '<hr style="border:1px solid #1a1a1a;margin:20px 0">'+
    '<div class="bx" style="border-left:3px solid #22c55e"><h3><span class="line-label" style="background:#22c55e20;color:#22c55e">H Line</span> '+t('lineDaily').replace(' Line','')+'<em>'+((ls.H||{}).cnt||0).toLocaleString()+t('items')+' Â· '+t('equip')+' '+((ls.H||{}).eq||0)+t('eqUnit')+'</em></h3><canvas id="dH"></canvas></div>'+
    '<div class="bx" style="border-left:3px solid #22c55e"><h3><span class="line-label" style="background:#22c55e20;color:#22c55e">H Line</span> '+t('lineStopVs').replace(' Line','')+'</h3><div id="tHS"></div></div>'+
    '<hr style="border:1px solid #1a1a1a;margin:20px 0">'+
    '<div class="bx" style="border-left:3px solid #f59e0b"><h3><span class="line-label" style="background:#f59e0b20;color:#f59e0b">K Line</span> '+t('lineDaily').replace(' Line','')+'<em>'+((ls.K||{}).cnt||0).toLocaleString()+t('items')+' Â· '+t('equip')+' '+((ls.K||{}).eq||0)+t('eqUnit')+'</em></h3><canvas id="dK"></canvas></div>'+
    '<div class="bx" style="border-left:3px solid #f59e0b"><h3><span class="line-label" style="background:#f59e0b20;color:#f59e0b">K Line</span> '+t('lineStopVs').replace(' Line','')+'</h3><div id="tKS"></div></div>'+
  '</div>'+
  '<div class="pn"><div class="bx"><h3 style="display:flex;align-items:center;flex-wrap:wrap">ğŸ”¥ '+t('hmDefTitle')+'<span style="margin-left:auto;display:flex;gap:6px;align-items:center" id="hm_def_settings">'+buildHmSettings('def')+'</span></h3>'+buildHmLegend('def')+'<div class="hc" id="hm_def"></div></div></div>'+
  '<div class="pn"><div class="bx"><h3 style="display:flex;align-items:center;flex-wrap:wrap">ğŸ”¥ '+t('hmStopTitle')+'<span style="margin-left:auto;display:flex;gap:6px;align-items:center" id="hm_time_settings">'+buildHmSettings('stop')+'</span></h3>'+buildHmLegend('stop')+'<div class="hc" id="hm_time"></div></div></div>'+
  '<div class="pn" id="stAnalysisPanel">'+buildSTAnalysisPage(D.stDates&&D.stDates.length?D.stDates[D.stDates.length-1]:'','daily')+'</div>'+
  '<div class="pn" id="inspPanel">'+buildInspPage()+'</div>';

  // Render inspection chart
  initInspChart();

  var maxTime=0,fixedQty=10000,exceeded=false;
  [D.daily_G,D.daily_H,D.daily_K].forEach(function(ld){ld.forEach(function(r){var t=Math.round(r.avgTime||0);if(t>maxTime)maxTime=t;var d=Math.round(r.defect);if(d>fixedQty){fixedQty=Math.ceil(d/1000)*1000;exceeded=true}})});
  var fixedTime=Math.ceil(maxTime*1.1/10)*10||100;
  if(exceeded){D.daily.forEach(function(r){var t=Math.round(r.avgTime||0);var ft=Math.ceil(t*1.1/10)*10;if(ft>fixedTime)fixedTime=ft;var d=Math.round(r.defect);if(d>fixedQty)fixedQty=Math.ceil(d/1000)*1000})}
  charts.push(makeDailyChart('dAll', D.daily, 'Total', '#3b82f6', null, exceeded?fixedTime:null, exceeded?fixedQty:null));
  document.getElementById('tAllS').innerHTML=buildStopTableWide(D.daily);
  charts.push(makeDailyChart('dG', D.daily_G, 'G Line', '#06b6d4', 'G', fixedTime, fixedQty));
  document.getElementById('tGS').innerHTML=buildStopTableWide(D.daily_G);
  charts.push(makeDailyChart('dH', D.daily_H, 'H Line', '#22c55e', 'H', fixedTime, fixedQty));
  document.getElementById('tHS').innerHTML=buildStopTableWide(D.daily_H);
  charts.push(makeDailyChart('dK', D.daily_K, 'K Line', '#f59e0b', 'K', fixedTime, fixedQty));
  document.getElementById('tKS').innerHTML=buildStopTableWide(D.daily_K);

  document.getElementById('hm_def').innerHTML=buildDailyHT(D.hm_def,'ë¶ˆëŸ‰ìˆ˜ëŸ‰',D.eq_order,D.all_dates,false,'def');
  // ì •ì§€íˆíŠ¸ë§µ: ìºì‹œ ë¬´ê´€í•˜ê²Œ í•­ìƒ åœë§Œ í•„í„°ë§í•˜ì—¬ ë Œë”ë§
  var _htStop={};
  (D.allRows||[]).forEach(function(rh){if(rh.stop){var k=rh.eq+'|'+rh.ds;_htStop[k]=(_htStop[k]||0)+rh.time}});
  var _hmTimeFiltered=[];for(var _tk in _htStop){var _sp=_tk.split('|');_hmTimeFiltered.push({ì„¤ë¹„í˜¸:_sp[0],ì¼ìstr:_sp[1],time:_htStop[_tk]})}
  document.getElementById('hm_time').innerHTML=buildDailyHT(_hmTimeFiltered,'time',D.eq_order,D.all_dates,true,'stop');
  initUtilCharts();
  // ìš”ì•½ í˜ì´ì§€ ì°¨íŠ¸ ì´ˆê¸°í™”
  initOverviewLossChart();
  initOverviewUtilChart();
  initOverviewInspChart();
  initOverviewDailyChart();
  // ê°€ë¡œ ìŠ¤í¬ë¡¤ í…Œì´ë¸” ìš°ì¸¡ ê¸°ë³¸
  setTimeout(function(){document.querySelectorAll('.hc').forEach(function(el){el.scrollLeft=el.scrollWidth;});},100);
}

var ST_EQ_LIST=['K07','K08','K09','K10','K11','K12','K13','K14','H01','H02','H03','H04','H07','H08','H09','H10','G15','G16','G17','G18'];
var customST={}; // ì‚¬ìš©ì ì§ì ‘ ì…ë ¥ S/T (ì„¤ë¹„ë³„ override)
var _stKey='', _stView='daily';

function getSTActual(eq){
  if(customST[eq]>0)return customST[eq]; // ì‚¬ìš©ì ì…ë ¥ê°’ ìš°ì„ 
  if(eq==='K13'||eq==='K14')return 1.85;
  if(eq[0]==='H')return 3.75;
  var avgST=(D.avgEqST||{})[eq]||0; if(!avgST)return null;
  if(['K09','K10','K11','K12'].indexOf(eq)>=0)return avgST/4;
  return avgST/2;
}

function setCustomST(eq,val){
  var v=parseFloat(val);
  if(v>0)customST[eq]=v; else delete customST[eq];
  var panel=document.getElementById('stAnalysisPanel');
  if(panel)panel.innerHTML=buildSTAnalysisPage(_stKey,_stView);
}

function resetCustomST(){
  customST={};
  var panel=document.getElementById('stAnalysisPanel');
  if(panel)panel.innerHTML=buildSTAnalysisPage(_stKey,_stView);
}

function buildSTTable(prod,stop,getCapaFn,editable){
  function concluCell(v){if(!v)return'<td></td>';if(v===t('stNormal'))return'<td class="good">'+t('stNormal')+'</td>';return'<td class="bad">'+v+'</td>'}
  function diffCell(v){if(v===null||v===undefined)return'<td></td>';var s=(v>=0?'+':'')+Math.round(v).toLocaleString();return'<td style="color:'+(v>=0?'#22c55e':'#ef4444')+';font-weight:700">'+s+'</td>'}
  var inpStyle='width:68px;background:#0f172a;color:#e2e8f0;border:1px solid #3b82f6;border-radius:4px;padding:2px 5px;font-size:12px;text-align:right';
  var inpStyleMod='width:68px;background:#1c1917;color:#fcd34d;border:1px solid #f59e0b;border-radius:4px;padding:2px 5px;font-size:12px;text-align:right;font-weight:700';
  var sumCapa=0,sumProd=0,sumStop=0,sumStopQty=0,rows=[];
  ST_EQ_LIST.forEach(function(eq){
    var stA=getSTActual(eq); if(!stA)return;
    var production=prod[eq]||0;
    if(!production)return; // ìƒì‚°ëŸ‰ ì—†ëŠ” ì„¤ë¹„ ì œì™¸
    var capa=getCapaFn(eq,stA);
    if(!capa)return; // capa 0ì´ë©´ ì œì™¸
    var stopTime=stop[eq]||0;
    var stopQty=stopTime>0?(stopTime*60/stA):0;
    var rate=production/capa;
    var diff=production-capa;
    var cvDiff=diff>0?diff-stopQty:diff+stopQty;
    var conclu=Math.abs(cvDiff)>500?(diff>0?t('stAbnormal'):t('stRecordErr')):t('stNormal');
    var isModified=customST[eq]>0;
    sumCapa+=capa;sumProd+=production;sumStop+=stopTime;sumStopQty+=stopQty;
    rows.push({eq:eq,stA:stA,capa:capa,prod:production,rate:rate,diff:diff,stopTime:stopTime,stopQty:stopQty,cvDiff:cvDiff,conclu:conclu,isModified:isModified});
  });
  var sumDiff=sumProd-sumCapa;
  var sumCvDiff=sumDiff>0?sumDiff-sumStopQty:sumDiff+sumStopQty;
  var sumConclu=rows.length?(Math.abs(sumCvDiff)>500?(sumDiff>0?t('stAbnormal'):t('stRecordErr')):t('stNormal')):'';
  var h='<div class="hc"><table class="ht"><thead><tr>';
  h+=t('stHdr').map(function(h){return'<th>'+h+'</th>'}).join('');
  h+='</tr></thead><tbody>';
  var sSt=sumProd>0?(sumProd/sumCapa*100).toFixed(1)+'%':'';
  h+='<tr style="background:#1a1a1a;font-weight:700">';
  h+='<th style="color:#e2e8f0;background:#1a1a1a">'+t('stSummary')+'</th><td style="background:#1a1a1a"></td>';
  h+='<td style="color:#e2e8f0">'+Math.round(sumCapa).toLocaleString()+'</td>';
  h+='<td style="color:#e2e8f0">'+Math.round(sumProd).toLocaleString()+'</td>';
  h+='<td style="color:#e2e8f0">'+sSt+'</td>';
  h+=(rows.length?diffCell(sumDiff):'<td></td>');
  h+='<td>'+(sumStop?Math.round(sumStop).toLocaleString():'')+'</td>';
  h+='<td>'+(sumStopQty?Math.round(sumStopQty).toLocaleString():'')+'</td>';
  h+=(rows.length?diffCell(sumCvDiff):'<td></td>');h+=concluCell(sumConclu);h+='</tr>';
  var lastLine='';
  rows.forEach(function(r){
    var curLine=r.eq[0];
    if(curLine!==lastLine){
      var lc={K:'#f59e0b',H:'#22c55e',G:'#06b6d4'};
      h+='<tr><th colspan="10" style="background:'+lc[curLine]+'22;color:'+lc[curLine]+';text-align:left;padding:4px 8px;font-size:11px">'+curLine+' Line</th></tr>';
      lastLine=curLine;
    }
    h+='<tr><th style="color:#93c5fd">'+r.eq+'</th>';
    if(editable){
      var iStyle=r.isModified?inpStyleMod:inpStyle;
      h+='<td><input type="number" step="0.001" min="0.001" value="'+r.stA.toFixed(3)+'" style="'+iStyle+'" onchange="setCustomST(\''+r.eq+'\',this.value)" title="'+(r.isModified?t('stModified'):t('stDirectInput'))+'" ondblclick="setCustomST(\''+r.eq+'\',\'\')"></td>';
    } else {
      h+='<td>'+(r.isModified?'<span style="color:#fcd34d;font-weight:700">'+r.stA.toFixed(3)+'âœ</span>':r.stA.toFixed(3))+'</td>';
    }
    h+='<td>'+Math.round(r.capa).toLocaleString()+'</td>';
    h+='<td>'+(r.prod>0?Math.round(r.prod).toLocaleString():'<span style="color:#4b5563">0</span>')+'</td>';
    h+='<td>'+(r.rate>0?(r.rate*100).toFixed(1)+'%':'')+'</td>';
    h+=diffCell(r.diff);
    h+='<td>'+(r.stopTime>0?Math.round(r.stopTime).toLocaleString():'')+'</td>';
    h+='<td>'+(r.stopQty>0?Math.round(r.stopQty).toLocaleString():'')+'</td>';
    h+=diffCell(r.cvDiff);h+=concluCell(r.conclu);h+='</tr>';
  });
  h+='</tbody></table></div>';
  return h;
}

// ===================== ê²€ì‚¬ê¸°ê´€ë¦¬ =====================
var _inspDate='';
function renderInspWithDate(date){_inspDate=date;var p=document.getElementById('inspPanel');if(p){p.innerHTML=buildInspPage();initInspChart();}}
function buildInspPage(){
  if(!D||!D.lossDates||!D.lossDates.length)return'<div style="padding:20px;color:#94a3b8">'+t('noData')+'</div>';
  var dates=D.lossDates;
  var lastDate=_inspDate&&dates.indexOf(_inspDate)>=0?_inspDate:dates[dates.length-1];
  var lastIdx=dates.indexOf(lastDate);
  var weekDates=dates.slice(Math.max(0,lastIdx-6),lastIdx+1);
  var inspRows=D.inspAllRows||[];
  var lines=['K','G','H'];
  var lineColors={K:'#f59e0b',G:'#06b6d4',H:'#22c55e'};
  function getInspSum(dts,line){
    var def=0,tm=0;
    dts.forEach(function(ds){
      inspRows.forEach(function(r){
        if(r.dateStr===ds&&(!line||r.line===line)){def+=r.defect;if(r.stop)tm+=r.kpiTime||0;}
      });
    });
    return{def:Math.round(def),time:Math.round(tm)};
  }

  // === Section 1: ì „ì¼ KPI (ë§¨ ìœ„) ===
  var selS='background:#1a1a1a;color:#e2e8f0;border:1px solid #3b82f6;border-radius:6px;padding:4px 8px;font-size:12px;margin-left:8px';
  var h='<div class="bx"><h3 style="display:flex;align-items:center;flex-wrap:wrap">'+t('inspKpi')+' ('+t('prevDay')+': '+lastDate+')';
  h+='<span style="margin-left:auto"><label style="color:#94a3b8;font-size:11px">'+t('kpiDateLabel')+'</label><select onchange="renderInspWithDate(this.value)" style="'+selS+'">';
  dates.slice().reverse().forEach(function(d){h+='<option value="'+d+'"'+(d===lastDate?' selected':'')+'>'+d+'</option>';});
  h+='</select></span></h3>';
  h+='<table class="sum-tbl" style="font-size:12px"><thead><tr><th></th><th style="color:#60a5fa">'+t('total')+'</th>';
  lines.forEach(function(ln){h+='<th style="color:'+lineColors[ln]+'">'+ln+' Line</th>';});
  h+='</tr></thead><tbody>';
  var all=getInspSum([lastDate],null);
  h+='<tr><td style="font-size:10px;color:#94a3b8">'+t('inspDefW')+'</td>';
  h+='<td style="color:#ef4444;font-weight:700;cursor:pointer;text-decoration:underline" onclick="showInspDetail(\'prev\',null)">'+all.def.toLocaleString()+'</td>';
  lines.forEach(function(ln){var v=getInspSum([lastDate],ln);h+='<td style="color:#ef4444;cursor:pointer;text-decoration:underline" onclick="showInspDetail(\'prev\',\''+ln+'\')">'+v.def.toLocaleString()+'</td>';});
  h+='</tr><tr><td style="font-size:10px;color:#94a3b8">'+t('inspTimeW')+'</td>';
  h+='<td style="color:#60a5fa;font-weight:700;cursor:pointer;text-decoration:underline" onclick="showInspDetail(\'prev\',null)">'+all.time.toLocaleString()+t('min')+'</td>';
  lines.forEach(function(ln){var v=getInspSum([lastDate],ln);h+='<td style="color:#60a5fa;cursor:pointer;text-decoration:underline" onclick="showInspDetail(\'prev\',\''+ln+'\')">'+v.time.toLocaleString()+t('min')+'</td>';});
  h+='</tr></tbody></table></div>';

  // === Section 2: ê·¸ë˜í”„ (ì„¸ë¡œ ì‘ê²Œ) ===
  h+='<div class="bx"><h3>'+t('inspDefChart')+' <em>K1Â·K2Â·G='+t('fullDef')+', H='+t('dimDef')+'</em></h3>';
  h+='<canvas id="inspDefChart" style="max-height:220px"></canvas></div>';

  // === Section 3: ì¼ìë³„ % ê°’ í…Œì´ë¸” (íˆíŠ¸ë§µ ìƒ‰ì¡°) ===
  var inspLines=[{ln:'K1',key:'cd'},{ln:'K2',key:'cd'},{ln:'G',key:'cd'},{ln:'H',key:'dd'}];
  h+='<div class="bx"><h3>'+t('inspDefChart')+' '+t('date')+'ë³„</h3><div class="hc">';
  h+='<table class="ht"><thead><tr><th>'+t('line')+'</th>';
  dates.forEach(function(d){var dt=new Date(d+'T00:00:00');h+='<th>'+(dt.getMonth()+1)+'/'+(dt.getDate())+'</th>';});
  h+='</tr></thead><tbody>';
  // ê° ë¼ì¸ì˜ ìµœëŒ€ê°’ ê³„ì‚° (ì „ì²´ì—ì„œ)
  var allVals=[];
  inspLines.forEach(function(cfg){
    dates.forEach(function(dt){
      var dd=D.lossByLineDate[dt]&&D.lossByLineDate[dt][cfg.ln];
      if(dd&&dd.p>0){var vv=dd[cfg.key]/dd.p*100;if(vv>0)allVals.push(vv);}
    });
  });
  var inspMx=allVals.length?Math.max.apply(null,allVals):1;
  inspLines.forEach(function(cfg){
    h+='<tr><th>'+cfg.ln+'</th>';
    dates.forEach(function(dt){
      var dd=D.lossByLineDate[dt]&&D.lossByLineDate[dt][cfg.ln];
      var v=0;if(dd&&dd.p>0)v=dd[cfg.key]/dd.p*100;
      var sty=getHmStyle(v,inspMx,'def');
      h+='<td style="'+sty+'">'+((v>0)?v.toFixed(2)+'%':'')+'</td>';
    });
    h+='</tr>';
  });
  h+='</tbody></table></div></div>';

  // === Section 4: Worst 5 (ë¶ˆëŸ‰ìˆ˜ëŸ‰ + ì •ì§€ì‹œê°„ í•©ì³ì„œ ì¢Œìš°) ===
  var eqMap={};
  weekDates.forEach(function(ds){
    inspRows.forEach(function(r){
      if(r.dateStr===ds){if(!eqMap[r.eq])eqMap[r.eq]={eq:r.eq,def:0,time:0};eqMap[r.eq].def+=r.defect;if(r.stop)eqMap[r.eq].time+=(r.kpiTime||0);}
    });
  });
  var eqArr=Object.keys(eqMap).map(function(k){return eqMap[k];});
  var byDef=eqArr.slice().sort(function(a,b){return b.def-a.def}).slice(0,5);
  var byTime=eqArr.slice().sort(function(a,b){return b.time-a.time}).slice(0,5);
  h+='<div class="worst-grid">';
  // ë¶ˆëŸ‰ìˆ˜ëŸ‰ Worst 5
  h+='<div class="bx"><h4 style="color:#ef4444;margin-bottom:8px;font-size:12px">'+t('inspDefW')+' Worst 5</h4>';
  h+='<table class="worst-tbl"><thead><tr><th>#</th><th>'+t('equip')+'</th><th>'+t('inspDefW')+'</th></tr></thead><tbody>';
  byDef.forEach(function(item,i){
    h+='<tr style="cursor:pointer" onclick="showInspEqDetail(\''+item.eq.replace(/'/g,"\\'")+'\',\'week\')"><td>'+(i+1)+'</td><td>'+item.eq+'</td><td style="color:#ef4444;font-weight:700">'+Math.round(item.def).toLocaleString()+'</td></tr>';
  });
  if(!byDef.length)h+='<tr><td colspan="3" style="color:#94a3b8">'+t('noData')+'</td></tr>';
  h+='</tbody></table></div>';
  // ì •ì§€ì‹œê°„ Worst 5
  h+='<div class="bx"><h4 style="color:#60a5fa;margin-bottom:8px;font-size:12px">'+t('inspTimeW')+' Worst 5</h4>';
  h+='<table class="worst-tbl"><thead><tr><th>#</th><th>'+t('equip')+'</th><th>'+t('inspTimeW')+'</th></tr></thead><tbody>';
  byTime.forEach(function(item,i){
    h+='<tr style="cursor:pointer" onclick="showInspEqDetail(\''+item.eq.replace(/'/g,"\\'")+'\',\'week\')"><td>'+(i+1)+'</td><td>'+item.eq+'</td><td style="color:#60a5fa;font-weight:700">'+Math.round(item.time).toLocaleString()+t('min')+'</td></tr>';
  });
  if(!byTime.length)h+='<tr><td colspan="3" style="color:#94a3b8">'+t('noData')+'</td></tr>';
  h+='</tbody></table></div>';
  h+='</div>';

  return h;
}

// ê²€ì‚¬ê¸° KPI ì…€ í´ë¦­ íŒì—…: ê¸°ê°„ë³„+ë¼ì¸ë³„ ìƒì„¸
function showInspDetail(periodKey,line){
  if(!D||!D.inspAllRows||!D.lossDates)return;
  var dates=D.lossDates;
  var lastDate=_inspDate&&dates.indexOf(_inspDate)>=0?_inspDate:dates[dates.length-1];
  var lastIdx=dates.indexOf(lastDate);
  var dts;
  if(periodKey==='prev')dts=[lastDate];
  else if(periodKey==='week')dts=dates.slice(Math.max(0,lastIdx-6),lastIdx+1);
  else dts=dates.slice(Math.max(0,lastIdx-29),lastIdx+1);
  var rows=D.inspAllRows.filter(function(r){
    return dts.indexOf(r.dateStr)>=0&&(!line||r.line===line);
  }).sort(function(a,b){return a.dateStr===b.dateStr?a.eq.localeCompare(b.eq):a.dateStr.localeCompare(b.dateStr);});
  var title='ê²€ì‚¬ê¸° ì¡°ì • ì´ë ¥'+(line?' ('+line+' Line)':' (ì „ì²´)')+' - '+(periodKey==='prev'?'ì „ì¼':periodKey==='week'?'ì£¼ê°„':'ì›”ê°„');
  _showInspPopup(title,rows);
}
// ê²€ì‚¬ê¸° Worst5 ì„¤ë¹„ í´ë¦­ íŒì—…
function showInspEqDetail(eq,periodKey){
  if(!D||!D.inspAllRows||!D.lossDates)return;
  var dates=D.lossDates;
  var lastDate=_inspDate&&dates.indexOf(_inspDate)>=0?_inspDate:dates[dates.length-1];
  var lastIdx=dates.indexOf(lastDate);
  var dts;
  if(periodKey==='prev')dts=[lastDate];
  else if(periodKey==='week')dts=dates.slice(Math.max(0,lastIdx-6),lastIdx+1);
  else dts=dates.slice(Math.max(0,lastIdx-29),lastIdx+1);
  var rows=D.inspAllRows.filter(function(r){
    return r.eq===eq&&dts.indexOf(r.dateStr)>=0;
  }).sort(function(a,b){return a.dateStr.localeCompare(b.dateStr);});
  _showInspPopup(eq+' ê²€ì‚¬ê¸° ì´ë ¥ (ì£¼ê°„)',rows);
}
function _showInspPopup(title,rows){
  var dd=document.getElementById('modalBody');
  var dt=document.getElementById('modalTitle');
  if(!dd||!dt)return;
  dt.textContent=title;
  var h='<table><thead><tr><th>ì¼ì</th><th>ì„¤ë¹„</th><th>ëŒ€ë¶„ë¥˜</th><th>ë‚´ìš©</th><th>ë¶ˆëŸ‰ìˆ˜</th><th>ì •ì§€ì‹œê°„</th><th>åœ</th></tr></thead><tbody>';
  var totDef=0,totTm=0;
  rows.forEach(function(r){
    totDef+=r.defect;if(r.stop)totTm+=r.kpiTime;
    h+='<tr><td>'+r.dateStr+'</td><td>'+r.eq+'</td><td style="font-size:10px">'+r.cat+'</td><td style="text-align:left;max-width:200px;overflow:hidden;text-overflow:ellipsis">'+(r.detail||'-')+'</td>';
    h+='<td'+(r.defect>0?' style="color:#ef4444;font-weight:700"':'')+'>'+Math.round(r.defect).toLocaleString()+'</td>';
    h+='<td'+(r.kpiTime>0?' style="color:#60a5fa;font-weight:700"':'')+'>'+Math.round(r.kpiTime)+'</td>';
    h+='<td>'+(r.stop?'â›”':'')+'</td></tr>';
  });
  h+='<tr style="background:#1a1a1a;font-weight:700"><td colspan="4">í•©ê³„ ('+rows.length+'ê±´)</td>';
  h+='<td style="color:#ef4444">'+Math.round(totDef).toLocaleString()+'</td>';
  h+='<td style="color:#60a5fa">'+Math.round(totTm)+'ë¶„</td><td></td></tr>';
  h+='</tbody></table>';
  dd.innerHTML=h;
  document.getElementById('modalOverlay').classList.add('show');
}

function initInspChart(){
  var canvas=document.getElementById('inspDefChart');
  if(!canvas||!D||!D.lossDates||!D.lossDates.length)return;
  var dates=D.lossDates;
  // K1,K2,G=ì™„ì „ë¶ˆëŸ‰(cd), H=ì¹˜ìˆ˜ë¶ˆëŸ‰(dd)
  var inspLines=[
    {ln:'K1',key:'cd',label:'K1 '+t('fullDef'),color:'#3b82f6'},
    {ln:'K2',key:'cd',label:'K2 '+t('fullDef'),color:'#8b5cf6'},
    {ln:'G',key:'cd',label:'G '+t('fullDef'),color:'#06b6d4'},
    {ln:'H',key:'dd',label:'H '+t('dimDef'),color:'#22c55e'}
  ];
  var datasets=inspLines.map(function(cfg){
    return{label:cfg.label,data:dates.map(function(dt){
      var d=D.lossByLineDate[dt]&&D.lossByLineDate[dt][cfg.ln];
      if(!d||!d.p||d.p<=0)return null;var v=d[cfg.key];
      return v>0?Math.round(v/d.p*10000)/100:null;
    }),borderColor:cfg.color,backgroundColor:'transparent',pointRadius:3,pointBackgroundColor:cfg.color,tension:0.3,spanGaps:true,borderWidth:2};
  });
  var ch=new Chart(canvas,{type:'line',
    data:{labels:dates.map(function(d){var dt=new Date(d+'T00:00:00');return(dt.getMonth()+1)+'/'+(dt.getDate());}),datasets:datasets},
    options:{responsive:true,maintainAspectRatio:true,aspectRatio:3,
      plugins:{legend:{labels:{color:'#94a3b8',font:{size:10}},position:'bottom'},
        tooltip:{backgroundColor:'#0a0a0a',titleColor:'#60a5fa',bodyColor:'#e2e8f0',callbacks:{label:function(c){return c.dataset.label+': '+(c.parsed.y!=null?c.parsed.y.toFixed(2)+'%':'-');}}}},
      scales:{x:{ticks:{color:'#94a3b8',font:{size:9}},grid:{color:'#1f2937'}},
        y:{ticks:{color:'#94a3b8',font:{size:9},callback:function(v){return v+'%'}},grid:{color:'#1f2937'},min:0,
          title:{display:true,text:'%',color:'#64748b',font:{size:9}}}}}});
  charts.push(ch);
}

function buildSTAnalysisPage(key,viewType){
  viewType=viewType||'daily';
  if(!D||!D.stDates)return'<div style="padding:20px;color:#94a3b8">'+t('noData')+'</div>';
  var btnStyle='padding:7px 16px;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;border:1px solid #2a2a2a;touch-action:manipulation';
  var onStyle=';background:#3b82f6;color:#fff;border-color:#3b82f6';
  var offStyle=';background:#1a1a1a;color:#94a3b8';
  var h='<div class="bx"><h3>â± '+t('stTitle')+'</h3>';
  // ë””ë²„ê·¸ íŒ¨ë„
  var dbg=D._dbg||{};
  var dbgColor=dbg.rows>0?'#166534':'#7f1d1d';
  var dbgBg=dbg.rows>0?'#052e16':'#2d0d0d';
  h+='<details style="margin-bottom:10px"><summary style="cursor:pointer;font-size:11px;color:#94a3b8">ğŸ” '+t('stDiag')+'</summary>';
  h+='<div style="background:'+dbgBg+';border:1px solid '+dbgColor+';border-radius:6px;padding:8px;font-size:11px;font-family:monospace;color:#d1fae5;margin-top:4px;word-break:break-all">';
  h+=t('stAllSheets')+'['+((dbg.sheets||[]).join(', '))+']<br>';
  h+=t('stMatched')+'['+((dbg.matchedSheets||[]).join(', '))+']<br>';
  h+=t('stProcessed')+'<b>'+( dbg.rows||0)+'</b> | '+t('stDateCnt')+'<b>'+(dbg.dates||0)+'</b> | '+t('stWeekCnt')+'<b>'+(dbg.weeks||0)+'</b><br>';
  h+=t('stEqs')+'['+(dbg.eqs||[]).join(', ')+']';
  h+='</div></details>';
  // ë°ì´í„° í˜„í™© ìš”ì•½
  var totalDays=D.stDates?D.stDates.length:0;
  var totalWeeks=D.weekList?D.weekList.length:0;
  var totalEqs=Object.keys(D.prodTotalEq||{}).filter(function(e){return(D.prodTotalEq[e]||0)>0}).length;
  h+='<div style="font-size:11px;color:#64748b;margin-bottom:10px">'+t('stData')+'<span style="color:#60a5fa">'+totalDays+t('stDays')+'</span> | <span style="color:#a78bfa">'+totalWeeks+t('stWeeks')+'</span> | <span style="color:#34d399">'+t('equip')+' '+totalEqs+t('eqUnit')+'</span></div>';
  // ë·° ì„ íƒ ë²„íŠ¼
  h+='<div style="display:flex;gap:6px;margin-bottom:12px">';
  h+='<button style="'+btnStyle+(viewType==='daily'?onStyle:offStyle)+'" onclick="renderSTAnalysis(\''+(D.stDates.length?D.stDates[D.stDates.length-1]:'')+'\',\'daily\')">'+t('stByDate')+'</button>';
  h+='<button style="'+btnStyle+(viewType==='weekly'?onStyle:offStyle)+'" onclick="renderSTAnalysis(\''+(D.weekList&&D.weekList.length?D.weekList[D.weekList.length-1]:'')+'\',\'weekly\')">'+t('stByWeek')+'</button>';
  h+='<button style="'+btnStyle+(viewType==='cumul'?onStyle:offStyle)+'" onclick="renderSTAnalysis(\'\',\'cumul\')">'+t('stAccum')+'</button>';
  h+='</div>';
  var prod,stop,getCapaFn,subtitle='';
  if(viewType==='daily'){
    var selDate=key||(D.stDates.length?D.stDates[D.stDates.length-1]:'');
    h+='<div style="margin-bottom:10px"><label style="color:#94a3b8;font-size:13px">'+t('stDateSel')+'</label>';
    h+='<select onchange="renderSTAnalysis(this.value,\'daily\')" style="background:#1a1a1a;color:#e2e8f0;border:1px solid #3b82f6;border-radius:6px;padding:5px 10px;font-size:13px">';
    (D.stDates||[]).slice().reverse().forEach(function(d){h+='<option value="'+d+'"'+(d===selDate?' selected':'')+'>'+d+'</option>'});
    h+='</select></div>';
    prod=(D.prodByDateEq||{})[selDate]||{};
    stop=(D.stopByDateEq||{})[selDate]||{};
    getCapaFn=function(eq,stA){return 86400/stA};
    subtitle=selDate;
  } else if(viewType==='weekly'){
    var selWeek=key||(D.weekList&&D.weekList.length?D.weekList[D.weekList.length-1]:'');
    h+='<div style="margin-bottom:10px"><label style="color:#94a3b8;font-size:13px">'+t('stWeekSel')+'</label>';
    h+='<select onchange="renderSTAnalysis(this.value,\'weekly\')" style="background:#1a1a1a;color:#e2e8f0;border:1px solid #3b82f6;border-radius:6px;padding:5px 10px;font-size:13px">';
    (D.weekList||[]).slice().reverse().forEach(function(w){h+='<option value="'+w+'"'+(w===selWeek?' selected':'')+'>'+w+t('stWeekLabel')+'</option>'});
    h+='</select></div>';
    prod=(D.prodByWeekEq||{})[selWeek]||{};
    stop=(D.stopByWeekEq||{})[selWeek]||{};
    getCapaFn=function(eq,stA){var wd=D.eqWeekDates&&D.eqWeekDates[selWeek]&&D.eqWeekDates[selWeek][eq]?Object.keys(D.eqWeekDates[selWeek][eq]).length:0;return wd*86400/stA};
    subtitle=selWeek+t('stWeekLabel');
  } else {
    prod=D.prodTotalEq||{};
    stop=D.stopTotalEq||{};
    getCapaFn=function(eq,stA){var n=D.eqDates&&D.eqDates[eq]?Object.keys(D.eqDates[eq]).length:0;return n*86400/stA};
    subtitle=t('stAccum');
  }
  if(!D.stDates.length){
    h+='<div style="padding:30px;text-align:center;color:#94a3b8">âš  '+t('noData')+'</div></div>';
    return h;
  }
  var hasMod=Object.keys(customST).length>0;
  h+='<div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">';
  h+='<div style="font-size:12px;color:#94a3b8">'+t('stBasis')+'<strong style="color:#e2e8f0">'+subtitle+'</strong></div>';
  if(viewType==='daily'){
    h+='<div style="font-size:11px;color:#60a5fa">'+t('stInputHelp')+'</div>';
    if(hasMod)h+='<button onclick="resetCustomST()" style="padding:3px 10px;font-size:11px;background:#7f1d1d;color:#fca5a5;border:1px solid #991b1b;border-radius:4px;cursor:pointer">'+t('stResetAll')+'</button>';
  }
  h+='</div>';
  h+=buildSTTable(prod,stop,getCapaFn,viewType==='daily');
  h+='<div style="margin-top:8px;font-size:11px;color:#94a3b8">'+t('stActual')+'K07/K08/G=STÃ·2, K09~K12=STÃ·4, K13/K14=1.85s, H=3.75s | '+t('stConvDiff')+t('stConclusion')+'|>500 â†’ '+t('stOver')+'</div>';
  h+='</div>';
  return h;
}

function renderSTAnalysis(key,viewType){
  _stKey=key; _stView=viewType||'daily';
  var panel=document.getElementById('stAnalysisPanel');
  if(panel)panel.innerHTML=buildSTAnalysisPage(_stKey,_stView);
}

function showTechPopup(date,eq){
  if(!D||!D.lossDetailByDateEq)return;
  var dd=D.lossDetailByDateEq[date]&&D.lossDetailByDateEq[date][eq];
  if(!dd||!dd.techNotes||!dd.techNotes.length)return;
  var h='<div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:9999;display:flex;align-items:center;justify-content:center;padding:16px" onclick="if(event.target===this)this.remove()" id="techPopup">';
  h+='<div style="background:#1a1a1a;border:1px solid #3b82f6;border-radius:12px;max-width:500px;width:100%;max-height:80vh;overflow-y:auto;padding:20px">';
  h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">';
  h+='<h3 style="color:#60a5fa;font-size:15px">'+eq+' '+t('lossDetailHdr')[9]+' ('+date+')</h3>';
  h+='<span style="color:#94a3b8;cursor:pointer;font-size:20px;padding:4px 8px" onclick="document.getElementById(\'techPopup\').remove()">âœ•</span></div>';
  h+='<table style="border-collapse:collapse;width:100%;font-size:12px">';
  h+='<tr><th style="background:#1a1a1a;color:#e2e8f0;padding:6px 8px;border:1px solid #333;text-align:left">'+t('equip')+'</th>';
  h+='<th style="background:#1a1a1a;color:#e2e8f0;padding:6px 8px;border:1px solid #333;text-align:center">'+t('sheet')+'</th>';
  h+='<th style="background:#1a1a1a;color:#e2e8f0;padding:6px 8px;border:1px solid #333;text-align:center">'+t('qty')+'</th>';
  h+='<th style="background:#1a1a1a;color:#e2e8f0;padding:6px 8px;border:1px solid #333;text-align:left">'+t('content')+'</th></tr>';
  dd.techNotes.forEach(function(n){
    h+='<tr><td style="padding:5px 8px;border:1px solid #2a2a2a;color:#93c5fd">'+n.eq+'</td>';
    h+='<td style="padding:5px 8px;border:1px solid #2a2a2a;color:#94a3b8;text-align:center">'+n.sheet+'</td>';
    h+='<td style="padding:5px 8px;border:1px solid #2a2a2a;color:#e2e8f0;text-align:center">'+Math.round(n.qty)+'</td>';
    h+='<td style="padding:5px 8px;border:1px solid #2a2a2a;color:#e2e8f0">'+( n.note||'-')+'</td></tr>';
  });
  h+='</table></div></div>';
  document.body.insertAdjacentHTML('beforeend',h);
}

function clearData(){
  localStorage.removeItem('dashData');localStorage.removeItem('dashFile');_idbClear();
  D=null;charts.forEach(function(c){try{c.destroy()}catch(e){}});charts=[];
  document.getElementById('tabArea').style.display='none';document.getElementById('tabArea').innerHTML='';
  updateLangUI();document.getElementById('root').innerHTML='<div class="welcome"><div class="arrow">ğŸ‘†</div><h2>'+t('uploadTitle')+'</h2><p>ğŸ“‚ '+t('uploadDesc')+'</p></div>';
  document.getElementById('fileName').textContent=t('selectFile');
  document.getElementById('fileStatus').textContent=t('waiting');document.getElementById('fileStatus').style.color='#94a3b8';
  document.getElementById('clearBtn').style.display='none';
  var _inf2=document.getElementById('info');if(_inf2)_inf2.textContent='';
}

(function(){
  try{
    var saved=localStorage.getItem('dashData');
    if(saved){
      var parsed=JSON.parse(saved);
      if(parsed.dataVersion!==DATA_VERSION){
        // ë²„ì „ ë¶ˆì¼ì¹˜: IndexedDBì—ì„œ ì›ë³¸ íŒŒì¼ë¡œ ìë™ ì¬ì²˜ë¦¬
        localStorage.removeItem('dashData');localStorage.removeItem('dashFile');
        _idbLoad(function(buf,fn){
          if(buf){
            console.log('[ìë™ì¬ì²˜ë¦¬] v'+DATA_VERSION+' ì›ë³¸íŒŒì¼: '+fn);
            _processAndRender(new Uint8Array(buf),fn||'cached');
          } else {
            document.getElementById('root').innerHTML='<div class="welcome"><div class="arrow">ğŸ‘†</div><h2>'+t('updateTitle')+'</h2><p style="color:#f59e0b">'+t('updateDesc')+DATA_VERSION+t('updateDesc2')+'</p></div>';
          }
        });
      } else {
        D=parsed;
        var fn=localStorage.getItem('dashFile')||t('savedData');
        document.getElementById('tabArea').style.display='';
        renderAll();
        document.getElementById('fileName').textContent=t('current')+fn;
        document.getElementById('fileStatus').textContent='âœ“ '+t('saved')+' ('+D.totalRec.toLocaleString()+t('items')+')';
        document.getElementById('fileStatus').style.color='#22c55e';
        document.getElementById('clearBtn').style.display='';
      }
    }
  }catch(e){localStorage.removeItem('dashData')}
updateLangUI();
})();
</script>
</body>
</html>
