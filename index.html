<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ì„¤ë¹„ì¡°ì •ì´ë ¥ ë¶„æ v3.3</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',Arial,sans-serif;background:#000;color:#e2e8f0}
.hd{background:linear-gradient(135deg,#0a0a0a,#1a1a1a);padding:16px 20px;border-bottom:2px solid #3b82f6}
.hd h1{font-size:20px;color:#60a5fa}.hd .ver{font-size:11px;color:#94a3b8;font-weight:400;margin-left:6px}.hd p{font-size:12px;color:#94a3b8;margin-top:4px}
.file-bar{background:#000;padding:10px 20px;border-bottom:1px solid #1a1a1a;display:flex;align-items:center;gap:10px;flex-wrap:wrap}
.file-btn{background:#3b82f6;color:#fff;padding:10px 20px;border:none;border-radius:8px;font-size:14px;font-weight:700;cursor:pointer;display:inline-flex;align-items:center;gap:6px;min-height:44px;touch-action:manipulation}
.file-btn:active{background:#2563eb;transform:scale(0.97)}
.file-name{font-size:12px;color:#94a3b8;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.file-status{font-size:11px;font-weight:600}
.kpi{display:grid;grid-template-columns:repeat(auto-fit,minmax(90px,1fr));gap:6px;padding:10px 20px;background:#0a0a0a}
.kpi-item{text-align:center;padding:6px 4px}
.kpi-item .v{font-size:17px;font-weight:700;color:#60a5fa}.kpi-item .l{font-size:10px;color:#94a3b8;margin-top:2px}
.sum-section{margin-bottom:20px}
.sum-section h3{font-size:14px;color:#60a5fa;margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid #1a1a1a}
.sum-tbl{border-collapse:collapse;width:100%;font-size:13px;margin-bottom:10px}
.sum-tbl th,.sum-tbl td{padding:8px 12px;border:1px solid #1a1a1a;text-align:center}
.sum-tbl th{background:#1a1a1a;color:#e2e8f0;font-weight:700;white-space:nowrap}
.sum-tbl td{color:#cbd5e1}
.sum-tbl .good{color:#22c55e;font-weight:700}
.sum-tbl .bad{color:#ef4444;font-weight:700}
.sum-tbl .kpi-target{color:#f59e0b;font-weight:600;font-size:11px}
.worst-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media(max-width:700px){.worst-grid{grid-template-columns:1fr}.worst-grid-3{grid-template-columns:1fr!important}}
.worst-card{background:#111;border-radius:10px;border:1px solid #1a1a1a;padding:12px}
.worst-card h4{font-size:13px;margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid #1a1a1a}
.worst-tbl{border-collapse:collapse;width:100%;font-size:12px}
.worst-tbl th,.worst-tbl td{padding:5px 8px;border:1px solid #1a1a1a;text-align:center}
.worst-tbl th{background:#1a1a1a;color:#e2e8f0;font-size:11px}
.worst-tbl td{color:#cbd5e1}
.worst-tbl tr:first-child td{color:#ef4444;font-weight:700}
.tabs{display:flex;flex-wrap:wrap;gap:4px;padding:10px 16px;background:#0a0a0a;border-bottom:1px solid #1a1a1a;position:sticky;top:0;z-index:100}
.tab{padding:8px 16px;border-radius:6px;cursor:pointer;font-size:13px;font-weight:600;background:#1a1a1a;color:#94a3b8;border:1px solid #2a2a2a;transition:all .2s;white-space:nowrap;touch-action:manipulation}
.tab.on{background:#3b82f6;color:#fff;border-color:#3b82f6}
.tab:hover:not(.on){background:#2a2a2a;color:#e2e8f0}
.pn{display:none;padding:16px}.pn.on{display:block}
.bx{background:#0a0a0a;border-radius:12px;padding:14px;border:1px solid #1a1a1a;margin-bottom:16px}
.bx h3{font-size:13px;color:#60a5fa;margin-bottom:8px;padding-bottom:5px;border-bottom:1px solid #1a1a1a}
.bx h3 em{font-size:10px;color:#94a3b8;font-weight:400;font-style:normal;margin-left:6px}
canvas{max-height:360px}
.hc{overflow-x:auto;-webkit-overflow-scrolling:touch}
table.ht{border-collapse:collapse;font-size:10px;width:100%}
table.ht th,table.ht td{padding:4px 6px;text-align:center;border:1px solid #1a1a1a;white-space:nowrap}
table.ht th{background:#1a1a1a;color:#e2e8f0}
table.ht thead th{position:sticky;top:0;z-index:2}
table.ht tbody th,table.ht thead th:first-child{position:sticky;left:0;z-index:3;background:#1a1a1a}
table.ht thead th:first-child{z-index:4}
.h0{background:rgba(59,130,246,0)}.h1{background:rgba(59,130,246,0.15);color:#93c5fd}
.h2{background:rgba(59,130,246,0.3);color:#93c5fd}.h3{background:rgba(251,191,36,0.3);color:#fcd34d}
.h4{background:rgba(251,191,36,0.5);color:#fcd34d}.h5{background:rgba(239,68,68,0.4);color:#fca5a5}
.h6{background:rgba(239,68,68,0.7);color:#fff;font-weight:700}
.lg{display:flex;gap:8px;align-items:center;margin:6px 0;font-size:10px;flex-wrap:wrap}
.li{display:flex;align-items:center;gap:3px}.lc{width:16px;height:10px;border-radius:2px}
.loading{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:999;justify-content:center;align-items:center;font-size:18px;color:#60a5fa}
.loading.show{display:flex}
.modal-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.75);z-index:1000;justify-content:center;align-items:center;padding:16px}
.modal-overlay.show{display:flex}
.modal{background:#0a0a0a;border-radius:12px;border:1px solid #3b82f6;max-width:90vw;width:100%;max-height:80vh;overflow:auto;padding:16px}
.modal h3{color:#60a5fa;font-size:15px;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid #1a1a1a}
.modal table{border-collapse:collapse;width:100%;font-size:12px}
.modal th{background:#1a1a1a;color:#e2e8f0;padding:6px 8px;text-align:left;position:sticky;top:0}
.modal td{padding:5px 8px;border-bottom:1px solid #1a1a1a;color:#cbd5e1}
.modal tr:hover td{background:#1a1a1a}
.modal .close-btn{float:right;background:none;border:none;color:#94a3b8;font-size:20px;cursor:pointer;padding:0 4px;line-height:1}
.modal .close-btn:hover{color:#ef4444}
.modal .highlight{color:#ef4444;font-weight:700}
.hm-click{cursor:pointer;transition:outline .15s}.hm-click:hover{outline:2px solid #60a5fa;outline-offset:-1px}
#fileInput{position:absolute;width:1px;height:1px;opacity:0;overflow:hidden;clip:rect(0,0,0,0)}
.line-label{font-size:12px;font-weight:700;padding:4px 12px;border-radius:6px;display:inline-block;margin-bottom:4px}
.welcome{text-align:center;padding:60px 20px;color:#94a3b8}
.welcome h2{font-size:24px;color:#60a5fa;margin-bottom:12px}
.welcome p{font-size:14px;line-height:1.8}
.welcome .arrow{font-size:40px;margin:20px 0;color:#3b82f6;animation:bounce 1.5s infinite}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
</style>
</head>
<body>
<div class="hd">
<h1>ğŸ“Š ì„¤ë¹„ì¡°ì •ì´ë ¥ ë¶„æ v3.3</h1>
<p id="info">ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ë¶„ì„ì´ ì‹œì‘ë©ë‹ˆë‹¤</p>
</div>
<div class="file-bar">
<label class="file-btn" for="fileInput">ğŸ“‚ íŒŒì¼ ì„ íƒ</label>
<input type="file" id="fileInput" accept=".xlsx,.xls" onchange="handleFile(this)">
<span class="file-name" id="fileName">íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”</span>
<span class="file-status" id="fileStatus" style="color:#94a3b8">ëŒ€ê¸°ì¤‘</span>
<button id="clearBtn" style="display:none;background:#ef4444;color:#fff;padding:6px 14px;border:none;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;min-height:36px;touch-action:manipulation" onclick="clearData()">ğŸ—‘ ì´ˆê¸°í™”</button>
</div>
<!-- KPI area removed -->
<div class="tabs" id="tabArea" style="display:none"></div>
<div id="root">
<div class="welcome">
<div class="arrow">ğŸ‘†</div>
<h2>íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”</h2>
<p>ğŸ“‚ ìœ„ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”<br>
<strong>_POLE_æ»å·ç¨¼åŠ¨æ—¥åˆ«ç°å†µ</strong> íŒŒì¼ì„ ì§€ì›í•©ë‹ˆë‹¤<br>
PMè°ƒæ•´ ë°ì´í„°ë¥¼ ìë™ ë¶„ì„í•©ë‹ˆë‹¤</p>
</div>
</div>
<div class="loading" id="loadingOverlay">â³ íŒŒì¼ ë¶„ì„ ì¤‘...</div>
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this)closeModal()">
<div class="modal"><button class="close-btn" onclick="closeModal()">&times;</button><h3 id="modalTitle"></h3><div id="modalBody"></div></div>
</div>

<script>
let D=null, charts=[];
var DATA_VERSION='3.3'; // ì´ ê°’ì´ ë°”ë€Œë©´ localStorage ìºì‹œ ìë™ ì‚­ì œ

function handleFile(input){
  var file=input.files[0]; if(!file)return;
  document.getElementById('fileName').textContent='ì²˜ë¦¬ì¤‘: '+file.name;
  document.getElementById('fileStatus').textContent='â³ ë¶„ì„ì¤‘...';
  document.getElementById('fileStatus').style.color='#f59e0b';
  document.getElementById('loadingOverlay').classList.add('show');
  var reader=new FileReader();
  reader.onload=function(e){
    setTimeout(function(){
      try{
        var wb=XLSX.read(e.target.result,{type:'array',cellDates:true});
        var nd=processWorkbook(wb);
        if(nd){
          D=nd;
          document.getElementById('tabArea').style.display='';
          renderAll();
          try{localStorage.setItem('dashData',JSON.stringify(D));localStorage.setItem('dashFile',file.name)}catch(e){}
          document.getElementById('fileName').textContent='í˜„ì¬: '+file.name;
          document.getElementById('fileStatus').textContent='âœ“ ë¡œë“œì™„ë£Œ ('+D.totalRec.toLocaleString()+'ê±´)';
          document.getElementById('fileStatus').style.color='#22c55e';
          document.getElementById('clearBtn').style.display='';
        }
      }catch(err){
        alert('ì˜¤ë¥˜: '+err.message);
        document.getElementById('fileStatus').textContent='âœ— ì˜¤ë¥˜';
        document.getElementById('fileStatus').style.color='#ef4444';
      }
      document.getElementById('loadingOverlay').classList.remove('show');
      input.value='';
    },100);
  };
  reader.readAsArrayBuffer(file);
}

function processWorkbook(wb){
  var allRows=[];
  for(var si=0;si<wb.SheetNames.length;si++){
    var sn=wb.SheetNames[si];
    if(sn.indexOf('è°ƒæ•´å±¥å†')===-1)continue;
    var raw=XLSX.utils.sheet_to_json(wb.Sheets[sn],{header:1,defval:null,raw:false});
    if(raw.length<3)continue;
    for(var i=2;i<raw.length;i++){
      var r=raw[i]; if(!r||!r[3]||!r[4])continue;
      var cat=(r[13]||'').toString().trim();
      if(cat!=='PMè°ƒæ•´')continue;
      var sub=(r[14]||'').toString().trim();
      if(sub==='åœæœº'||sub==='å¼€æœº'||!sub)continue;
      var dt=r[3],dateStr='';
      if(dt instanceof Date){try{dateStr=new Date(dt).toLocaleDateString('en-CA')}catch(e){continue}}
      else if(typeof dt==='string'){dateStr=dt}
      else if(typeof dt==='number'){var d2=new Date((dt-25569)*86400000);dateStr=d2.toISOString().slice(0,10)}
      if(!dateStr)continue;
      var mm=String(new Date(dateStr).getMonth()+1).padStart(2,'0');
      var dd=String(new Date(dateStr).getDate()).padStart(2,'0');
      var ds=mm+'/'+dd;
      var eq=(r[4]||'').toString().trim().toUpperCase();
      if(!eq)continue;
      var stopTime=parseFloat(r[11])||0, nonStopTime=parseFloat(r[12])||0;
      var time=Math.max(stopTime,nonStopTime);
      if(time>1000)continue;
      var defect=parseFloat(r[18])||0;
      var stopYN=(r[19]||'').toString().trim();
      var line=eq[0];
      var detail=(r[15]||'').toString().trim();
      allRows.push({ds:ds,eq:eq,sub:sub,detail:detail,defect:defect,time:time,stop:stopYN==='åœ',line:line,dateStr:dateStr});
    }
  }
  if(allRows.length===0){alert('PMè°ƒæ•´ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');return null}

  // === ì‹œê°„ëŒ€ë¹„ë¶„æ ë°ì´í„° ===
  function parseStDate(v){
    if(!v)return'';
    if(v instanceof Date){try{return v.toLocaleDateString('en-CA')}catch(e){return''}}
    if(typeof v==='number'){var d=new Date(Math.round((v-25569)*86400)*1000);return d.toLocaleDateString('en-CA')}
    if(typeof v==='string'){var m=v.match(/(\d{4})[-\/](\d{1,2})[-\/](\d{1,2})/);if(m)return m[1]+'-'+m[2].padStart(2,'0')+'-'+m[3].padStart(2,'0')}
    return'';
  }
  var prodByDateEq={}, eqStRaw={}, dateToWeek={}, eqDates={}, eqWeekDates={};
  var _dbgAllSheets=wb.SheetNames.slice(); // ì „ì²´ ì‹œíŠ¸ëª… ë³µì‚¬
  var _dbgSheets=[],_dbgRows=0; // ë””ë²„ê·¸ìš©
  for(var ni=0;ni<wb.SheetNames.length;ni++){
    var nsn=wb.SheetNames[ni];
    // ê°„ì²´(æ—¥æŠ¥)ì™€ ë²ˆì²´(æ—¥å ±) ëª¨ë‘ ë§¤ì¹­
    if(nsn.indexOf('æ—¥æŠ¥')===-1 && nsn.indexOf('æ—¥å ±')===-1)continue;
    _dbgSheets.push(nsn);
    var raw2=XLSX.utils.sheet_to_json(wb.Sheets[nsn],{header:1,defval:null,raw:true});
    var lastDate2=null,lastWeek2=null; // ë³‘í•©ì…€ ì „íŒŒìš©
    for(var j=2;j<raw2.length;j++){
      var rj=raw2[j]; if(!rj)continue;
      // ë³‘í•©ì…€ ì²˜ë¦¬: ê°’ì´ ìˆì„ ë•Œë§Œ ê°±ì‹ , ì—†ìœ¼ë©´ ì´ì „ ê°’ ìœ ì§€
      if(rj[3]!=null){var nd2=parseStDate(rj[3]);if(nd2)lastDate2=nd2;}
      if(rj[2]!=null){var nw2=(rj[2]||'').toString().trim();if(nw2)lastWeek2=nw2;}
      if(!lastDate2||!rj[4])continue;
      var ds2=lastDate2;
      var eq2=(rj[4]||'').toString().trim().toUpperCase(); if(!eq2)continue;
      var prod2=typeof rj[11]==='number'?rj[11]:(parseFloat(rj[11])||0);
      var st2=typeof rj[12]==='number'?rj[12]:(parseFloat(rj[12])||0);
      var wk2=lastWeek2||'';
      if(!prodByDateEq[ds2])prodByDateEq[ds2]={};
      prodByDateEq[ds2][eq2]=(prodByDateEq[ds2][eq2]||0)+prod2;
      if(st2>0){if(!eqStRaw[eq2])eqStRaw[eq2]={s:0,n:0};eqStRaw[eq2].s+=st2;eqStRaw[eq2].n++}
      if(wk2&&!dateToWeek[ds2])dateToWeek[ds2]=wk2;
      if(!eqDates[eq2])eqDates[eq2]={};eqDates[eq2][ds2]=1;
      if(wk2){if(!eqWeekDates[wk2])eqWeekDates[wk2]={};if(!eqWeekDates[wk2][eq2])eqWeekDates[wk2][eq2]={};eqWeekDates[wk2][eq2][ds2]=1;}
      _dbgRows++;
    }
  }
  var stopByDateEq={};
  for(var ki=0;ki<wb.SheetNames.length;ki++){
    var ksn=wb.SheetNames[ki];
    // ê°„ì²´(è°ƒæ•´å±¥å†)ì™€ ë²ˆì²´(èª¿æ•´å±¥æ­´) ëª¨ë‘ ë§¤ì¹­
    if(ksn.indexOf('è°ƒæ•´å±¥å†')===-1 && ksn.indexOf('èª¿æ•´å±¥æ­´')===-1 && ksn.indexOf('å±¥å†')===-1 && ksn.indexOf('å±¥æ­´')===-1)continue;
    var raw3=XLSX.utils.sheet_to_json(wb.Sheets[ksn],{header:1,defval:null,raw:true});
    var lastDate3=null; // ë³‘í•©ì…€ ì „íŒŒìš©
    for(var k=2;k<raw3.length;k++){
      var rk=raw3[k]; if(!rk)continue;
      if(rk[3]!=null){var nd3=parseStDate(rk[3]);if(nd3)lastDate3=nd3;}
      if(!lastDate3||!rk[4])continue;
      if((rk[19]||'').toString().trim()!=='åœ')continue;
      var ds3=lastDate3;
      var eq3=(rk[4]||'').toString().trim().toUpperCase(); if(!eq3)continue;
      var sm=typeof rk[20]==='number'?rk[20]:(parseFloat(rk[20])||0);
      if(!stopByDateEq[ds3])stopByDateEq[ds3]={};
      stopByDateEq[ds3][eq3]=(stopByDateEq[ds3][eq3]||0)+sm;
    }
  }
  var avgEqST={};
  Object.keys(eqStRaw).forEach(function(eq){if(eqStRaw[eq].n>0)avgEqST[eq]=eqStRaw[eq].s/eqStRaw[eq].n});
  var stDates=Object.keys(prodByDateEq).sort();
  // ë³‘í•©ì…€ë¡œ ëˆ„ë½ëœ ì£¼ì°¨ë¥¼ ISO ì£¼ì°¨ë¡œ ë³´ì™„
  (function(){
    function isoWeek(ds){
      var d=new Date(ds+'T00:00:00');
      if(isNaN(d.getTime()))return'';
      d.setDate(d.getDate()+3-(d.getDay()+6)%7);
      var w1=new Date(d.getFullYear(),0,4);
      return String(1+Math.round(((d.getTime()-w1.getTime())/86400000-3+(w1.getDay()+6)%7)/7));
    }
    Object.keys(prodByDateEq).forEach(function(dt){
      if(!dateToWeek[dt]){var w=isoWeek(dt);if(w)dateToWeek[dt]=w;}
    });
  })();
  // eqWeekDates ì¬êµ¬ì„± (dateToWeek ë³´ì™„ í›„)
  eqWeekDates={};
  Object.keys(prodByDateEq).forEach(function(dt){
    var wk=dateToWeek[dt]; if(!wk)return;
    Object.keys(prodByDateEq[dt]).forEach(function(eq){
      if(!eqWeekDates[wk])eqWeekDates[wk]={};
      if(!eqWeekDates[wk][eq])eqWeekDates[wk][eq]={};
      eqWeekDates[wk][eq][dt]=1;
    });
  });
  // ì£¼ì°¨ë³„/ëˆ„ì  ì§‘ê³„
  var prodByWeekEq={},stopByWeekEq={},prodTotalEq={},stopTotalEq={};
  Object.keys(prodByDateEq).forEach(function(dt){
    var wk=dateToWeek[dt];
    Object.keys(prodByDateEq[dt]).forEach(function(eq){
      var v=prodByDateEq[dt][eq];
      if(wk){if(!prodByWeekEq[wk])prodByWeekEq[wk]={};prodByWeekEq[wk][eq]=(prodByWeekEq[wk][eq]||0)+v;}
      prodTotalEq[eq]=(prodTotalEq[eq]||0)+v;
    });
  });
  Object.keys(stopByDateEq).forEach(function(dt){
    var wk=dateToWeek[dt];
    Object.keys(stopByDateEq[dt]).forEach(function(eq){
      var v=stopByDateEq[dt][eq];
      if(wk){if(!stopByWeekEq[wk])stopByWeekEq[wk]={};stopByWeekEq[wk][eq]=(stopByWeekEq[wk][eq]||0)+v;}
      stopTotalEq[eq]=(stopTotalEq[eq]||0)+v;
    });
  });
  var weekList=Object.keys(prodByWeekEq).sort(function(a,b){return+a-+b});

  var all_dates=[]; var dateSet={};
  for(var ai=0;ai<allRows.length;ai++){if(!dateSet[allRows[ai].ds]){dateSet[allRows[ai].ds]=1;all_dates.push(allRows[ai].ds)}}
  all_dates.sort();

  var eqCnt={};for(var bi=0;bi<allRows.length;bi++){eqCnt[allRows[bi].eq]=(eqCnt[allRows[bi].eq]||0)+1}
  var lineOrder={K:0,H:1,G:2};
  var eq_order=Object.keys(eqCnt).sort(function(a,b){var la=lineOrder[a[0]]!=null?lineOrder[a[0]]:9,lb=lineOrder[b[0]]!=null?lineOrder[b[0]]:9;if(la!==lb)return la-lb;return eqCnt[b]-eqCnt[a]});

  function buildDaily(rows){
    var m={};
    for(var di=0;di<rows.length;di++){
      var rr=rows[di];
      if(!m[rr.ds])m[rr.ds]={ì¼ìstr:rr.ds,cnt:0,defect:0,time:0,stop:0};
      m[rr.ds].cnt++;m[rr.ds].defect+=rr.defect;m[rr.ds].time+=rr.time;if(rr.stop)m[rr.ds].stop++;
    }
    return all_dates.map(function(d){return m[d]||{ì¼ìstr:d,cnt:0,defect:0,time:0,stop:0}});
  }
  var daily=buildDaily(allRows);
  var daily_G=buildDaily(allRows.filter(function(r){return r.line==='G'}));
  var daily_H=buildDaily(allRows.filter(function(r){return r.line==='H'}));
  var daily_K=buildDaily(allRows.filter(function(r){return r.line==='K'}));

  var hdMap={},htMap={};
  for(var hi=0;hi<allRows.length;hi++){var rh=allRows[hi];var k=rh.eq+'|'+rh.ds;hdMap[k]=(hdMap[k]||0)+rh.defect;htMap[k]=(htMap[k]||0)+rh.time}
  var hm_def=[],hm_time=[];
  for(var hk in hdMap){var sp=hk.split('|');hm_def.push({ì„¤ë¹„í˜¸:sp[0],ì¼ìstr:sp[1],ë¶ˆëŸ‰ìˆ˜ëŸ‰:hdMap[hk]})}
  for(var tk in htMap){var sp2=tk.split('|');hm_time.push({ì„¤ë¹„í˜¸:sp2[0],ì¼ìstr:sp2[1],time:htMap[tk]})}

  var line_equips={G:[],H:[],K:[]};
  for(var ei=0;ei<eq_order.length;ei++){var ln=eq_order[ei][0];if(line_equips[ln])line_equips[ln].push(eq_order[ei])}
  var lineSummary={};
  ['G','H','K'].forEach(function(ln){lineSummary[ln]={cnt:allRows.filter(function(r){return r.line===ln}).length,eq:line_equips[ln].length}});

  return {
    daily:daily,daily_G:daily_G,daily_H:daily_H,daily_K:daily_K,
    all_dates:all_dates,eq_order:eq_order,line_equips:line_equips,
    hm_def:hm_def,hm_time:hm_time,allRows:allRows,
    totalRec:allRows.length,totalDef:Math.round(allRows.reduce(function(s,r){return s+r.defect},0)),
    totalTime:Math.round(allRows.reduce(function(s,r){return s+r.time},0)),
    stopCnt:allRows.filter(function(r){return r.stop}).length,
    eqCnt:eq_order.length,
    dateRange:all_dates[0]+' ~ '+all_dates[all_dates.length-1],
    lineSummary:lineSummary,
    prodByDateEq:prodByDateEq,stopByDateEq:stopByDateEq,avgEqST:avgEqST,stDates:stDates,
    prodByWeekEq:prodByWeekEq,stopByWeekEq:stopByWeekEq,weekList:weekList,
    prodTotalEq:prodTotalEq,stopTotalEq:stopTotalEq,eqDates:eqDates,eqWeekDates:eqWeekDates,
    dataVersion:DATA_VERSION,
    _dbg:{sheets:_dbgAllSheets,matchedSheets:_dbgSheets,rows:_dbgRows,dates:Object.keys(prodByDateEq).length,weeks:weekList.length,eqs:Object.keys(prodTotalEq).filter(function(e){return(prodTotalEq[e]||0)>0})}
  };
}

function go(i){document.querySelectorAll('.pn').forEach(function(p,x){p.classList.toggle('on',x===i)});document.querySelectorAll('.tab').forEach(function(t,x){t.classList.toggle('on',x===i)})}
function hcl(v,mx){if(!v||v===0)return'h0';var r=v/mx;return r<.08?'h1':r<.2?'h2':r<.35?'h3':r<.55?'h4':r<.75?'h5':'h6'}

function buildDailyHT(data,vk,equips,dates){
  var lk={},mx=0;
  for(var i=0;i<data.length;i++){var r=data[i];var k=r['ì„¤ë¹„í˜¸']+'|'+r['ì¼ìstr'];var v=r[vk]||0;lk[k]=v;if(v>mx)mx=v}
  var lo={K:0,H:1,G:2};
  var et=equips.map(function(e){return{e:e,t:dates.reduce(function(s,d){return s+(lk[e+'|'+d]||0)},0)}}).sort(function(a,b){var la=lo[a.e[0]]!=null?lo[a.e[0]]:9,lb=lo[b.e[0]]!=null?lo[b.e[0]]:9;if(la!==lb)return la-lb;return b.t-a.t}).map(function(x){return x.e});
  var h='<table class="ht"><thead><tr><th>ì„¤ë¹„\\ì¼ì</th>';
  dates.forEach(function(d){h+='<th>'+d+'</th>'});
  h+='<th style="background:#1e40af">í•©ê³„</th></tr></thead><tbody>';
  var sortField=vk==='time'?'time':'defect';
  et.forEach(function(eq){h+='<tr><th>'+eq+'</th>';var rs=0;dates.forEach(function(d){var v=lk[eq+'|'+d]||0;rs+=v;
    if(v){h+='<td class="'+hcl(v,mx)+' hm-click" onclick="showDetail(\''+eq+'\',\''+d+'\',\''+sortField+'\')">'+Math.round(v).toLocaleString()+'</td>'}
    else{h+='<td class="'+hcl(v,mx)+'"></td>'}
  });h+='<td style="background:#1e3a5f;font-weight:700;color:#60a5fa">'+Math.round(rs).toLocaleString()+'</td></tr>'});
  h+='<tr><th style="background:#1e40af">í•©ê³„</th>';var gt=0;
  dates.forEach(function(d){var cs=et.reduce(function(s,e){return s+(lk[e+'|'+d]||0)},0);gt+=cs;h+='<td style="background:#1e3a5f;font-weight:700;color:#60a5fa">'+Math.round(cs).toLocaleString()+'</td>'});
  h+='<td style="background:#1e40af;font-weight:700;color:#fcd34d">'+Math.round(gt).toLocaleString()+'</td></tr></tbody></table>';
  return h;
}

function showDetail(eq,date,sortBy){
  var rows=(D.allRows||[]).filter(function(r){return r.eq===eq&&r.ds===date});
  if(!rows.length){closeModal();return}
  rows.sort(function(a,b){return b[sortBy]-a[sortBy]});
  var totalAll=rows.length;
  var top10=rows.slice(0,10);
  var totalDef=top10.reduce(function(s,r){return s+r.defect},0);
  var totalTime=top10.reduce(function(s,r){return s+r.time},0);
  var label=sortBy==='defect'?'ë¶ˆëŸ‰ìˆ˜ëŸ‰':'ì¡°ì •ì‹œê°„';
  document.getElementById('modalTitle').textContent=eq+' Â· '+date+' Worst 10 ('+label+' ë‚´ë¦¼ì°¨ìˆœ, ì „ì²´ '+totalAll+'ê±´ ì¤‘ ìƒìœ„ '+top10.length+'ê±´)';
  var t='<table><thead><tr><th>#</th><th>í•­ëª©</th><th>ìƒì„¸ì¡°ì •ë‚´ìš©</th><th>ë¶ˆëŸ‰ìˆ˜ëŸ‰</th><th>ì‹œê°„(ë¶„)</th><th>ì •ì§€</th></tr></thead><tbody>';
  top10.forEach(function(r,i){
    var defCls=sortBy==='defect'&&i===0?' class="highlight"':'';
    var timeCls=sortBy==='time'&&i===0?' class="highlight"':'';
    t+='<tr><td>'+(i+1)+'</td><td>'+r.sub+'</td><td>'+(r.detail||'-')+'</td><td'+defCls+'>'+Math.round(r.defect).toLocaleString()+'</td><td'+timeCls+'>'+Math.round(r.time).toLocaleString()+'</td><td>'+(r.stop?'â›”':'')+'</td></tr>';
  });
  t+='<tr style="background:#1a1a1a;font-weight:700"><td></td><td>í•©ê³„ (Top10)</td><td></td><td>'+Math.round(totalDef).toLocaleString()+'</td><td>'+Math.round(totalTime).toLocaleString()+'</td><td></td></tr>';
  t+='</tbody></table>';
  document.getElementById('modalBody').innerHTML=t;
  document.getElementById('modalOverlay').classList.add('show');
}
function closeModal(){document.getElementById('modalOverlay').classList.remove('show')}

function showEqHeatmap(eq){
  if(!D||!D.allRows||!D.all_dates)return;
  var dates=D.all_dates;
  var recentDates=dates.slice(Math.max(0,dates.length-14));
  // Build daily data for this equipment
  var dayTime={},dayDef={},mxT=0,mxD=0;
  recentDates.forEach(function(d){
    var rows=D.allRows.filter(function(r){return r.eq===eq&&r.ds===d});
    var t=rows.reduce(function(s,r){return s+r.time},0);
    var df=rows.reduce(function(s,r){return s+r.defect},0);
    dayTime[d]=t;dayDef[d]=df;
    if(t>mxT)mxT=t;if(df>mxD)mxD=df;
  });

  document.getElementById('modalTitle').textContent=eq+' ì„¤ë¹„ íˆíŠ¸ë§µ (ìµœê·¼ '+recentDates.length+'ì¼)';
  var t='<div style="overflow-x:auto">';
  t+='<table style="border-collapse:collapse;width:100%;font-size:12px">';
  t+='<thead><tr><th style="background:#1a1a1a;color:#e2e8f0;padding:6px 4px;border:1px solid #1a1a1a;white-space:nowrap">ì¼ì</th>';
  recentDates.forEach(function(d){t+='<th style="background:#1a1a1a;color:#e2e8f0;padding:6px 4px;border:1px solid #1a1a1a;font-size:10px;white-space:nowrap">'+d+'</th>'});
  t+='<th style="background:#1e40af;color:#fff;padding:6px 4px;border:1px solid #1a1a1a">í•©ê³„</th></tr></thead><tbody>';

  // Time row
  t+='<tr><th style="background:#1a1a1a;color:#f59e0b;padding:6px 8px;border:1px solid #1a1a1a;white-space:nowrap">ì •ì§€ì‹œê°„(ë¶„)</th>';
  var sumT=0;
  recentDates.forEach(function(d){
    var v=dayTime[d]||0;sumT+=v;
    var cls=hcl(v,mxT);
    t+='<td class="'+cls+'" style="padding:6px 4px;border:1px solid #1a1a1a;text-align:center;font-size:11px;cursor:pointer" onclick="showDetail(\''+eq+'\',\''+d+'\',\'time\')">'+(v?Math.round(v).toLocaleString():'')+'</td>';
  });
  t+='<td style="background:#1e3a5f;font-weight:700;color:#60a5fa;padding:6px 4px;border:1px solid #1a1a1a;text-align:center">'+Math.round(sumT).toLocaleString()+'</td></tr>';

  // Defect row
  t+='<tr><th style="background:#1a1a1a;color:#ef4444;padding:6px 8px;border:1px solid #1a1a1a;white-space:nowrap">ë¶ˆëŸ‰ìˆ˜ëŸ‰</th>';
  var sumD=0;
  recentDates.forEach(function(d){
    var v=dayDef[d]||0;sumD+=v;
    var cls=hcl(v,mxD);
    t+='<td class="'+cls+'" style="padding:6px 4px;border:1px solid #1a1a1a;text-align:center;font-size:11px;cursor:pointer" onclick="showDetail(\''+eq+'\',\''+d+'\',\'defect\')">'+(v?Math.round(v).toLocaleString():'')+'</td>';
  });
  t+='<td style="background:#1e3a5f;font-weight:700;color:#60a5fa;padding:6px 4px;border:1px solid #1a1a1a;text-align:center">'+Math.round(sumD).toLocaleString()+'</td></tr>';

  t+='</tbody></table></div>';

  // Legend
  t+='<div class="lg" style="margin-top:8px"><div class="li"><div class="lc" style="background:#0a0a0a;border:1px solid #1a1a1a"></div>0</div><div class="li"><div class="lc" style="background:rgba(59,130,246,0.3)"></div>Low</div><div class="li"><div class="lc" style="background:rgba(251,191,36,0.5)"></div>Mid</div><div class="li"><div class="lc" style="background:rgba(239,68,68,0.7)"></div>High</div></div>';
  t+='<div style="margin-top:6px;font-size:10px;color:#94a3b8">* ì…€ í´ë¦­ ì‹œ í•´ë‹¹ ì¼ì ìƒì„¸ ë‚´ì—­ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>';

  document.getElementById('modalBody').innerHTML=t;
  document.getElementById('modalOverlay').classList.add('show');
}

function showDayDetail(date,lineFilt){
  var rows=(D.allRows||[]).filter(function(r){return r.ds===date&&(!lineFilt||r.line===lineFilt)});
  if(!rows.length){closeModal();return}
  var byDefect=rows.slice().sort(function(a,b){return b.defect-a.defect||b.time-a.time}).slice(0,5);
  var byTime=rows.slice().sort(function(a,b){return b.time-a.time||b.defect-a.defect}).slice(0,5);
  var titleTxt=date+' Worst 5'+(lineFilt?' ('+lineFilt+' Line)':' (ì „ì²´)');
  document.getElementById('modalTitle').textContent=titleTxt;
  var defTotalDef=byDefect.reduce(function(s,r){return s+r.defect},0);
  var defTotalTime=byDefect.reduce(function(s,r){return s+r.time},0);
  var timeTotalDef=byTime.reduce(function(s,r){return s+r.defect},0);
  var timeTotalTime=byTime.reduce(function(s,r){return s+r.time},0);
  var t='<div style="margin-bottom:14px"><div style="color:#ef4444;font-weight:700;font-size:13px;margin-bottom:6px">ğŸ”´ ë¶ˆëŸ‰ìˆ˜ëŸ‰ ê¸°ì¤€ Top 5</div>';
  t+='<table><thead><tr><th>#</th><th>ì„¤ë¹„</th><th>í•­ëª©</th><th>ìƒì„¸ì¡°ì •ë‚´ìš©</th><th>ë¶ˆëŸ‰ìˆ˜ëŸ‰</th><th>ì‹œê°„(ë¶„)</th></tr></thead><tbody>';
  byDefect.forEach(function(r,i){
    var defCls=i===0?' class="highlight"':'';
    t+='<tr><td>'+(i+1)+'</td><td>'+r.eq+'</td><td>'+r.sub+'</td><td>'+(r.detail||'-')+'</td><td'+defCls+'>'+Math.round(r.defect).toLocaleString()+'</td><td>'+Math.round(r.time).toLocaleString()+'</td></tr>';
  });
  t+='<tr style="background:#1a1a1a;font-weight:700"><td></td><td>í•©ê³„</td><td></td><td></td><td>'+Math.round(defTotalDef).toLocaleString()+'</td><td>'+Math.round(defTotalTime).toLocaleString()+'</td></tr>';
  t+='</tbody></table></div>';
  t+='<div><div style="color:#22c55e;font-weight:700;font-size:13px;margin-bottom:6px">ğŸŸ¢ ì •ì§€ì‹œê°„ ê¸°ì¤€ Top 5</div>';
  t+='<table><thead><tr><th>#</th><th>ì„¤ë¹„</th><th>í•­ëª©</th><th>ìƒì„¸ì¡°ì •ë‚´ìš©</th><th>ë¶ˆëŸ‰ìˆ˜ëŸ‰</th><th>ì‹œê°„(ë¶„)</th></tr></thead><tbody>';
  byTime.forEach(function(r,i){
    var timeCls=i===0?' style="color:#22c55e;font-weight:700"':'';
    t+='<tr><td>'+(i+1)+'</td><td>'+r.eq+'</td><td>'+r.sub+'</td><td>'+(r.detail||'-')+'</td><td>'+Math.round(r.defect).toLocaleString()+'</td><td'+timeCls+'>'+Math.round(r.time).toLocaleString()+'</td></tr>';
  });
  t+='<tr style="background:#1a1a1a;font-weight:700"><td></td><td>í•©ê³„</td><td></td><td></td><td>'+Math.round(timeTotalDef).toLocaleString()+'</td><td>'+Math.round(timeTotalTime).toLocaleString()+'</td></tr>';
  t+='</tbody></table></div>';
  document.getElementById('modalBody').innerHTML=t;
  document.getElementById('modalOverlay').classList.add('show');
}

function makeDailyChart(canvasId, data, title, barColor, lineFilt, yMax, y1Max){
  // Compute unique equipment count per date
  var eqCntByDate={};
  data.forEach(function(r){
    var d=r['ì¼ìstr'];
    var rows=D.allRows.filter(function(rr){return rr.ds===d&&(!lineFilt||rr.line===lineFilt)});
    var eqs={};rows.forEach(function(rr){eqs[rr.eq]=1});
    eqCntByDate[d]=Object.keys(eqs).length;
  });
  var labels=data.map(function(r){var d=r['ì¼ìstr'];return[d,(eqCntByDate[d]||0)+'ëŒ€']});
  var ch=new Chart(canvasId,{type:'bar',data:{labels:labels,datasets:[
    {label:'ì‹œê°„(ë¶„)',data:data.map(function(r){return Math.round(r.time)}),backgroundColor:barColor+'B3',borderRadius:4,yAxisID:'y',order:2},
    {label:'ë¶ˆëŸ‰ìˆ˜ëŸ‰',data:data.map(function(r){return Math.round(r.defect)}),type:'line',borderColor:'#ef4444',borderWidth:2,pointRadius:3,pointBackgroundColor:'#ef4444',yAxisID:'y1',tension:.3,order:1}
  ]},options:{responsive:true,maintainAspectRatio:true,onClick:function(evt,els){
    if(!els.length)return;var idx=els[0].index;var date=data[idx]['ì¼ìstr'];showDayDetail(date,lineFilt||null);
  },plugins:{legend:{labels:{color:'#94a3b8',font:{size:10}}},tooltip:{backgroundColor:'#0a0a0a',titleColor:'#60a5fa',bodyColor:'#e2e8f0',callbacks:{title:function(items){if(!items.length)return'';var idx=items[0].dataIndex;return data[idx]['ì¼ìstr']+' ('+( eqCntByDate[data[idx]['ì¼ìstr']]||0)+'ëŒ€)'},label:function(c){return c.dataset.label+': '+c.parsed.y.toLocaleString()}}}},scales:{
    x:{ticks:{color:'#94a3b8',font:{size:10},callback:function(val,idx){var lb=this.getLabelForValue(idx);if(Array.isArray(lb))return lb;return[lb]}},grid:{color:'#1a1a1a'}},
    y:{position:'left',ticks:{color:barColor,callback:function(v){return v.toLocaleString()}},grid:{color:'#1a1a1a'},title:{display:true,text:'ì‹œê°„(ë¶„)',color:barColor,font:{size:10}},beginAtZero:true,max:yMax||undefined},
    y1:{position:'right',ticks:{color:'#ef4444',font:{size:9},callback:function(v){return v.toLocaleString()}},grid:{drawOnChartArea:false},title:{display:true,text:'ë¶ˆëŸ‰ìˆ˜ëŸ‰',color:'#ef4444',font:{size:10}},beginAtZero:true,max:y1Max||undefined}
  }}});
  return ch;
}

function makeStopChart(canvasId, data, barColorStop, barColorNon){
  return new Chart(canvasId,{type:'bar',data:{labels:data.map(function(r){return r['ì¼ìstr']}),datasets:[
    {label:'ì •ì§€',data:data.map(function(r){return r.stop}),backgroundColor:barColorStop,borderRadius:3},
    {label:'ë¹„ì •ì§€',data:data.map(function(r){return r.cnt-r.stop}),backgroundColor:barColorNon,borderRadius:3}
  ]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{labels:{color:'#94a3b8',font:{size:10}}},tooltip:{backgroundColor:'#0a0a0a',bodyColor:'#e2e8f0',callbacks:{label:function(c){return c.dataset.label+': '+c.parsed.y.toLocaleString()}}}},scales:{
    x:{stacked:true,ticks:{color:'#94a3b8',font:{size:10}},grid:{color:'#1a1a1a'}},
    y:{stacked:true,ticks:{color:'#94a3b8',callback:function(v){return v.toLocaleString()}},grid:{color:'#1a1a1a'}}
  }}});
}

function buildStopTable(data){
  var ts=0,tn=0;
  var h='<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">';
  h+='<div style="max-height:400px;overflow-y:auto"><table class="worst-tbl"><thead><tr><th colspan="2" style="color:#ef4444">â›” ì •ì§€</th></tr><tr><th>ì¼ì</th><th>ê±´ìˆ˜</th></tr></thead><tbody>';
  data.forEach(function(r){var v=r.stop;ts+=v;h+='<tr><td>'+r['ì¼ìstr']+'</td><td'+(v>0?' style="color:#ef4444;font-weight:700"':'')+'>'+v+'</td></tr>'});
  h+='<tr style="background:#1e40af"><td style="font-weight:700;color:#fff">í•©ê³„</td><td style="font-weight:700;color:#ef4444">'+ts+'</td></tr>';
  h+='</tbody></table></div>';
  h+='<div style="max-height:400px;overflow-y:auto"><table class="worst-tbl"><thead><tr><th colspan="2" style="color:#22c55e">âœ… ë¹„ì •ì§€</th></tr><tr><th>ì¼ì</th><th>ê±´ìˆ˜</th></tr></thead><tbody>';
  data.forEach(function(r){var v=r.cnt-r.stop;tn+=v;h+='<tr><td>'+r['ì¼ìstr']+'</td><td'+(v>0?' style="color:#22c55e;font-weight:700"':'')+'>'+v+'</td></tr>'});
  h+='<tr style="background:#1e40af"><td style="font-weight:700;color:#fff">í•©ê³„</td><td style="font-weight:700;color:#22c55e">'+tn+'</td></tr>';
  h+='</tbody></table></div></div>';
  return h;
}

function buildStopTableWide(data){
  var h='<div class="hc"><table class="ht"><thead><tr><th>êµ¬ë¶„</th>';
  data.forEach(function(r){h+='<th>'+r['ì¼ìstr']+'</th>'});
  h+='<th style="background:#1e40af">í•©ê³„</th></tr></thead><tbody>';
  var tc=0;
  h+='<tr><th style="color:#60a5fa">ğŸ“‹ ê±´ìˆ˜</th>';
  data.forEach(function(r){var v=r.cnt;tc+=v;h+='<td style="color:#60a5fa;font-weight:700">'+v+'</td>'});
  h+='<td style="background:#1e3a5f;font-weight:700;color:#60a5fa">'+tc+'</td></tr>';
  var ts=0;
  h+='<tr><th style="color:#ef4444">â›” ì •ì§€</th>';
  data.forEach(function(r){var v=r.stop;ts+=v;h+='<td'+(v>0?' style="color:#ef4444;font-weight:700"':'')+'>'+v+'</td>'});
  h+='<td style="background:#1e3a5f;font-weight:700;color:#ef4444">'+ts+'</td></tr>';
  var tn=0;
  h+='<tr><th style="color:#22c55e">âœ… ë¹„ì •ì§€</th>';
  data.forEach(function(r){var v=r.cnt-r.stop;tn+=v;h+='<td'+(v>0?' style="color:#22c55e;font-weight:700"':'')+'>'+v+'</td>'});
  h+='<td style="background:#1e3a5f;font-weight:700;color:#22c55e">'+tn+'</td></tr>';
  h+='</tbody></table></div>';
  return h;
}

function buildSummaryPage(){
  if(!D||!D.allRows||!D.all_dates||D.all_dates.length===0)return'<div style="padding:20px;color:#94a3b8">ë°ì´í„°ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤</div>';
  var KPI_TARGET=50;
  var dates=D.all_dates;
  var lastDate=dates[dates.length-1];
  var lines=['K','G','H'];
  var lineColors={K:'#f59e0b',G:'#06b6d4',H:'#22c55e'};

  var weekDates=dates.slice(Math.max(0,dates.length-7));
  var monthDates=dates.slice(Math.max(0,dates.length-30));

  // Helper: get average stop time per equipment for a line on a date
  // e.g. K12=30min, K11=30min â†’ avg = (30+30)/2 = 30min
  function getLineEqAvgStop(dt,line){
    var rows=D.allRows.filter(function(r){return r.ds===dt&&r.line===line});
    if(!rows.length)return 0;
    var eqMap={};
    rows.forEach(function(r){
      if(!eqMap[r.eq])eqMap[r.eq]=0;
      if(r.stop)eqMap[r.eq]+=r.time;
    });
    var eqs=Object.keys(eqMap);
    if(!eqs.length)return 0;
    var total=eqs.reduce(function(s,eq){return s+eqMap[eq]},0);
    return total/eqs.length;
  }
  // Helper: average of daily equipment averages over multiple dates
  function getLineEqAvgStopMulti(dts,line){
    if(!dts.length)return 0;
    var sum=dts.reduce(function(s,dt){return s+getLineEqAvgStop(dt,line)},0);
    return sum/dts.length;
  }
  // Helper: get average stop time per equipment for ALL lines on a date
  function getAllEqAvgStop(dt){
    var rows=D.allRows.filter(function(r){return r.ds===dt});
    if(!rows.length)return 0;
    var eqMap={};
    rows.forEach(function(r){
      if(!eqMap[r.eq])eqMap[r.eq]=0;
      if(r.stop)eqMap[r.eq]+=r.time;
    });
    var eqs=Object.keys(eqMap);
    if(!eqs.length)return 0;
    var total=eqs.reduce(function(s,eq){return s+eqMap[eq]},0);
    return total/eqs.length;
  }
  // Helper: average of daily equipment averages for ALL lines over multiple dates
  function getAllEqAvgStopMulti(dts){
    if(!dts.length)return 0;
    var sum=dts.reduce(function(s,dt){return s+getAllEqAvgStop(dt)},0);
    return sum/dts.length;
  }

  function fmtCell(v,target){
    var rounded=Math.round(v);
    var cls=rounded<=target?'good':'bad';
    return'<span class="'+cls+'">'+rounded.toLocaleString()+'ë¶„</span>';
  }

  // === Section 1: Stop Time KPI by Line (per-equipment average) ===
  var h='<div class="sum-section"><div class="bx"><h3>&#9201; ë¼ì¸ë³„ ì •ì§€ì‹œê°„ KPI í˜„í™© <em>ëª©í‘œ: '+KPI_TARGET+'ë¶„/ì¼ (ì„¤ë¹„ë³„ í‰ê· )</em></h3>';
  h+='<table class="sum-tbl"><thead><tr><th>êµ¬ë¶„</th><th style="color:#60a5fa">ì „ì²´</th>';
  lines.forEach(function(ln){h+='<th style="color:'+lineColors[ln]+'">'+ln+' Line</th>'});
  h+='</tr></thead><tbody>';

  // ì „ì¼
  var allDayAvg=getAllEqAvgStop(lastDate);
  h+='<tr><td>ì „ì¼</td>';
  h+='<td>'+fmtCell(allDayAvg,KPI_TARGET)+'</td>';
  lines.forEach(function(ln){
    var v=getLineEqAvgStop(lastDate,ln);
    h+='<td>'+fmtCell(v,KPI_TARGET)+'</td>';
  });
  h+='</tr>';

  // ì£¼ê°„
  var allWeekAvg=getAllEqAvgStopMulti(weekDates);
  h+='<tr><td>ì£¼ê°„</td>';
  h+='<td>'+fmtCell(allWeekAvg,KPI_TARGET)+'</td>';
  lines.forEach(function(ln){
    var v=getLineEqAvgStopMulti(weekDates,ln);
    h+='<td>'+fmtCell(v,KPI_TARGET)+'</td>';
  });
  h+='</tr>';

  // ì›”ê°„
  var allMonthAvg=getAllEqAvgStopMulti(monthDates);
  h+='<tr><td>ì›”ê°„</td>';
  h+='<td>'+fmtCell(allMonthAvg,KPI_TARGET)+'</td>';
  lines.forEach(function(ln){
    var v=getLineEqAvgStopMulti(monthDates,ln);
    h+='<td>'+fmtCell(v,KPI_TARGET)+'</td>';
  });
  h+='</tr>';
  h+='</tbody></table></div></div>';

  // === Section 1-2: Persistent Problem Equipment (Top 3) ===
  // Find equipment with consistently high stop time + defect over 7+ days
  var recentDates=dates.slice(Math.max(0,dates.length-7));
  var allEqs=Object.keys(D.allRows.reduce(function(m,r){m[r.eq]=1;return m},{}));

  var eqScores=[];
  allEqs.forEach(function(eq){
    var dailyTime=recentDates.map(function(dt){
      return D.allRows.filter(function(r){return r.eq===eq&&r.ds===dt&&r.stop}).reduce(function(s,r){return s+r.time},0);
    });
    var dailyDef=recentDates.map(function(dt){
      return D.allRows.filter(function(r){return r.eq===eq&&r.ds===dt}).reduce(function(s,r){return s+r.defect},0);
    });
    // Count days with non-zero stop time
    var activeDays=dailyTime.filter(function(v){return v>0}).length;
    if(activeDays<Math.min(3,recentDates.length))return; // at least 3 days active
    var avgTime=dailyTime.reduce(function(a,b){return a+b},0)/recentDates.length;
    var avgDef=dailyDef.reduce(function(a,b){return a+b},0)/recentDates.length;
    var totalTime=dailyTime.reduce(function(a,b){return a+b},0);
    var totalDef=dailyDef.reduce(function(a,b){return a+b},0);
    // Get top adjustment items
    var subMap={};
    D.allRows.filter(function(r){return r.eq===eq&&recentDates.indexOf(r.ds)>=0}).forEach(function(r){
      var k=r.sub||'ê¸°íƒ€';subMap[k]=(subMap[k]||0)+1;
    });
    var topSubs=Object.keys(subMap).sort(function(a,b){return subMap[b]-subMap[a]}).slice(0,3).map(function(k){return k+'('+subMap[k]+')'}).join(', ');
    eqScores.push({eq:eq,activeDays:activeDays,avgTime:avgTime,avgDef:avgDef,totalTime:totalTime,totalDef:totalDef,dailyTime:dailyTime,dailyDef:dailyDef,topSubs:topSubs});
  });
  // Sort by combined score: total stop time + total defect (both high = problem)
  eqScores.sort(function(a,b){return(b.totalTime+b.totalDef)-(a.totalTime+a.totalDef)});
  var top3=eqScores.slice(0,3);

  h+='<div class="sum-section"><div class="bx"><h3>&#9888; ë¬¸ì œì„¤ë¹„ TOP 3 <em>ìµœê·¼ '+recentDates.length+'ì¼ê°„ ì •ì§€ì‹œê°„+ë¶ˆëŸ‰ ì§€ì† ë†’ì€ ì„¤ë¹„</em></h3>';
  h+='<table class="sum-tbl"><thead><tr><th>#</th><th>ì„¤ë¹„</th><th>ì •ì§€ì‹œê°„(ì£¼ê°„)</th><th>ì •ì§€ê±´ìˆ˜</th><th>ë¶ˆëŸ‰ìˆ˜ëŸ‰(ì£¼ê°„)</th><th>ì£¼ìš” ì¡°ì •í•­ëª©</th></tr></thead><tbody>';
  if(top3.length){
    top3.forEach(function(item,idx){
      var stopCnt=D.allRows.filter(function(r){return r.eq===item.eq&&recentDates.indexOf(r.ds)>=0&&r.stop}).length;
      h+='<tr>';
      h+='<td style="font-weight:700">'+(idx+1)+'</td>';
      h+='<td style="font-weight:700;color:#60a5fa;cursor:pointer;text-decoration:underline" onclick="showEqHeatmap(\''+item.eq+'\')">'+item.eq+'</td>';
      h+='<td style="color:#f59e0b;font-weight:700">'+Math.round(item.totalTime).toLocaleString()+'ë¶„<br><span style="font-size:10px;color:#94a3b8;font-weight:400">ì¼í‰ê·  '+Math.round(item.avgTime).toLocaleString()+'ë¶„</span></td>';
      h+='<td>'+stopCnt+'ê±´<br><span style="font-size:10px;color:#94a3b8">'+item.activeDays+'/'+recentDates.length+'ì¼</span></td>';
      h+='<td style="color:#ef4444;font-weight:700">'+Math.round(item.totalDef).toLocaleString()+'<br><span style="font-size:10px;color:#94a3b8;font-weight:400">ì¼í‰ê·  '+Math.round(item.avgDef).toLocaleString()+'</span></td>';
      h+='<td style="text-align:left;font-size:11px">'+item.topSubs+'</td>';
      h+='</tr>';
    });
  }else{
    h+='<tr><td colspan="6" style="color:#22c55e">í•´ë‹¹ ì„¤ë¹„ ì—†ìŒ</td></tr>';
  }
  h+='</tbody></table></div></div>';

  // === Section 2: Previous day Worst 5 - Combined Time + Defect + Adjustment Items ===
  var prevRows=D.allRows.filter(function(r){return r.ds===lastDate});

  // Aggregate by equipment: time, defect, adjustment items
  var eqAgg={};
  prevRows.forEach(function(r){
    if(!eqAgg[r.eq])eqAgg[r.eq]={time:0,defect:0,subs:{}};
    eqAgg[r.eq].time+=r.time;
    eqAgg[r.eq].defect+=r.defect;
    var subKey=r.sub||'ê¸°íƒ€';
    if(!eqAgg[r.eq].subs[subKey])eqAgg[r.eq].subs[subKey]=0;
    eqAgg[r.eq].subs[subKey]++;
  });

  // Get top adjustment items summary for an equipment
  function getTopSubs(subsMap){
    var arr=Object.keys(subsMap).map(function(k){return{name:k,cnt:subsMap[k]}}).sort(function(a,b){return b.cnt-a.cnt});
    return arr.slice(0,3).map(function(s){return s.name+'('+s.cnt+')'}).join(', ');
  }

  // Sort by time desc for Worst 5
  var timeWorst5=Object.keys(eqAgg).map(function(eq){return{eq:eq,time:eqAgg[eq].time,defect:eqAgg[eq].defect,subs:eqAgg[eq].subs}}).sort(function(a,b){return b.time-a.time}).slice(0,5);
  // Sort by defect desc for Worst 5
  var defWorst5=Object.keys(eqAgg).map(function(eq){return{eq:eq,time:eqAgg[eq].time,defect:eqAgg[eq].defect,subs:eqAgg[eq].subs}}).sort(function(a,b){return b.defect-a.defect}).slice(0,5);

  h+='<div class="sum-section"><div class="bx"><h3>&#128308; ì „ì¼ ('+lastDate+') Worst 5 ì„¤ë¹„</h3>';
  h+='<div class="worst-grid">';

  // Time Worst 5
  h+='<div class="worst-card"><h4 style="color:#f59e0b">&#9200; ì •ì§€ì‹œê°„ ê¸°ì¤€ Worst 5</h4>';
  h+='<table class="worst-tbl"><thead><tr><th>#</th><th>ì„¤ë¹„</th><th>ì‹œê°„(ë¶„)<br><span style="font-size:10px;color:#94a3b8">ë¶ˆëŸ‰ìˆ˜ëŸ‰</span></th><th>ì£¼ìš” ì¡°ì •í•­ëª©</th></tr></thead><tbody>';
  timeWorst5.forEach(function(item,i){
    h+='<tr><td>'+(i+1)+'</td><td>'+item.eq+'</td>';
    h+='<td><span style="color:#f59e0b;font-weight:700">'+Math.round(item.time).toLocaleString()+'ë¶„</span><br><span style="font-size:11px;color:#94a3b8">ë¶ˆëŸ‰ '+Math.round(item.defect).toLocaleString()+'</span></td>';
    h+='<td style="text-align:left;font-size:11px">'+getTopSubs(item.subs)+'</td></tr>';
  });
  if(!timeWorst5.length)h+='<tr><td colspan="4" style="color:#94a3b8">ë°ì´í„° ì—†ìŒ</td></tr>';
  h+='</tbody></table></div>';

  // Defect Worst 5
  h+='<div class="worst-card"><h4 style="color:#ef4444">&#128165; ë¶ˆëŸ‰ìˆ˜ëŸ‰ ê¸°ì¤€ Worst 5</h4>';
  h+='<table class="worst-tbl"><thead><tr><th>#</th><th>ì„¤ë¹„</th><th>ë¶ˆëŸ‰ìˆ˜ëŸ‰<br><span style="font-size:10px;color:#94a3b8">ì‹œê°„(ë¶„)</span></th><th>ì£¼ìš” ì¡°ì •í•­ëª©</th></tr></thead><tbody>';
  defWorst5.forEach(function(item,i){
    h+='<tr><td>'+(i+1)+'</td><td>'+item.eq+'</td>';
    h+='<td><span style="color:#ef4444;font-weight:700">'+Math.round(item.defect).toLocaleString()+'</span><br><span style="font-size:11px;color:#94a3b8">'+Math.round(item.time).toLocaleString()+'ë¶„</span></td>';
    h+='<td style="text-align:left;font-size:11px">'+getTopSubs(item.subs)+'</td></tr>';
  });
  if(!defWorst5.length)h+='<tr><td colspan="4" style="color:#94a3b8">ë°ì´í„° ì—†ìŒ</td></tr>';
  h+='</tbody></table></div>';

  h+='</div></div></div>';

  // === Section 3: Weekly performance chart for worst 5 equipment (by time) ===
  h+='<div class="sum-section"><div class="bx"><h3>&#128200; ì „ì¼ ì •ì§€ì‹œê°„ Worst 5 - ì£¼ê°„ ì‹¤ì  ì¶”ì´</h3>';
  h+='<div style="position:relative;max-height:400px"><canvas id="worstWeekChart"></canvas></div>';
  h+='</div></div>';

  return h;
}

function renderWorstWeekChart(){
  if(!D||!D.allRows||!D.all_dates||D.all_dates.length===0)return;
  var dates=D.all_dates;
  var lastDate=dates[dates.length-1];
  var weekDates=dates.slice(Math.max(0,dates.length-7));

  // Get worst 5 by time for previous day
  var prevRows=D.allRows.filter(function(r){return r.ds===lastDate});
  var eqTimeMap={};
  prevRows.forEach(function(r){
    if(!eqTimeMap[r.eq])eqTimeMap[r.eq]=0;
    eqTimeMap[r.eq]+=r.time;
  });
  var worst5=Object.keys(eqTimeMap).map(function(eq){return{eq:eq,val:eqTimeMap[eq]}}).sort(function(a,b){return b.val-a.val}).slice(0,5);
  if(!worst5.length)return;

  var colors=['#ef4444','#f59e0b','#3b82f6','#22c55e','#a855f7'];
  var datasets=worst5.map(function(item,idx){
    var data=weekDates.map(function(d){
      return D.allRows.filter(function(r){return r.eq===item.eq&&r.ds===d}).reduce(function(s,r){return s+r.time},0);
    });
    return{
      label:item.eq,
      data:data,
      borderColor:colors[idx%5],
      backgroundColor:colors[idx%5]+'33',
      borderWidth:2,
      pointRadius:4,
      pointBackgroundColor:colors[idx%5],
      tension:0.3,
      fill:false
    };
  });

  var canvas=document.getElementById('worstWeekChart');
  if(!canvas)return;
  var ch=new Chart(canvas,{
    type:'line',
    data:{labels:weekDates,datasets:datasets},
    options:{
      responsive:true,maintainAspectRatio:true,
      plugins:{
        legend:{labels:{color:'#e2e8f0',font:{size:11}},position:'bottom'},
        tooltip:{backgroundColor:'#0a0a0a',titleColor:'#60a5fa',bodyColor:'#e2e8f0',callbacks:{label:function(c){return c.dataset.label+': '+Math.round(c.parsed.y).toLocaleString()+'ë¶„'}}}
      },
      scales:{
        x:{ticks:{color:'#94a3b8',font:{size:11}},grid:{color:'#1a1a1a'}},
        y:{ticks:{color:'#94a3b8',callback:function(v){return v+'ë¶„'}},grid:{color:'#1a1a1a'},title:{display:true,text:'ì •ì§€ì‹œê°„(ë¶„)',color:'#94a3b8',font:{size:11}},
          beginAtZero:true
        }
      }
    }
  });
  charts.push(ch);
}

function renderAll(){
  charts.forEach(function(c){try{c.destroy()}catch(e){}});charts=[];
  if(!D)return;

  var ls=D.lineSummary||{};

  document.getElementById('info').textContent=D.dateRange+' | PMè°ƒæ•´ Only | åœæœº/å¼€æœº ì œì™¸ | >1000ë¶„ ì œì™¸ | ì„¤ë¹„ '+D.eqCnt+'ëŒ€';

  document.getElementById('tabArea').innerHTML=
    '<div class="tab on" onclick="go(0)">ğŸ“‹ ìš”ì•½</div>'+
    '<div class="tab" onclick="go(1)">ğŸ“… ì¼ìë³„ ì¶”ì´</div>'+
    '<div class="tab" onclick="go(2)">ğŸ”¥ íˆíŠ¸ë§µ(ë¶ˆëŸ‰/ì¼ì)</div>'+
    '<div class="tab" onclick="go(3)">ğŸ”¥ íˆíŠ¸ë§µ(ì‹œê°„/ì¼ì)</div>'+
    '<div class="tab" onclick="go(4)">â± ì‹œê°„ëŒ€ë¹„ë¶„æ</div>';

  var legend='<div class="lg"><div class="li"><div class="lc" style="background:#0a0a0a;border:1px solid #1a1a1a"></div>0</div><div class="li"><div class="lc" style="background:rgba(59,130,246,0.3)"></div>Low</div><div class="li"><div class="lc" style="background:rgba(251,191,36,0.5)"></div>Mid</div><div class="li"><div class="lc" style="background:rgba(239,68,68,0.7)"></div>High</div></div>';

  document.getElementById('root').innerHTML=
  '<div class="pn on" id="summaryPanel">'+buildSummaryPage()+'</div>'+
  '<div class="pn">'+
    '<div class="bx"><h3>ğŸ“… ì „ì²´ ì¼ìë³„ ì •ì§€ì‹œê°„ / ë¶ˆëŸ‰ìˆ˜ëŸ‰<em>Total '+D.totalRec.toLocaleString()+'ê±´</em></h3><canvas id="dAll"></canvas></div>'+
    '<div class="bx"><h3>ğŸ“Š ì „ì²´ ì •ì§€ vs ë¹„ì •ì§€</h3><div class="hc" id="tAllS"></div></div>'+
    '<hr style="border:1px solid #1a1a1a;margin:20px 0">'+
    '<div class="bx" style="border-left:3px solid #06b6d4"><h3><span class="line-label" style="background:#06b6d420;color:#06b6d4">G Line</span> ì¼ìë³„ ì •ì§€ì‹œê°„ / ë¶ˆëŸ‰ìˆ˜ëŸ‰<em>'+((ls.G||{}).cnt||0).toLocaleString()+'ê±´ Â· ì„¤ë¹„ '+((ls.G||{}).eq||0)+'ëŒ€</em></h3><canvas id="dG"></canvas></div>'+
    '<div class="bx" style="border-left:3px solid #06b6d4"><h3><span class="line-label" style="background:#06b6d420;color:#06b6d4">G Line</span> ì •ì§€ vs ë¹„ì •ì§€</h3><div id="tGS"></div></div>'+
    '<hr style="border:1px solid #1a1a1a;margin:20px 0">'+
    '<div class="bx" style="border-left:3px solid #22c55e"><h3><span class="line-label" style="background:#22c55e20;color:#22c55e">H Line</span> ì¼ìë³„ ì •ì§€ì‹œê°„ / ë¶ˆëŸ‰ìˆ˜ëŸ‰<em>'+((ls.H||{}).cnt||0).toLocaleString()+'ê±´ Â· ì„¤ë¹„ '+((ls.H||{}).eq||0)+'ëŒ€</em></h3><canvas id="dH"></canvas></div>'+
    '<div class="bx" style="border-left:3px solid #22c55e"><h3><span class="line-label" style="background:#22c55e20;color:#22c55e">H Line</span> ì •ì§€ vs ë¹„ì •ì§€</h3><div id="tHS"></div></div>'+
    '<hr style="border:1px solid #1a1a1a;margin:20px 0">'+
    '<div class="bx" style="border-left:3px solid #f59e0b"><h3><span class="line-label" style="background:#f59e0b20;color:#f59e0b">K Line</span> ì¼ìë³„ ì •ì§€ì‹œê°„ / ë¶ˆëŸ‰ìˆ˜ëŸ‰<em>'+((ls.K||{}).cnt||0).toLocaleString()+'ê±´ Â· ì„¤ë¹„ '+((ls.K||{}).eq||0)+'ëŒ€</em></h3><canvas id="dK"></canvas></div>'+
    '<div class="bx" style="border-left:3px solid #f59e0b"><h3><span class="line-label" style="background:#f59e0b20;color:#f59e0b">K Line</span> ì •ì§€ vs ë¹„ì •ì§€</h3><div id="tKS"></div></div>'+
  '</div>'+
  '<div class="pn"><div class="bx"><h3>ğŸ”¥ ì„¤ë¹„ ì¼ìë³„ ë¶ˆëŸ‰ìˆ˜ëŸ‰</h3>'+legend+'<div class="hc" id="hm_def"></div></div></div>'+
  '<div class="pn"><div class="bx"><h3>ğŸ”¥ ì„¤ë¹„ ì¼ìë³„ ì¡°ì •ì‹œê°„(ë¶„)</h3>'+legend+'<div class="hc" id="hm_time"></div></div></div>'+
  '<div class="pn" id="stAnalysisPanel">'+buildSTAnalysisPage(D.stDates&&D.stDates.length?D.stDates[D.stDates.length-1]:'','daily')+'</div>';

  // Render summary chart
  renderWorstWeekChart();

  var maxTime=0,fixedQty=10000,exceeded=false;
  [D.daily_G,D.daily_H,D.daily_K].forEach(function(ld){ld.forEach(function(r){var t=Math.round(r.time);if(t>maxTime)maxTime=t;var d=Math.round(r.defect);if(d>fixedQty){fixedQty=Math.ceil(d/1000)*1000;exceeded=true}})});
  var fixedTime=Math.ceil(maxTime*1.1/100)*100||100;
  if(exceeded){D.daily.forEach(function(r){var t=Math.round(r.time);var ft=Math.ceil(t*1.1/100)*100;if(ft>fixedTime)fixedTime=ft;var d=Math.round(r.defect);if(d>fixedQty)fixedQty=Math.ceil(d/1000)*1000})}
  charts.push(makeDailyChart('dAll', D.daily, 'Total', '#3b82f6', null, exceeded?fixedTime:null, exceeded?fixedQty:null));
  document.getElementById('tAllS').innerHTML=buildStopTableWide(D.daily);
  charts.push(makeDailyChart('dG', D.daily_G, 'G Line', '#06b6d4', 'G', fixedTime, fixedQty));
  document.getElementById('tGS').innerHTML=buildStopTableWide(D.daily_G);
  charts.push(makeDailyChart('dH', D.daily_H, 'H Line', '#22c55e', 'H', fixedTime, fixedQty));
  document.getElementById('tHS').innerHTML=buildStopTableWide(D.daily_H);
  charts.push(makeDailyChart('dK', D.daily_K, 'K Line', '#f59e0b', 'K', fixedTime, fixedQty));
  document.getElementById('tKS').innerHTML=buildStopTableWide(D.daily_K);

  document.getElementById('hm_def').innerHTML=buildDailyHT(D.hm_def,'ë¶ˆëŸ‰ìˆ˜ëŸ‰',D.eq_order,D.all_dates);
  document.getElementById('hm_time').innerHTML=buildDailyHT(D.hm_time,'time',D.eq_order,D.all_dates);
}

var ST_EQ_LIST=['K07','K08','K09','K10','K11','K12','K13','K14','H01','H02','H03','H04','H07','H08','H09','H10','G15','G16','G17','G18'];

function getSTActual(eq){
  if(eq==='K13'||eq==='K14')return 1.85;
  if(eq[0]==='H')return 3.75;
  var avgST=(D.avgEqST||{})[eq]||0; if(!avgST)return null;
  if(['K09','K10','K11','K12'].indexOf(eq)>=0)return avgST/4;
  return avgST/2;
}

function buildSTTable(prod,stop,getCapaFn){
  function concluCell(v){if(!v)return'<td></td>';if(v==='ì •ìƒ')return'<td class="good">ì •ìƒ</td>';return'<td class="bad">'+v+'</td>'}
  function diffCell(v){if(v===null||v===undefined)return'<td></td>';var s=(v>=0?'+':'')+Math.round(v).toLocaleString();return'<td style="color:'+(v>=0?'#22c55e':'#ef4444')+';font-weight:700">'+s+'</td>'}
  var sumCapa=0,sumProd=0,sumStop=0,sumStopQty=0,rows=[];
  ST_EQ_LIST.forEach(function(eq){
    var stA=getSTActual(eq); if(!stA)return;
    var production=prod[eq]||0;
    if(!production)return; // ìƒì‚°ëŸ‰ ì—†ëŠ” ì„¤ë¹„ ì œì™¸
    var capa=getCapaFn(eq,stA);
    if(!capa)return; // capa 0ì´ë©´ ì œì™¸
    var stopTime=stop[eq]||0;
    var stopQty=stopTime>0?(stopTime*60/stA):0;
    var rate=production/capa;
    var diff=production-capa;
    var cvDiff=diff>0?diff-stopQty:diff+stopQty;
    var conclu=Math.abs(cvDiff)>500?(diff>0?'S/T ì´ìƒ':'ê¸°ë¡ì´ìƒ'):'ì •ìƒ';
    sumCapa+=capa;sumProd+=production;sumStop+=stopTime;sumStopQty+=stopQty;
    rows.push({eq:eq,stA:stA,capa:capa,prod:production,rate:rate,diff:diff,stopTime:stopTime,stopQty:stopQty,cvDiff:cvDiff,conclu:conclu});
  });
  var sumDiff=sumProd-sumCapa;
  var sumCvDiff=sumDiff>0?sumDiff-sumStopQty:sumDiff+sumStopQty;
  var sumConclu=rows.length?( Math.abs(sumCvDiff)>500?(sumDiff>0?'S/T ì´ìƒ':'ê¸°ë¡ì´ìƒ'):'ì •ìƒ'):'';
  var h='<div class="hc"><table class="ht"><thead><tr>';
  h+='<th>ì„¤ë¹„</th><th>S/Tì‹¤ì œ(ì´ˆ)</th><th>Capa</th><th>ìƒì‚°ëŸ‰</th><th>ê°€ë™ìœ¨</th><th>ì°¨ì´</th><th>ì •ì§€ì‹œê°„(ë¶„)</th><th>ìˆ˜ëŸ‰í™˜ì‚°</th><th>í™˜ì‚°ì°¨ì´</th><th>ê²°ë¡ </th>';
  h+='</tr></thead><tbody>';
  var sSt=sumProd>0?(sumProd/sumCapa*100).toFixed(1)+'%':'';
  h+='<tr style="background:#1e3a5f;font-weight:700">';
  h+='<th style="color:#fcd34d;background:#1e3a5f">ìš”ì•½</th><td style="background:#1e3a5f"></td>';
  h+='<td style="color:#60a5fa">'+Math.round(sumCapa).toLocaleString()+'</td>';
  h+='<td style="color:#60a5fa">'+Math.round(sumProd).toLocaleString()+'</td>';
  h+='<td style="color:#60a5fa">'+sSt+'</td>';
  h+=(rows.length?diffCell(sumDiff):'<td></td>');
  h+='<td>'+(sumStop?Math.round(sumStop).toLocaleString():'')+'</td>';
  h+='<td>'+(sumStopQty?Math.round(sumStopQty).toLocaleString():'')+'</td>';
  h+=(rows.length?diffCell(sumCvDiff):'<td></td>');h+=concluCell(sumConclu);h+='</tr>';
  var lastLine='';
  rows.forEach(function(r){
    var curLine=r.eq[0];
    if(curLine!==lastLine){
      var lc={K:'#f59e0b',H:'#22c55e',G:'#06b6d4'};
      h+='<tr><th colspan="10" style="background:'+lc[curLine]+'22;color:'+lc[curLine]+';text-align:left;padding:4px 8px;font-size:11px">'+curLine+' Line</th></tr>';
      lastLine=curLine;
    }
    h+='<tr><th style="color:#93c5fd">'+r.eq+'</th>';
    h+='<td>'+r.stA.toFixed(3)+'</td><td>'+Math.round(r.capa).toLocaleString()+'</td>';
    h+='<td>'+(r.prod>0?Math.round(r.prod).toLocaleString():'<span style="color:#4b5563">0</span>')+'</td>';
    h+='<td>'+(r.rate>0?(r.rate*100).toFixed(1)+'%':'')+'</td>';
    h+=diffCell(r.diff);
    h+='<td>'+(r.stopTime>0?Math.round(r.stopTime).toLocaleString():'')+'</td>';
    h+='<td>'+(r.stopQty>0?Math.round(r.stopQty).toLocaleString():'')+'</td>';
    h+=diffCell(r.cvDiff);h+=concluCell(r.conclu);h+='</tr>';
  });
  h+='</tbody></table></div>';
  return h;
}

function buildSTAnalysisPage(key,viewType){
  viewType=viewType||'daily';
  if(!D||!D.stDates)return'<div style="padding:20px;color:#94a3b8">ë°ì´í„° ì—†ìŒ</div>';
  var btnStyle='padding:7px 16px;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;border:1px solid #2a2a2a;touch-action:manipulation';
  var onStyle=';background:#3b82f6;color:#fff;border-color:#3b82f6';
  var offStyle=';background:#1a1a1a;color:#94a3b8';
  var h='<div class="bx"><h3>â± ì‹œê°„ëŒ€ë¹„ë¶„æ</h3>';
  // ë””ë²„ê·¸ íŒ¨ë„
  var dbg=D._dbg||{};
  var dbgColor=dbg.rows>0?'#166534':'#7f1d1d';
  var dbgBg=dbg.rows>0?'#052e16':'#2d0d0d';
  h+='<details style="margin-bottom:10px"><summary style="cursor:pointer;font-size:11px;color:#94a3b8">ğŸ” ë°ì´í„° ì§„ë‹¨ (í´ë¦­í•´ì„œ í¼ì¹˜ê¸°)</summary>';
  h+='<div style="background:'+dbgBg+';border:1px solid '+dbgColor+';border-radius:6px;padding:8px;font-size:11px;font-family:monospace;color:#d1fae5;margin-top:4px;word-break:break-all">';
  h+='ì „ì²´ ì‹œíŠ¸: ['+((dbg.sheets||[]).join(', '))+']<br>';
  h+='ë§¤ì¹­ëœ æ—¥æŠ¥ ì‹œíŠ¸: ['+((dbg.matchedSheets||[]).join(', '))+']<br>';
  h+='ì²˜ë¦¬ëœ í–‰ìˆ˜: <b>'+( dbg.rows||0)+'</b> | ë‚ ì§œìˆ˜: <b>'+(dbg.dates||0)+'</b> | ì£¼ì°¨ìˆ˜: <b>'+(dbg.weeks||0)+'</b><br>';
  h+='ìƒì‚°ì„¤ë¹„: ['+(dbg.eqs||[]).join(', ')+']';
  h+='</div></details>';
  // ë°ì´í„° í˜„í™© ìš”ì•½
  var totalDays=D.stDates?D.stDates.length:0;
  var totalWeeks=D.weekList?D.weekList.length:0;
  var totalEqs=Object.keys(D.prodTotalEq||{}).filter(function(e){return(D.prodTotalEq[e]||0)>0}).length;
  h+='<div style="font-size:11px;color:#64748b;margin-bottom:10px">ë°ì´í„°: <span style="color:#60a5fa">'+totalDays+'ì¼</span> | <span style="color:#a78bfa">'+totalWeeks+'ì£¼ì°¨</span> | <span style="color:#34d399">ì„¤ë¹„ '+totalEqs+'ëŒ€</span></div>';
  // ë·° ì„ íƒ ë²„íŠ¼
  h+='<div style="display:flex;gap:6px;margin-bottom:12px">';
  h+='<button style="'+btnStyle+(viewType==='daily'?onStyle:offStyle)+'" onclick="renderSTAnalysis(\''+(D.stDates.length?D.stDates[D.stDates.length-1]:'')+'\',\'daily\')">ì¼ìë³„</button>';
  h+='<button style="'+btnStyle+(viewType==='weekly'?onStyle:offStyle)+'" onclick="renderSTAnalysis(\''+(D.weekList&&D.weekList.length?D.weekList[D.weekList.length-1]:'')+'\',\'weekly\')">ì£¼ì°¨ë³„</button>';
  h+='<button style="'+btnStyle+(viewType==='cumul'?onStyle:offStyle)+'" onclick="renderSTAnalysis(\'\',\'cumul\')">ëˆ„ì </button>';
  h+='</div>';
  var prod,stop,getCapaFn,subtitle='';
  if(viewType==='daily'){
    var selDate=key||(D.stDates.length?D.stDates[D.stDates.length-1]:'');
    h+='<div style="margin-bottom:10px"><label style="color:#94a3b8;font-size:13px">ì¼ì ì„ íƒ: </label>';
    h+='<select onchange="renderSTAnalysis(this.value,\'daily\')" style="background:#1a1a1a;color:#e2e8f0;border:1px solid #3b82f6;border-radius:6px;padding:5px 10px;font-size:13px">';
    (D.stDates||[]).slice().reverse().forEach(function(d){h+='<option value="'+d+'"'+(d===selDate?' selected':'')+'>'+d+'</option>'});
    h+='</select></div>';
    prod=(D.prodByDateEq||{})[selDate]||{};
    stop=(D.stopByDateEq||{})[selDate]||{};
    getCapaFn=function(eq,stA){return 86400/stA};
    subtitle=selDate;
  } else if(viewType==='weekly'){
    var selWeek=key||(D.weekList&&D.weekList.length?D.weekList[D.weekList.length-1]:'');
    h+='<div style="margin-bottom:10px"><label style="color:#94a3b8;font-size:13px">ì£¼ì°¨ ì„ íƒ: </label>';
    h+='<select onchange="renderSTAnalysis(this.value,\'weekly\')" style="background:#1a1a1a;color:#e2e8f0;border:1px solid #3b82f6;border-radius:6px;padding:5px 10px;font-size:13px">';
    (D.weekList||[]).slice().reverse().forEach(function(w){h+='<option value="'+w+'"'+(w===selWeek?' selected':'')+'>'+w+'ì£¼ì°¨</option>'});
    h+='</select></div>';
    prod=(D.prodByWeekEq||{})[selWeek]||{};
    stop=(D.stopByWeekEq||{})[selWeek]||{};
    getCapaFn=function(eq,stA){var wd=D.eqWeekDates&&D.eqWeekDates[selWeek]&&D.eqWeekDates[selWeek][eq]?Object.keys(D.eqWeekDates[selWeek][eq]).length:0;return wd*86400/stA};
    subtitle=selWeek+'ì£¼ì°¨';
  } else {
    prod=D.prodTotalEq||{};
    stop=D.stopTotalEq||{};
    getCapaFn=function(eq,stA){var n=D.eqDates&&D.eqDates[eq]?Object.keys(D.eqDates[eq]).length:0;return n*86400/stA};
    subtitle='ì „ì²´ ëˆ„ì ';
  }
  if(!D.stDates.length){
    h+='<div style="padding:30px;text-align:center;color:#94a3b8">âš  ìƒì‚° ë°ì´í„° ì—†ìŒ â€” æ—¥æŠ¥ ì‹œíŠ¸ê°€ ìˆëŠ” íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</div></div>';
    return h;
  }
  h+='<div style="font-size:12px;color:#94a3b8;margin-bottom:8px">ê¸°ì¤€: <strong style="color:#e2e8f0">'+subtitle+'</strong></div>';
  h+=buildSTTable(prod,stop,getCapaFn);
  h+='<div style="margin-top:8px;font-size:11px;color:#94a3b8">S/Tì‹¤ì œ: K07/K08/G=STÃ·2, K09~K12=STÃ·4, K13/K14=1.85ì´ˆ, H=3.75ì´ˆ | í™˜ì‚°ì°¨ì´: ì°¨ì´Â±ìˆ˜ëŸ‰í™˜ì‚° | ê²°ë¡ : |í™˜ì‚°ì°¨ì´|>500 â†’ ì´ìƒ</div>';
  h+='</div>';
  return h;
}

function renderSTAnalysis(key,viewType){
  var panel=document.getElementById('stAnalysisPanel');
  if(panel)panel.innerHTML=buildSTAnalysisPage(key,viewType||'daily');
}

function clearData(){
  localStorage.removeItem('dashData');localStorage.removeItem('dashFile');
  D=null;charts.forEach(function(c){try{c.destroy()}catch(e){}});charts=[];
  document.getElementById('tabArea').style.display='none';document.getElementById('tabArea').innerHTML='';
  document.getElementById('root').innerHTML='<div class="welcome"><div class="arrow">ğŸ‘†</div><h2>íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”</h2><p>ğŸ“‚ ìœ„ ë²„íŠ¼ì„ ëˆŒëŸ¬ ì—‘ì…€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</p></div>';
  document.getElementById('fileName').textContent='íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”';
  document.getElementById('fileStatus').textContent='ëŒ€ê¸°ì¤‘';document.getElementById('fileStatus').style.color='#94a3b8';
  document.getElementById('clearBtn').style.display='none';
  document.getElementById('info').textContent='ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ë¶„ì„ì´ ì‹œì‘ë©ë‹ˆë‹¤';
}

(function(){
  try{
    var saved=localStorage.getItem('dashData');
    if(saved){
      var parsed=JSON.parse(saved);
      // ë²„ì „ì´ ë‹¤ë¥´ë©´ ìºì‹œ ì‚­ì œ í›„ ì¬ì—…ë¡œë“œ ìš”ì²­
      if(parsed.dataVersion!==DATA_VERSION){
        localStorage.removeItem('dashData');localStorage.removeItem('dashFile');
        document.getElementById('root').innerHTML='<div class="welcome"><div class="arrow">ğŸ‘†</div><h2>ì—…ë°ì´íŠ¸ë¨ â€” íŒŒì¼ì„ ë‹¤ì‹œ ì—…ë¡œë“œí•´ ì£¼ì„¸ìš”</h2><p style="color:#f59e0b">ëŒ€ì‹œë³´ë“œê°€ ì—…ë°ì´íŠ¸(v'+DATA_VERSION+')ë˜ì–´ íŒŒì¼ì„ ë‹¤ì‹œ ë¶ˆëŸ¬ì™€ì•¼ í•©ë‹ˆë‹¤.</p></div>';
      } else {
        D=parsed;
        var fn=localStorage.getItem('dashFile')||'ì €ì¥ëœ ë°ì´í„°';
        document.getElementById('tabArea').style.display='';
        renderAll();
        document.getElementById('fileName').textContent='í˜„ì¬: '+fn;
        document.getElementById('fileStatus').textContent='âœ“ ì €ì¥ë¨ ('+D.totalRec.toLocaleString()+'ê±´)';
        document.getElementById('fileStatus').style.color='#22c55e';
        document.getElementById('clearBtn').style.display='';
      }
    }
  }catch(e){localStorage.removeItem('dashData')}
})();
</script>
</body>
</html>
